/*
 * This file is subject to the terms and conditions outlined in the file 'LICENSE' (hint: it's MIT); this file is located in the root directory near the README.md which you should also read.
 *
 * This file is part of the 'Adama' project which is a programming language and document store for board games; however, it can be so much more.
 *
 * See https://www.adama-platform.com/ for more information.
 *
 * (c) 2020 - 2022 by Jeffrey M. Barber ( http://jeffrey.io )
 */
package org.adamalang.web.service;

import java.util.Base64;

public class JavaScriptRxHtml {
  public static final byte[] RXHTML_JS_BYTES = Base64.getDecoder().decode("ZnVuY3Rpb24gQWRhbWFUcmVlU2ltcGxlKCkgew0KICB2YXIgaWQgPSAwOw0KDQogIHZhciByb290ID0ge307DQogIHZhciBhbGxfc3Vic2NyaXB0aW9ucyA9IHt9Ow0KDQogIHZhciBjbG9uZV9vYmplY3QgPSBmdW5jdGlvbihvYmopIHsNCiAgICBpZiAoQXJyYXkuaXNBcnJheShvYmopKSB7DQogICAgICB2YXIgbmV4dCA9IFtdOw0KICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCBvYmoubGVuZ3RoOyBrKyspIHsNCiAgICAgICAgbmV4dC5wdXNoKGNsb25lX29iamVjdChvYmpba10pKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiBuZXh0Ow0KICAgIH0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT0gJ29iamVjdCcpIHsNCiAgICAgIHZhciBuZXh0ID0ge307DQogICAgICBmb3IgKGtleSBpbiBvYmopIHsNCiAgICAgICAgaWYgKGtleVswXSA9PSAnIycgfHwga2V5ID09ICJfX2tleSIgfHwga2V5ID09ICJAbyIpIGNvbnRpbnVlOw0KICAgICAgICBuZXh0W2tleV0gPSBjbG9uZV9vYmplY3Qob2JqW2tleV0pOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIG5leHQ7DQogICAgfSBlbHNlIHsNCiAgICAgIHJldHVybiBvYmo7DQogICAgfQ0KICB9Ow0KDQogIHRoaXMubnVrZSA9IGZ1bmN0aW9uKCkgew0KICAgIHRoaXMuYWxsX3N1YnNjcmlwdGlvbnMgPSB7fTsgICAgDQogIH0NCg0KICB0aGlzLmNvcHkgPSBmdW5jdGlvbigpIHsNCiAgICByZXR1cm4gY2xvbmVfb2JqZWN0KHJvb3QpOw0KICB9DQoNCiAgdGhpcy5zdHIgPSBmdW5jdGlvbigpIHsNCiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkocm9vdCk7DQogIH07DQoNCiAgLy8gZmlsdGVyIHRoZSBzdWJzY3JpcHRpb25zIHRvIHRoZSBvbmVzIHRoYXQgaGF2ZSB0aGUga2V5DQogIHZhciBzdWIgPSBmdW5jdGlvbihzLCBrZXkpIHsNCiAgICAvLyBpZiB3ZSBoYXZlIG5vdGhpbmcsIHRoZW4gd2UgcmV0dXJuIG5vdGhpbmcNCiAgICBpZiAocy5sZW5ndGggPT0gMCkgew0KICAgICAgcmV0dXJuIHM7DQogICAgfQ0KICAgIC8vIG1ha2UgYSBuZXcgYXJyYXkNCiAgICB2YXIgbiA9IFtdOw0KICAgIGZvciAodmFyIGsgPSAwOyBrIDwgcy5sZW5ndGg7IGsrKykgeyAvLyBzdWNoIHRoYXQgZXZlcnkgZWxlbWVudA0KICAgICAgaWYgKGtleSBpbiBzW2tdKSB7IC8vIHdoaWNoIGNvbnRhaW5zIHRoZSBrZXkNCiAgICAgICAgbi5wdXNoKHNba11ba2V5XSk7IC8vIGlzIGFkZGVkIHRvIHRoZSBuZXcgYXJyYXkNCiAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIG47DQogIH07DQoNCiAgLy8gZmlyZSBldmVudHMgYXQgdGhlIGN1cnJlbnQgc3Vic2NyaXB0aW9uDQogIHZhciBmaXJlID0gZnVuY3Rpb24ocywgdmFsdWUpIHsNCiAgICAvLyBmb3IgZWFjaCBzdWJzY3JpcHRpb24NCiAgICBmb3IgKHZhciBqID0gMDsgaiA8IHMubGVuZ3RoOyBqKyspIHsNCiAgICAgIHZhciB2ID0gc1tqXTsNCiAgICAgIC8vIGlmIGl0IGhhcyBldmVudHMNCiAgICAgIGlmICgnQGUnIGluIHYpIHsNCiAgICAgICAgLy8gZmlyZSBlYWNoIGV2ZW50DQogICAgICAgIHZhciBldnRzID0gdlsnQGUnXTsNCiAgICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCBldnRzLmxlbmd0aDsgaysrKSB7DQogICAgICAgICAgZXZ0c1trXSh2YWx1ZSk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQogIH07DQogIA0KICB2YXIgd2VhdmUgPSBmdW5jdGlvbihzLCBjYWxsYmFjaywga2V5KSB7DQogICAgaWYgKEFycmF5LmlzQXJyYXkoY2FsbGJhY2spKSB7DQogICAgICBmb3IgKHZhciBrID0gMDsgayA8IGNhbGxiYWNrLmxlbmd0aDsgaysrKSB7DQogICAgICAgIHdlYXZlKHMsIGNhbGxiYWNrW2tdLCBrZXkpOw0KICAgICAgfQ0KICAgIH0gZWxzZSBpZiAodHlwZW9mIChjYWxsYmFjaykgPT0gJ2Z1bmN0aW9uJykgew0KICAgICAgaWYgKCEoa2V5IGluIHMpKSB7DQogICAgICAgIHNba2V5XSA9IHt9Ow0KICAgICAgfQ0KICAgICAgdmFyIHNrID0gc1trZXldOw0KICAgICAgaWYgKCEoJ0BlJyBpbiBzaykpIHsNCiAgICAgICAgc2tbJ0BlJ10gPSBbY2FsbGJhY2tdOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgc2tbJ0BlJ10ucHVzaChjYWxsYmFjayk7DQogICAgICB9DQogICAgfSBlbHNlIGlmICh0eXBlb2YoY2FsbGJhY2spID09ICdvYmplY3QnKSB7DQogICAgICBpZiAoIShrZXkgaW4gcykpIHsNCiAgICAgICAgc1trZXldID0ge307DQogICAgICB9DQogICAgICB2YXIgc2sgPSBzW2tleV07DQogICAgICBmb3IgKHZhciBjayBpbiBjYWxsYmFjaykgew0KICAgICAgICBpZiAoY2sgPT0gJ0BlJykgew0KICAgICAgICAgIHdlYXZlKHMsIGNhbGxiYWNrW2NrXSwga2V5KTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICB3ZWF2ZShzaywgY2FsbGJhY2tbY2tdLCBjayk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQogIH07DQoNCiAgLy8gd2UgaGF2ZSBkZXRlY3RlZCBhbiBhZGRpdGlvbg0KICB2YXIgZmlyZV9hZGQgPSBmdW5jdGlvbihzLCBrZXkpIHsNCiAgICBmb3IgKHZhciBqID0gMDsgaiA8IHMubGVuZ3RoOyBqKyspIHsgLy8gZm9yIGVhY2ggc3Vic2NyaXB0aW9uDQogICAgICB2YXIgdiA9IHNbal07DQogICAgICBpZiAoJysnIGluIHYpIHsgLy8gaWYgdGhlIHN1YnNjcmlwdGlvbiBoYXMgdGhlIGFiaWxpdHkgdG8gYWRkIG5ldyBvYmplY3RzDQogICAgICAgIHZhciB2YSA9IHZbJysnXTsNCiAgICAgICAgaWYgKCdAZScgaW4gdmEpIHsgLy8gaWYgYXJlIGV2ZW50cyBhc3NvY2lhdGVkIHRvICcrJw0KICAgICAgICAgIHZhciBldmEgPSB2YVsnQGUnXTsNCiAgICAgICAgICBmb3IgKHZhciBrID0gMDsgayA8IGV2YS5sZW5ndGg7IGsrKykgeyAvLyBmb3IgZWFjaCAnKycgYWJpbGl0eQ0KICAgICAgICAgICAgd2VhdmUodiwgZXZhW2tdKGtleSksIGtleSk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICB9DQoNCiAgLy8gZmlyZSBhIGRlbGV0ZSBtZXNzYWdlIGZvciB0aGUgZ2l2ZW4ga2V5DQogIHZhciBmaXJlX2RlbCA9IGZ1bmN0aW9uKHMsIGtleSkgew0KICAgIGZvciAodmFyIGogPSAwOyBqIDwgcy5sZW5ndGg7IGorKykgeyAvLyBmb3IgZWFjaCBzdWJzY3JpcHRpb24NCiAgICAgIHZhciB2ID0gc1tqXTsNCiAgICAgIGlmICgnLScgaW4gdikgeyAvLyBpZiB0aGUgc3Vic2NyaXB0aW9uIGhhcyB0aGUgYWJpbGl0eSB0byBkZWxldGUgcHJpb3Iga2V5cw0KICAgICAgICB2YXIgdmEgPSB2WyctJ107DQogICAgICAgIGlmICgnQGUnIGluIHZhKSB7IC8vIGlmIGFyZSBldmVudHMgYXNzb2NpYXRlZCB0byAnLScNCiAgICAgICAgICB2YXIgZXZhID0gdmFbJ0BlJ107DQogICAgICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCBldmEubGVuZ3RoOyBrKyspIHsgLy8gZm9yIGVhY2ggJy0nIGFiaWxpdHkNCiAgICAgICAgICAgIGV2YVtrXShrZXkpOyAvLyBldmFsdWF0ZSB0aGUgJy0nDQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICB9DQoNCiAgLy8gYSBkZWxldGUgb2YgYSB0cmVlIGhhcyBiZWVuIGRldGVjdGVkLCBsZXQncyANCiAgdmFyIGRlbCA9IGZ1bmN0aW9uKHMpIHsNCiAgICAvLyBpZiB0aGUgc3Vic2NyaXB0aW9ucyBpcyBhbiBhcnJheSwgdGhlbiBkZWxldGUgYWxsIGNoaWxkcmVuDQogICAgaWYgKEFycmF5LmlzQXJyYXkocykpIHsNCiAgICAgIHZhciBuID0gcy5sZW5ndGg7DQogICAgICBmb3IgKHZhciBrID0gMDsgayA8IG47IGsrKykgew0KICAgICAgICBkZWwoc1trXSk7DQogICAgICB9DQogICAgfSBlbHNlIGlmICh0eXBlb2YocykgPT0gJ29iamVjdCcpIHsgLy8gb3RoZXJ3aXNlLCBpdGVyYXRlIG92ZXIgdGhlIGtleXMNCiAgICAgIGZvciAodmFyIGtleSBpbiBzKSB7DQogICAgICAgIHZhciBjaCA9IHNba2V5XTsNCiAgICAgICAgaWYgKGtleSA9PSAnQGUnKSB7IC8vIHdlIGhhdmUgZXZlbnRzLCBzbyBsZXQncyBzZW5kIHRob3NlIGV2ZW50cy4uLg0KICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgY2gubGVuZ3RoOyBqKyspIHsNCiAgICAgICAgICAgIGNoW2pdKG51bGwpOyAvLyBhIG51bGwgdG8gaW5kaWNhdGUgZGVsZXRpb24NCiAgICAgICAgICB9DQogICAgICAgIH0gZWxzZSB7IC8vIHJlY3Vyc2UgaW50byB0aGUgY2hpbGQgZmllbGQNCiAgICAgICAgICBkZWwoY2gpOw0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICB9Ow0KDQogIC8vIGRlbGV0ZSB0aGUgZ2l2ZW4ga2V5IHdpdGhpbiB0aGUgc3Vic2NyaXB0aW9uDQogIHZhciBkZWxfa2V5ID0gZnVuY3Rpb24ocywga2V5KSB7DQogICAgaWYgKEFycmF5LmlzQXJyYXkocykpIHsgLy8gaWYgd2UgaGF2ZSBhbiBhcnJheSBvZiBzdWJzY3JpcHRpb25zLCB0aGVuIHNpbXBseSByZXBlYXQNCiAgICAgIHZhciBuID0gcy5sZW5ndGg7DQogICAgICBmb3IgKHZhciBrID0gMDsgayA8IG47IGsrKykgew0KICAgICAgICBkZWxfa2V5KHNba10sIGtleSk7IC8vIGZvciBlYWNoIGVsZW1lbnQNCiAgICAgIH0NCiAgICB9IGVsc2UgaWYgKHR5cGVvZihzKSA9PSAnb2JqZWN0JykgeyAvLyBvdGhlcndpc2UsIHdlIGhhdmUgYSBzdWJjcmlwdGlvbiBjYWxsYmFjaw0KICAgICAgaWYgKGtleSBpbiBzKSB7IC8vIGlmIHRoZSBrZXkgaXMgaW4gdGhlIHN1YnNjcmlwdGlvbiBjYWxsYmFjaw0KICAgICAgICBkZWxldGUgc1trZXldOyAvLyBkZWxldGUgaXQNCiAgICAgIH0NCiAgICB9DQogIH07DQoNCiAgLy8gbWVyZ2UgdGhlIGdpdmVuIGRlbHRhIGludG8gdGhlIHRyZWUgYW5kIGZpcmUgc3Vic2NyaXB0aW9ucyAocykNCiAgdmFyIG1lcmdlID0gZnVuY3Rpb24odHJlZSwgZGVsdGEsIHMpIHsNCiAgICBmb3IgKHZhciBrZXkgaW4gZGVsdGEpIHsgLy8gZm9yIGVhY2ggYml0IG9mIGRhdGEgd2l0aGluIHRoZSB0cmVlDQogICAgICB2YXIgZUtleSA9ICcjJyArIGtleTsgLy8gY29tcHV0ZSB0aGUgc2VjcmV0IGRhdGEgcGF0aA0KICAgICAgdmFyIHByaW9yID0gdHJlZVtrZXldOyAvLyBmaW5kIHRoZSBwcmlvciBzdGF0ZSB3aXRoaW4gdGhlIHRyZWUNCiAgICAgIHZhciBuZXh0ID0gZGVsdGFba2V5XTsgLy8gYnJpbmcgdGhlIGNoYW5nZSBwcmVzZW50IGZvciB0aGUgY3VycmVudCBrZXkNCiAgICAgIGlmIChuZXh0ID09IG51bGwpIHsgLy8gdGhlIGl0ZW0gaXMgZ29pbmcgcG9vZg0KICAgICAgICAvLyB0aGUgcHJpb3IgdmFsdWUgaXMgYW4gYXJyYXksIHNvIHdlIG1heSBoYXZlIHNvbWUgc3BlY2lhbCB0aGluZ3MgYXNzb2NpYXRlIHdpdGggaXQNCiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkocHJpb3IpKSB7IC8vIFVOVEVTVA0KICAgICAgICAgIGlmIChlS2V5IGluIHRyZWUpIHsNCiAgICAgICAgICAgIGRlbChzdWIocywgZUtleSkpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBkZWxldGUgdHJlZVtlS2V5XTsNCiAgICAgICAgfQ0KICAgICAgICBkZWwoc3ViKHMsIGtleSkpOyAvLyBpc3N1ZSBhIGRlbGV0ZSBmb3IgYWxsIHRoZSBzdWJzY3JpcHRpb25zIGZvciB0aGUga2lkDQogICAgICAgIGRlbGV0ZSB0cmVlW2tleV07IC8vIGRlbGV0ZSB0aGUgZGF0YSBpbiB0aGUgdHJlZQ0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgaWYgKHR5cGVvZihuZXh0KSA9PSAnb2JqZWN0JyAmJiAhQXJyYXkuaXNBcnJheShuZXh0KSkgeyAvLyBpZiB0aGUgZGVsdGEgaXMgYW4gb2JqZWN0DQogICAgICAgICAgdmFyIGFyciA9IEFycmF5LmlzQXJyYXkocHJpb3IpIHx8ICdAbycgaW4gbmV4dCB8fCAnQHMnIGluIG5leHQ7IC8vIGRldGVjdCBpZiB3ZSBuZWVkIHRvIHVzZSBhcnJheSBsb2dpYw0KICAgICAgICAgIGlmIChhcnIpIHsgLy8gd2UgaGF2ZSBkZXRlY3RlZCBhbiBhcnJheQ0KICAgICAgICAgICAgaWYgKCEoa2V5IGluIHRyZWUpKSB7IC8vIGxldCdzIG1ha2Ugc3VyZSB0aGUgdHJlZSBoYXMgYW4gZW1wdHkgYXJyYXkNCiAgICAgICAgICAgICAgdHJlZVtrZXldID0gW107DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoIShlS2V5IGluIHRyZWUpKSB7IC8vIGxldCdzIG1ha2Ugc3VyZSB0aGUgc2VjcmV0IGRhdGEgZXhpc3RzIGFzIHdlbGwNCiAgICAgICAgICAgICAgdHJlZVtlS2V5XSA9IHt9Ow0KICAgICAgICAgICAgICBpZiAoJ0BvJyBpbiBuZXh0KSB7IC8vIGlmIHdlIGhhdmUgYSBidW5jaCBvZiBrZXlzLCB0aGVuIGxldCdzIG1ha2Ugc3VyZSB0byBwcmVzZXJ2ZSB0aGF0IGZvciBtYWtlX2RlbHRhDQogICAgICAgICAgICAgICAgdHJlZVtlS2V5XVsnQG8nXSA9IHRydWU7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgdHJlZVtlS2V5XS5fX2tleSA9IGtleTsgLy8gYW5ub3RhdGUgdGhlIG5ldyBpdGVtIHdpdGggdGhlIGdpdmVuIGtleQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgdmFyIGVCYXNlID0gdHJlZVtlS2V5XTsgLy8gZ2V0IHRoZSBzZWNyZXQgKGFuZCByZWFsKSBkYXRhIGZvciB0aGUgb2JqZWN0IGluIHF1ZXN0aW9uDQogICAgICAgICAgICB2YXIgZVN1YiA9IHN1YihzLCBrZXkpOyAvLyBzY29wZSB0aGUgc3Vic2NyaXB0aW9uIHRvIHRoZSBrZXkNCiAgICAgICAgICAgIHZhciBvcmRlcmluZyA9IG51bGw7IC8vIGRldGVjdGlvbiBvZiBpZiB3ZSBoYXZlIEBvIG9yZGVyaW5nIHRvIHJlb3JkZXIgdGhlIHZhbHVlcw0KICAgICAgICAgICAgdmFyIHJlc2l6ZSA9IG51bGw7IC8vIGRldGVjdGlvbiBvZiBhbiBhcnJheSB3aXRob3V0IF9fa2V5DQogICAgICAgICAgICB2YXIgZGVsYXkgPSB7fTsgLy8gd2UgZGVsYXkgYWxsIGV2ZW50cyBzdWNoIHRoYXQgdGhlIGFycmF5IGNhbiBiZSBidWlsdCBmb3IgaW5saW5lIG1ha2VfZGVsdGEgY2FsbHMgdG8gd29yaw0KICAgICAgICAgICAgZm9yICh2YXIgYUtleSBpbiBuZXh0KSB7IC8vIGZvciBlYWNoIGZpZWxkIHdpdGhpbiB0aGUgZGlmZmVyZW5jZQ0KICAgICAgICAgICAgICB2YXIgdmFsID0gbmV4dFthS2V5XTsNCiAgICAgICAgICAgICAgaWYgKGFLZXkgPT0gJ0BvJykgeyAvLyB0aGUgdmFsdWUgaXMgYSBuZXcgb3JkZXJpbmcgb2YgdGhlIGFycmF5DQogICAgICAgICAgICAgICAgb3JkZXJpbmcgPSB2YWw7DQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoYUtleSA9PSAnQHMnKSB7IC8vIHRoZSB2YWx1ZSBpcyBhIHJlc2l6ZSBvZiB0aGUgYXJyYXkNCiAgICAgICAgICAgICAgICByZXNpemUgPSB2YWw7DQogICAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsID09IG51bGwpIHsgLy8gZGVsZXRlIHRoZSBlbGVtZW50DQogICAgICAgICAgICAgICAgaWYgKGFLZXkgaW4gZUJhc2UpIHsgLy8gaWYgaXQgZXhpc3RzIHdpdGhpbiB0aGUgc2VjcmV0IGtleQ0KICAgICAgICAgICAgICAgICAgZGVsYXlbYUtleV0gPSBmdW5jdGlvbih4KSB7DQogICAgICAgICAgICAgICAgICAgIGRlbChzdWIoZVN1YiwgeCkpOyAvLyBpc3N1ZSBkZWxldGVzDQogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBlQmFzZVt4XTsgLy8gZGVsZXRlIHRoZSB2YWx1ZQ0KICAgICAgICAgICAgICAgICAgICBkZWxfa2V5KGVTdWIsIHgpOyAvLyBkZWxldGUgdGhlIGtleXMgZnJvbSB0aGUgb2JqZWN0DQogICAgICAgICAgICAgICAgICAgIGZpcmVfZGVsKGVTdWIsIHgpOw0KICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIH0gZWxzZSB7IC8vIHdlIGhhdmUgZGF0YQ0KICAgICAgICAgICAgICAgIGlmICghKGFLZXkgaW4gZUJhc2UpKSB7IC8vIHRoZSBkYXRhIGRpZG4ndCBleGlzdCwgc28gZmlyZSBhbiBhZGRpdGlvbiB0byBleHRlbmQgdGhlIHN1YnNjcmlwdGlvbnMNCiAgICAgICAgICAgICAgICAgIGZpcmVfYWRkKGVTdWIsIGFLZXkpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB2YXIgblZhbCA9IG5leHRbYUtleV07IC8vIGdldCB0aGUgbmV3IHZhbHVlDQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZihuVmFsKSA9PSAnb2JqZWN0JykgeyAvLyBpZiB0aGUgbmV3IHZhbHVlIGlzIGFuIG9iamVjdA0KICAgICAgICAgICAgICAgICAgaWYgKCEoYUtleSBpbiBlQmFzZSkpIHsgLy8gdGhlbiBtYWtlIHN1cmUgdGhlIG5ldyBpdGVtIGlzIHdpdGhpbiB0aGUgc2VjcmV0IHRyZWUNCiAgICAgICAgICAgICAgICAgICAgZUJhc2VbYUtleV0gPSB7fTsNCiAgICAgICAgICAgICAgICAgICAgZUJhc2VbYUtleV0uX19rZXkgPSBhS2V5Ow0KICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgZGVsYXlbYUtleV0gPSBmdW5jdGlvbih4KSB7DQogICAgICAgICAgICAgICAgICAgIG1lcmdlKGVCYXNlW3hdLCBuZXh0W3hdLCBzdWIoZVN1YiwgeCkpOyAvLyByZWN1cnNlOiBtZXJnZSB0aGUgZGlmZmVyZW5jZSBpbnRvIHRoZSBzZWNyZXQgdHJlZSBhbmQgcHVibGlzaCB0byBhbGwgZWxlbWVudCBzdWJzY3JpcHRpb25zDQogICAgICAgICAgICAgICAgICAgIGZpcmUoc3ViKGVTdWIsIHgpLCBlQmFzZVt4XSk7DQogICAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8vIG90aGVyd2lzZSwgc2V0IHRoZSB2YWx1ZSBpbnRvIHRoZSB0cmVlDQogICAgICAgICAgICAgICAgICBlQmFzZVthS2V5XSA9IG5WYWw7DQogICAgICAgICAgICAgICAgICBkZWxheVthS2V5XSA9IGZ1bmN0aW9uKHgpIHsNCiAgICAgICAgICAgICAgICAgICAgZmlyZShzdWIoZVN1YiwgeCksIGVCYXNlW3hdKTsNCiAgICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIC8vIGFuZCB0ZWxsIGV2ZXJ5b25lIHRoZSBuZXcgdmFsdWUgZm9yIHRoaXMgDQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHZhciBiZWZvcmUgPSB0cmVlW2tleV07IC8vIHN0YXNoIGEgcG9pbnRlciB0byB0aGUgYXJyYXkNCiAgICAgICAgICAgIHZhciBkZWxheU9yZGVyID0gW107DQoNCiAgICAgICAgICAgIGlmIChvcmRlcmluZyAhPSBudWxsKSB7IC8vIGFuIG9yZGVyaW5nIGNoYW5nZSBpcyBoYXBwZW5pbmcNCiAgICAgICAgICAgICAgdmFyIGFmdGVyID0gW107IC8vIHdlIHdpbGwgcmVidWlsZCB0aGUgYXJyYXkgaGVyZQ0KICAgICAgICAgICAgICB2YXIgbXNnID0gW107IC8vIGFuZCByZWNvcmQgdGhlIGtleXMgaGVyZQ0KICAgICAgICAgICAgICBmb3IgKHZhciBrID0gMDsgayA8IG9yZGVyaW5nLmxlbmd0aDsgaysrKSB7IC8vIGZvciBlYWNoIG9yZGVyaW5nIGluc3RydWN0aW9uDQogICAgICAgICAgICAgICAgdmFyIGluc3RyID0gb3JkZXJpbmdba107DQogICAgICAgICAgICAgICAgdmFyIHR5cGVfaW5zdHIgPSB0eXBlb2YgKGluc3RyKTsNCiAgICAgICAgICAgICAgICBpZiAodHlwZV9pbnN0ciA9PSAic3RyaW5nIiB8fCB0eXBlX2luc3RyID09ICJudW1iZXIiKSB7IC8vIGlmIHRoZSBpbnN0cnVjdGlvbiByZWZlcnMgdG8gYW4gaXRlbQ0KICAgICAgICAgICAgICAgICAgYWZ0ZXIucHVzaChlQmFzZVtpbnN0cl0pOyAvLyBwdXNoIHRoZSBpdGVtIGludG8gdGhlIG5ldyBhcnJheQ0KICAgICAgICAgICAgICAgICAgbXNnLnB1c2goIiIgKyBpbnN0cik7IC8vIHJlY29yZCB0aGUga2V5IG9mIHRoZSBpdGVtDQogICAgICAgICAgICAgICAgfSBlbHNlIHsgLy8gb3RoZXJ3aXNlLCB0aGUgaW5zdHJ1Y3Rpb24gaXMgYSByYW5nZQ0KICAgICAgICAgICAgICAgICAgdmFyIHN0YXJ0ID0gaW5zdHJbMF07DQogICAgICAgICAgICAgICAgICB2YXIgZW5kID0gaW5zdHJbMV07DQogICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gc3RhcnQ7IGogPD0gZW5kOyBqKyspIHsgLy8gaXRlcmF0ZSBvdmVyIHRoZSByYW5nZSBhbmQgY29weQ0KICAgICAgICAgICAgICAgICAgICBhZnRlci5wdXNoKGJlZm9yZVtqXSk7IC8vIHRoZSBpdGVtcyBmcm9tIHRoZSBwcmV2aW91cyBjb3B5DQogICAgICAgICAgICAgICAgICAgIG1zZy5wdXNoKGJlZm9yZVtqXS5fX2tleSk7IC8vIGFuZCBhbm5vdGF0ZSB0aGUga2V5cw0KICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICBkZWxheU9yZGVyLnB1c2goZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgZmlyZShzdWIoZVN1YiwgIn4iKSwgbXNnKTsgLy8gdGVsbCBzdWJzY3JpcHRpb25zIGFib3V0IHRoZSBuZXcgb3JkZXJpbmcNCiAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgIHRyZWVba2V5XSA9IGFmdGVyOw0KICAgICAgICAgICAgfSBlbHNlICBpZiAocmVzaXplICE9IG51bGwpIHsgLy8gYWx0ZXJuYXRpdmVseSwgYW4gYXJyYXkgd2l0aG91dCBrZXlzIGlzIGJlaW5nIHJlc2l6ZWQNCiAgICAgICAgICAgICAgdmFyIGFmdGVyID0gW107DQogICAgICAgICAgICAgIHZhciBtc2cgPSBbXTsNCiAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCByZXNpemU7IGsrKykgeyAvLyB3ZSByZWJ1aWxkIHRoZSBhcnJheQ0KICAgICAgICAgICAgICAgIGFmdGVyW2tdID0gYmVmb3JlW2tdOw0KICAgICAgICAgICAgICAgIG1zZy5wdXNoKCcnICsgayk7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgZGVsYXlPcmRlci5wdXNoKGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgIGZpcmUoc3ViKGVTdWIsICJ+IiksIG1zZyk7IC8vIHRlbGwgc3Vic2NyaXB0aW9ucyBhYm91dCB0aGUgbmV3IG9yZGVyaW5nDQogICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICB0cmVlW2tleV0gPSBhZnRlcjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGZvciAoYUtleSBpbiBkZWxheSkgew0KICAgICAgICAgICAgICBkZWxheVthS2V5XShhS2V5KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGZvciAodmFyIGsgPSAwOyBrIDwgZGVsYXlPcmRlcjsgaysrKSB7DQogICAgICAgICAgICAgIGRlbGF5T3JkZXJba10oKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGZpcmUoZVN1YiwgdHJlZVtrZXldKTsgLy8gdGVsbCBldmVyeW9uZSBhYm91dCB0aGUgbmV3IHZhbHVlDQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIGlmICghKGtleSBpbiB0cmVlKSB8fCB0eXBlb2YodHJlZVtrZXldKSAhPSAnb2JqZWN0Jykgew0KICAgICAgICAgICAgICB0cmVlW2tleV0gPSB7fTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHZhciBlID0gc3ViKHMsIGtleSk7DQogICAgICAgICAgICBtZXJnZSh0cmVlW2tleV0sIG5leHQsIGUpOw0KICAgICAgICAgICAgZmlyZShlLCB0cmVlW2tleV0pOw0KICAgICAgICAgIH0NCiAgICAgICAgfSBlbHNlIHsgLy8gbm90IGFuIG9iamVjdCwgc28gaXQgaXMgYSB2YWx1ZQ0KICAgICAgICAgIHRyZWVba2V5XSA9IG5leHQ7IC8vIHN0YXNoIHRoZSBuZXcgdmFsdWUNCiAgICAgICAgICBmaXJlKHN1YihzLCBrZXkpLCBuZXh0KTsgLy8gYW5kIHRlbGwgZXZlcnlvbmUgYWJvdXQgaXQNCiAgICAgICAgfSAgICAgICAgDQogICAgICB9DQogICAgfQ0KICAgIGZpcmUocywgdHJlZSk7DQogIH07DQoNCiAgdGhpcy51cGRhdGUgPSBmdW5jdGlvbihkZWx0YSkgew0KICAgIHZhciBmbGF0ID0gW107IC8vIGZsYXR0ZW4gdGhlIHN1YmNyaXB0aW9ucyBvYmplY3RzDQogICAgZm9yICh2YXIgayBpbiBhbGxfc3Vic2NyaXB0aW9ucykgew0KICAgICAgZmxhdC5wdXNoKGFsbF9zdWJzY3JpcHRpb25zW2tdKTsNCiAgICB9DQogICAgbWVyZ2Uocm9vdCwgZGVsdGEsIGZsYXQpOyAvLyBleGVjdXRlIHRoZSBtZXJnZSBhbmQgZmlyZSBldmVudHMNCiAgfTsNCg0KICAvLyBmaXggdGhlIGNhbGxiYWNrIHN0cnVjdHVyZSBmcm9tIHRoZSB1c2VyJ3MgaGFwcHkgbGFuZCB0byB0aGUgcmlnb3Igb2YgdGhlIGZvcm1hdCBuZWVkZWQNCiAgdmFyIHRyYW5zZm9ybV9jYWxsYmFja19pbnRvX3N1YiA9IGZ1bmN0aW9uKGNhbGxiYWNrLCBzdWIpIHsNCiAgICBpZiAoQXJyYXkuaXNBcnJheShjYWxsYmFjaykpIHsgLy8gaWYgdGhlIGNhbGxiYWNrIGlzIGFuIGFycmF5LCB0aGVuIGZsYXR0ZW4gdGhlIGFycmF5IGludG8gdGhlIG5ldyBvYmplY3QNCiAgICAgIGZvciAodmFyIGsgPSAwOyBrIDwgY2FsbGJhY2subGVuZ3RoOyBrKyspIHsNCiAgICAgICAgdHJhbnNmb3JtX2NhbGxiYWNrX2ludG9fc3ViKGNhbGxiYWNrW2tdLCBzdWIpOw0KICAgICAgfQ0KICAgIH0gZWxzZSBpZiAodHlwZW9mKGNhbGxiYWNrKSA9PSAgJ29iamVjdCcpIHsgLy8gb2gsIHRoZSBjYWxsYmFjayBpcyBhbiBvYmplY3QNCiAgICAgIGZvciAodmFyIGtleSBpbiBjYWxsYmFjaykgeyAvLyBpdGVyYXRlIG92ZXIgZWFjaCBrZXkNCiAgICAgICAgaWYgKGtleSA9PSAnQGUnKSB7IC8vIGZvcmNlIHRoZSBmdW5jdGlvbnMgdG8gbWVyZ2UgdG9nZXRoZXINCiAgICAgICAgICB0cmFuc2Zvcm1fY2FsbGJhY2tfaW50b19zdWIoY2FsbGJhY2tba2V5XSwgc3ViKTsNCiAgICAgICAgfSBlbHNlIHsgLy8gbm9ybWFsIGZsb3cNCiAgICAgICAgICBpZiAoIShrZXkgaW4gc3ViKSkgeyAvLyBkaXZlIGludG8gdGhlIG9iamVjdCBhbmQgbWFrZSBzdXJlIHRoZSBzdWJzY3JpcHRpb24gaGFzIHRoZSBmaWVsZA0KICAgICAgICAgICAgc3ViW2tleV0gPSB7fTsNCiAgICAgICAgICB9DQogICAgICAgICAgdHJhbnNmb3JtX2NhbGxiYWNrX2ludG9fc3ViKGNhbGxiYWNrW2tleV0sIHN1YltrZXldKTsgLy8gcmVjdXJzZSBhbmQgcGFpciB0aGUgZXZlbnRzIHRvIHRoZSBuZXcgc3Vic2NyaXB0aW9uDQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9IGVsc2UgaWYgKHR5cGVvZihjYWxsYmFjaykgPT0gICdmdW5jdGlvbicpIHsgLy8gaXQncyBhIGZ1bmN0aW9uDQogICAgICBpZiAoISgnQGUnIGluIHN1YikpIHsgLy8gbGV0J3MgZW5zdXJlIHRoZXJlIGlzIGFuIGV2ZW50IGxpc3QNCiAgICAgICAgc3ViWydAZSddID0gW2NhbGxiYWNrXTsNCiAgICAgIH0gZWxzZSB7IC8vIG90aGVyd2lzZSwganVzdCBhZGQgaXQNCiAgICAgICAgc3ViWydAZSddLnB1c2goY2FsbGJhY2spOw0KICAgICAgfQ0KICAgIH0NCiAgfQ0KDQogIC8vIGNvbnZlcnQgdGhlIHRyZWUgdG8gYSBkZWx0YTsgdGhpcyB0cmVlIGlzIGFzc3VtZWQgdG8gaGF2ZSBiZWVuIG1lcmdlZCBhbHJlYWR5DQogIHZhciBtYWtlX2RlbHRhID0gZnVuY3Rpb24oc3QpIHsNCiAgICB2YXIgZGVsdGEgPSB7fTsgLy8gdGhlIGRlbHRhIHRvIGNvbnN0cnVjdA0KICAgIGZvciAodmFyIGsgaW4gc3QpIHsgLy8gZm9yIGVhY2gga2V5IHdpdGhpbiB0aGUgb2JqZWN0DQogICAgICBpZiAoa1swXSA9PSAnIycgfHwgayA9PSAiQG8iIHx8IGsgPT0gIl9fa2V5IikgY29udGludWU7IC8vIHNraXAgdGhlc2UNCiAgICAgIHZhciB2ID0gc3Rba107DQogICAgICBpZiAoKCcjJyArIGspIGluIHN0KSB7IC8vIHRoZSByZXN1bHQgaXMgYW4gYXJyYXkNCiAgICAgICAgdmFyIGQgPSB7fTsNCiAgICAgICAgaWYgKCdAbycgaW4gc3RbJyMnICsga10pIHsgLy8gYW5kIHdlIGhhdmUgYSBzcGVjaWZpYyBvcmRlcmluZyB0byBtZW1vaXplDQogICAgICAgICAgdmFyIG8gPSBbXTsNCiAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHYubGVuZ3RoOyBqKyspIHsgLy8gY29weSB0aGUgZWxlbWVudHMgZnJvbSB0aGUgYXJyYXkNCiAgICAgICAgICAgIHZhciB2aiA9IHZbal07DQogICAgICAgICAgICBkW3ZqLl9fa2V5XSA9IG1ha2VfZGVsdGEodmopOyAvLyB1c2luZyB0aGUgX19rZXkgZW1iZWRkZWQgaW4gdGhlIG9iamVjdA0KICAgICAgICAgICAgby5wdXNoKHZbal0uX19rZXkpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBkWydAbyddID0gbzsNCiAgICAgICAgfSBlbHNlIHsgLy8gb3RoZXJ3aXNlOyByZWNvcmQgdGhlIHNpemUgYXMgd2UgcmVjdXJzZQ0KICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdi5sZW5ndGg7IGorKykgew0KICAgICAgICAgICAgZFsnJyArIGpdID0gbWFrZV9kZWx0YSh2W2pdKTsNCiAgICAgICAgICB9DQogICAgICAgICAgZFsnQHMnXSA9IHYubGVuZ3RoOw0KICAgICAgICB9DQogICAgICAgIGRlbHRhW2tdID0gZDsNCiAgICAgIH0gZWxzZSBpZiAodHlwZW9mKHYpID09ICdvYmplY3QnKSB7IC8vIGl0J3MganVzdCBhbiBvYmplY3QsIHNvIHJlY3Vyc2UgZGlyZWN0bHkNCiAgICAgICAgZGVsdGFba10gPSBtYWtlX2RlbHRhKHYpOw0KICAgICAgfSBlbHNlIHsgLy8gZmluYWxseSwgaXQgaXMgYSB2YWx1ZSBzbyBqdXN0IHNldCBpdA0KICAgICAgICBkZWx0YVtrXSA9IHY7DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiBkZWx0YTsNCiAgfTsNCg0KICAvLyBgc3Vic2NyaWJlYCB0aGUgZ2l2ZW4gc3RydWN0dXJhbCBjYWxsYmFjaw0KICB0aGlzLnN1YnNjcmliZSA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7DQogICAgdmFyIHN1YiA9IHt9Ow0KICAgIHRyYW5zZm9ybV9jYWxsYmFja19pbnRvX3N1YihjYWxsYmFjaywgc3ViKTsgIC8vIHRyYW5zZm9ybSB0aGUgY2FsbGJhY2sgaW50byBhIHNhZmUgY2FsbGJhY2sNCiAgICB2YXIgZGVsdGEgPSBtYWtlX2RlbHRhKHJvb3QpOw0KICAgIG1lcmdlKHt9LCBkZWx0YSwgW3N1Yl0pOyAvLyBleGVjdXRlIHRoZSBjYWxsYmFjayBub3cgb24gYSBjYWxsYmFjayBvZiBhbGwgZGF0YSB0byBmaXJlIGV2ZW50cyBhbmQgZmlsbCB0aGUgc3Vic2NyaXB0aW9uIG9iamVjdA0KICAgIHZhciBTID0gIiIgKyBpZCsrOyAvLyBjcmVhdGUgYW4gaWQgZm9yIHRoZSBzdWJzY3JpcHRpb24NCiAgICBhbGxfc3Vic2NyaXB0aW9uc1tTXSA9IHN1YjsgLy8gcmVjb3JkIHRoZSBzdWJzY3JpcHRpb24NCiAgICByZXR1cm4gZnVuY3Rpb24oKSB7IC8vIHJldHVybiBhIG1ldGhvZCB0byB1bnN1YnNjcmliZQ0KICAgICAgZGVsZXRlIGFsbF9zdWJzY3JpcHRpb25zW1NdOw0KICAgIH07DQogIH07DQp9DQoNCnZhciBSeEhUTUwgPSAoZnVuY3Rpb24gKCkgew0KICB2YXIgc2VsZiA9IHt9Ow0KDQogIHZhciB0ZW1wbGF0ZXMgPSB7fTsNCiAgdmFyIHJvdXRlciA9IHt9Ow0KICB2YXIgY29ubmVjdGlvbiA9IG5ldyBBZGFtYS5Db25uZWN0aW9uKEFkYW1hLlByb2R1Y3Rpb24pOw0KICB2YXIgY29ubmVjdGlvbnMgPSB7fTsNCg0KICBjb25uZWN0aW9uLnN0YXJ0KCk7DQoNCiAgY29uc29sZS5sb2cod2luZG93LmxvY2F0aW9uLmhvc3RuYW1lKTsNCiAgY29uc29sZS5sb2cod2luZG93LmxvY2F0aW9uLnBhdGhuYW1lKTsNCg0KICB2YXIgcm9vdFJlcGxhY2UgPSAiLyI7DQogIHZhciBmaXhQYXRoID0gZnVuY3Rpb24ocGF0aCkgeyByZXR1cm4gcGF0aDsgfTsNCiAgaWYgKHdpbmRvdy5sb2NhdGlvbi5ob3N0bmFtZS5lbmRzV2l0aCgiLmFkYW1hLXBsYXRmb3JtLmNvbSIpKSB7DQogICAgdmFyIHBhcnRzID0gd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lLnNwbGl0KCIvIik7DQogICAgcm9vdFJlcGxhY2UgPSBbcGFydHNbMF0sIHBhcnRzWzFdLCBwYXJ0c1syXSwgIiJdLmpvaW4oIi8iKTsNCiAgICB2YXIgb2Zmc2V0ID0gcGFydHNbMF0ubGVuZ3RoICsgcGFydHNbMV0ubGVuZ3RoICsgcGFydHNbMl0ubGVuZ3RoICsgMjsNCiAgICBmaXhQYXRoID0gZnVuY3Rpb24ocGF0aCkgeyByZXR1cm4gcGF0aC5zdWJzdHJpbmcob2Zmc2V0KTsgfQ0KICB9DQoNCiAgdmFyIGZpeEhyZWYgPSBmdW5jdGlvbihocmVmKSB7DQogICAgaWYgKGhyZWYuc3RhcnRzV2l0aCgnLycpKSB7DQogICAgICByZXR1cm4gcm9vdFJlcGxhY2UgKyBocmVmLnN1YnN0cmluZygxKTsNCiAgICB9DQogICAgcmV0dXJuIGhyZWY7DQogIH0NCg0KDQogIHZhciBnZXRfY29ubmVjdGlvbl9vYmogPSBmdW5jdGlvbihuYW1lKSB7DQogICAgaWYgKG5hbWUgaW4gY29ubmVjdGlvbnMpIHsNCiAgICAgIHJldHVybiBjb25uZWN0aW9uc1tuYW1lXTsNCiAgICB9IGVsc2Ugew0KICAgICAgdmFyIG9iaiA9IHsNCiAgICAgICAgbmFtZTogbmFtZSwNCiAgICAgICAgcHRyOiBudWxsLA0KICAgICAgICB0cmVlOiBuZXcgQWRhbWFUcmVlU2ltcGxlKCksDQogICAgICAgIG91dHN0YW5kaW5nOiB7fSwNCiAgICAgICAgZGVjaXNpb25zOiB7fSwNCiAgICAgICAgaWQ6MA0KICAgICAgfTsNCiAgICAgIG9iai5zdWJzY3JpYmUgPSBmdW5jdGlvbihjaGFubmVsLCBjYWxsYmFjaykgew0KICAgICAgICB2YXIgcyA9IGNoYW5uZWwgKyAifCIgKyB0aGlzLmlkKys7DQogICAgICAgIHRoaXMuZGVjaXNpb25zW3NdID0gY2FsbGJhY2s7DQogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsNCiAgICAgICAgICBkZWxldGUgdGhpcy5kZWNpc2lvbnNbc107DQogICAgICAgIH0uYmluZCh0aGlzKTsNCiAgICAgIH0uYmluZChvYmopOw0KICAgICAgb2JqLm9uZGVjaWRlID0gZnVuY3Rpb24ob3V0c3RhbmRpbmcpIHsNCiAgICAgICAgZm9yICh2YXIgY2ggaW4gb2JqLm91dHN0YW5kaW5nKSB7DQogICAgICAgICAgb2JqLm91dHN0YW5kaW5nW2NoXSA9IHtvcHRpb25zOltdfTsNCiAgICAgICAgfQ0KICAgICAgICB2YXIgbiA9IG91dHN0YW5kaW5nLmxlbmd0aDsNCiAgICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCBuOyBrKyspIHsNCiAgICAgICAgICB2YXIgbyA9IG91dHN0YW5kaW5nW2tdOw0KICAgICAgICAgIG9iai5vdXRzdGFuZGluZ1tvLmNoYW5uZWxdID0gbzsNCiAgICAgICAgfQ0KICAgICAgICBmb3IgKHZhciBjaCBpbiBvYmoub3V0c3RhbmRpbmcpIHsNCiAgICAgICAgICBmb3IgKHZhciBzdWIgaW4gb2JqLmRlY2lzaW9ucykgew0KICAgICAgICAgICAgaWYgKHN1Yi5zdGFydHNXaXRoKGNoICsgInwiKSkgew0KICAgICAgICAgICAgICBvYmouZGVjaXNpb25zW3N1Yl0oKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgIH07DQogICAgICBjb25uZWN0aW9uc1tuYW1lXSA9IG9iajsNCiAgICAgIHJldHVybiBvYmo7DQogICAgfQ0KICB9Ow0KDQogIHNlbGYubWFrZSA9IGZ1bmN0aW9uKCkgew0KICAgIHJldHVybiBuZXcgQWRhbWFUcmVlU2ltcGxlKCk7DQogIH07DQoNCiAgLy8gSEVMUEVSIHwgc3Vic2NyaWJlIHRoZSBnaXZlbiAnc3ViJyB0byBjaGFuZ2VzIHdpdGhpbiBzdGF0ZSBmb3IgdGhlIGdpdmVuIGZpZWxkIG5hbWVkIG5hbWUNCiAgdmFyIHN1YnNjcmliZSA9IGZ1bmN0aW9uKHN0YXRlLCBuYW1lLCBzdWIpIHsNCiAgICB2YXIgc3MgPSBzZWxmLnBJKHN0YXRlLCBuYW1lKTsNCiAgICB2YXIgcyA9IHNzW3NzLmN1cnJlbnRdOw0KICAgIGlmICgnQGUnIGluIHMuZGVsdGEpIHsNCiAgICAgIHMuZGVsdGFbJ0BlJ10ucHVzaChzdWIpOw0KICAgIH0gZWxzZSB7DQogICAgICBzLmRlbHRhWydAZSddID0gW3N1Yl07DQogICAgfQ0KICB9Ow0KDQogIC8vIEhFTFBFUiB8IGNyZWF0ZSBmcmVzaCBzdGF0ZQ0KICB2YXIgZnJlc2ggPSBmdW5jdGlvbih3aGVyZSkgew0KICAgIHJldHVybiB7DQogICAgICB0cmVlOm5ldyBBZGFtYVRyZWVTaW1wbGUoKSwNCiAgICAgIGRlbHRhOnt9LA0KICAgICAgcGFyZW50Om51bGwsDQogICAgICBwYXRoOm51bGwsDQogICAgICB3aGVyZTp3aGVyZQ0KICAgIH07DQogIH07DQoNCiAgLy8gSEVMUEVSIHwgY3JlYXRlIGEgbmV3IGRlbHRhIGNvcHkgZnJvbSB0aGUgZ2l2ZW4gc3BlY2lmaWMgc3RhdGUgKGkuZS4gZWl0aGVyIGRhdGEgb3IgdmlldykNCiAgdmFyIG5ld19kZWx0YV9jb3B5ID0gZnVuY3Rpb24oc3MpIHsNCiAgICBpZiAoc3MgPT0gbnVsbCkgew0KICAgICAgcmV0dXJuIG51bGw7DQogICAgfQ0KICAgIHZhciBwYXJlbnQgPSBudWxsOw0KICAgIGlmIChzcy5wYXJlbnQgIT0gbnVsbCkgew0KICAgICAgcGFyZW50ID0gbmV3X2RlbHRhX2NvcHkoc3MucGFyZW50KTsNCiAgICB9DQogICAgdmFyIG5ld19kZWx0YSA9IHt9Ow0KICAgIGlmIChwYXJlbnQgIT0gbnVsbCkgew0KICAgICAgcGFyZW50LmRlbHRhW3NzLnBhdGhdID0gbmV3X2RlbHRhOw0KICAgIH0NCiAgICByZXR1cm4ge3RyZWU6c3MudHJlZSwgcGFyZW50OnBhcmVudCwgZGVsdGE6bmV3X2RlbHRhLCBwYXRoOnNzLnBhdGh9Ow0KICB9Ow0KDQogIC8vIEhFTFBFUiB8IGNvbnN0cnVjdCBhIHBhdGggdG8NCiAgdmFyIHBhdGhfdG8gPSBmdW5jdGlvbihzcywgb2JqKSB7DQogICAgaWYgKHNzLnBhcmVudCAhPSBudWxsKSB7DQogICAgICB2YXIgcGFyZW50ID0gcGF0aF90byhzcy5wYXJlbnQsIHt9KTsNCiAgICAgIHBhcmVudFtzcy5wYXRoXSA9IG9iajsNCiAgICAgIHJldHVybiBwYXJlbnQ7DQogICAgfSBlbHNlIHsNCiAgICAgIHJldHVybiBvYmo7DQogICAgfQ0KICB9Ow0KDQogIC8vIEhFTFBFUiB8IGdldCB0aGUgcm9vdCBvZiB0aGUgc3BlY2lmaWMgc3RhdGUgKGkuZS4gZWl0aGVyIHRoZSBkYXRhJ3Mgcm9vdCBvciB0aGUgdmlldydzIHJvb3QpDQogIHZhciByb290X29mID0gZnVuY3Rpb24oc3MpIHsNCiAgICB2YXIgeCA9IHNzOw0KICAgIHdoaWxlICh4LnBhcmVudCAhPSBudWxsKSB7DQogICAgICB4ID0geC5wYXJlbnQ7DQogICAgfQ0KICAgIHJldHVybiB4Ow0KICB9DQoNCiAgLy8gSEVMUEVSIHwgcmVtb3ZlIGFsbCB0aGUgY2hpbGRyZW4gZnJvbSB0aGUgZ2l2ZW4gRE9NIG5vZGUNCiAgdmFyIG51a2UgPSBmdW5jdGlvbihwYXJlbnQpIHsNCiAgICB2YXIgbGFzdCA9IHBhcmVudC5sYXN0Q2hpbGQ7IA0KICAgIHdoaWxlIChsYXN0KSB7DQogICAgICBwYXJlbnQucmVtb3ZlQ2hpbGQobGFzdCk7DQogICAgICBsYXN0ID0gcGFyZW50Lmxhc3RDaGlsZDsNCiAgICB9DQogIH07DQoNCiAgLy8gSEVMUEVSOiBkZWJvdW5jZSB0aGUgZ2l2ZW4gZnVuY3Rpb25hbCB3aGVuIHJhcGlkIGZ1bmN0aW9uIHNwcmVhZCBpcyBleHBlY3RlZA0KICB2YXIgZGVib3VuY2UgPSBmdW5jdGlvbihtcywgZm9vKSB7DQogICAgdmFyIHN0YXR1cyA9IHtpbmZsaWdodDpmYWxzZSwgdGltZW91dDpudWxsfTsNCiAgICBzdGF0dXMuaW5mbGlnaHQgPSBmYWxzZTsNCiAgICByZXR1cm4gZnVuY3Rpb24oKSB7DQogICAgICBpZiAoIXN0YXR1cy5pbmZsaWdodCkgew0KICAgICAgICBzdGF0dXMuaW5mbGlnaHQgPSB0cnVlOw0KICAgICAgICBzdGF0dXMudGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgew0KICAgICAgICAgIHN0YXR1cy5pbmZsaWdodCA9IGZhbHNlOw0KICAgICAgICAgIHN0YXR1cy50aW1lb3V0ID0gbnVsbDsNCiAgICAgICAgICBmb28oKTsNCiAgICAgICAgfSwgbXMgLyogbXMgKi8pOyAvLyBkZWJvdW5jZSB0aGUgcGFyYW1ldGVycw0KICAgICAgfQ0KICAgIH07DQogIH07DQoNCiAgLy8gSEVMUEVSIHwgcHJlcGFyZSBhIGZyZWUgdW5zdWJzY3JpYmUgb2JqZWN0DQogIHZhciBtYWtlX3Vuc3ViID0gZnVuY3Rpb24oKSB7DQogICAgcmV0dXJuIHtfX2RhdGE6IGZ1bmN0aW9uKCkge30sIF9fdmlldzogZnVuY3Rpb24oKSB7fX07DQogIH07DQoNCiAgLy8gSEVMUEVSIHwgYXVnbWVudCBhbiBleGlzdGluZyBvYmplY3Qgd2l0aCB1bnN1YnNjcmliZSBkYXRhDQogIHZhciBhZGRfdW5zdWIgPSBmdW5jdGlvbihvYmopIHsNCiAgICBvYmouX19kYXRhID0gZnVuY3Rpb24oKSB7fTsNCiAgICBvYmouX192aWV3ID0gZnVuY3Rpb24oKSB7fTsNCiAgfQ0KDQogIC8vIEhFTFBFUiB8IGZpcmUgdGhlIHVuc3Vic2NyaWJlIGNhbGxzIHdpdGhpbiBhbiBvYmplY3QNCiAgdmFyIGZpcmVfdW5zdWIgPSBmdW5jdGlvbih1bnN1Yikgew0KICAgIHVuc3ViLl9fZGF0YSgpOw0KICAgIHVuc3ViLl9fdmlldygpOw0KICB9DQoNCiAgLy8gSEVMUEVSIHwgc3Vic2NyaWJlIHRvIHN0YXRlIGFuZCBwb3B1bGF0ZSB1bnN1YnNjcmliZSBvYmplY3QNCiAgdmFyIHN1YnNjcmliZV9zdGF0ZSA9IGZ1bmN0aW9uKHN0YXRlLCB1bnN1Yikgew0KICAgIGlmIChzdGF0ZS5kYXRhICE9IG51bGwpIHsNCiAgICAgIHVuc3ViLl9fZGF0YSA9IHN0YXRlLmRhdGEudHJlZS5zdWJzY3JpYmUocm9vdF9vZihzdGF0ZS5kYXRhKS5kZWx0YSk7DQogICAgfSBlbHNlIHsNCiAgICAgIHVuc3ViLl9fZGF0YSA9IGZ1bmN0aW9uKCkge307DQogICAgfQ0KICAgIGlmIChzdGF0ZS52aWV3ICE9IG51bGwpIHsNCiAgICAgIHVuc3ViLl9fdmlldyA9IHN0YXRlLnZpZXcudHJlZS5zdWJzY3JpYmUocm9vdF9vZihzdGF0ZS52aWV3KS5kZWx0YSk7IA0KICAgIH0gZWxzZSB7DQogICAgICB1bnN1Yi5fX3ZpZXcgPSBmdW5jdGlvbigpIHt9Ow0KICAgIH0NCiAgfTsNCg0KICB2YXIgc3Vic2NyaWJlX3ZpZXcgPSBmdW5jdGlvbihzdGF0ZSwgdW5zdWIpIHsNCiAgICBpZiAoc3RhdGUudmlldyAhPSBudWxsKSB7DQogICAgICB1bnN1Yi5fX3ZpZXcgPSBzdGF0ZS52aWV3LnRyZWUuc3Vic2NyaWJlKHJvb3Rfb2Yoc3RhdGUudmlldykuZGVsdGEpOyANCiAgICB9IGVsc2Ugew0KICAgICAgdW5zdWIuX192aWV3ID0gZnVuY3Rpb24oKSB7fTsNCiAgICB9DQogIH07DQoNCiAgLy8gUlVOVElNRSB8IFN3aXRjaCB0byB0aGUgdmlldyBvYmplY3QNCiAgc2VsZi5wViA9IGZ1bmN0aW9uKHN0YXRlKSB7DQogICAgcmV0dXJuIHtzZXJ2aWNlOnN0YXRlLnNlcnZpY2UsIGRhdGE6c3RhdGUuZGF0YSwgdmlldzpzdGF0ZS52aWV3LCBjdXJyZW50Oid2aWV3J307DQogIH07DQoNCiAgLy8gUlVOVElNRSB8IFN3aXRjaCB0byB0aGUgZGF0YSBvYmplY3QNCiAgc2VsZi5wRCA9IGZ1bmN0aW9uKHN0YXRlKSB7DQogICAgcmV0dXJuIHtzZXJ2aWNlOiBzdGF0ZS5zZXJ2aWNlLCBkYXRhOnN0YXRlLmRhdGEsIHZpZXc6c3RhdGUudmlldywgY3VycmVudDonZGF0YSd9Ow0KICB9Ow0KDQogIC8vIFJVTlRJTUUgfCBTd2l0Y2ggdG8gdGhlIHJvb3Qgb2JqZWN0IC8gKFJvb3QpDQogIHNlbGYucFIgPSBmdW5jdGlvbihzdGF0ZSkgew0KICAgIHZhciBuZXh0ID0ge3NlcnZpY2U6IHN0YXRlLnNlcnZpY2UsIGRhdGE6c3RhdGUuZGF0YSwgdmlldzpzdGF0ZS52aWV3LCBjdXJyZW50OnN0YXRlLmN1cnJlbnR9Ow0KICAgIHZhciBwcmlvciA9IG5leHRbc3RhdGUuY3VycmVudF07DQogICAgd2hpbGUgKHByaW9yLnBhcmVudCAhPSBudWxsKSB7DQogICAgICBpZiAocHJpb3IucGFyZW50ID09IG51bGwpIHsNCiAgICAgICAgbmV4dFtzdGF0ZS5jdXJyZW50XQ0KICAgICAgICByZXR1cm4gcHJpb3I7DQogICAgICB9DQogICAgICBwcmlvciA9IHByaW9yLnBhcmVudDsNCiAgICB9DQogICAgbmV4dFtzdGF0ZS5jdXJyZW50XSA9IHByaW9yOw0KICAgIHJldHVybiBuZXh0Ow0KICB9Ow0KDQogIC8vIFJVTlRJTUUgfCAuLi8gKFVwKQ0KICBzZWxmLnBVID0gZnVuY3Rpb24oc3RhdGUpIHsNCiAgICB2YXIgbmV4dCA9IHtzZXJ2aWNlOiBzdGF0ZS5zZXJ2aWNlLCBkYXRhOnN0YXRlLmRhdGEsIHZpZXc6c3RhdGUudmlldywgY3VycmVudDpzdGF0ZS5jdXJyZW50fTsNCiAgICB2YXIgcHJpb3IgPSBuZXh0W3N0YXRlLmN1cnJlbnRdOw0KICAgIGlmIChwcmlvci5wYXJlbnQgIT0gbnVsbCkgew0KICAgICAgbmV4dFtzdGF0ZS5jdXJyZW50XSA9IHByaW9yOw0KICAgIH0NCiAgICByZXR1cm4gbmV4dDsNCiAgfTsNCg0KICAvLyBSVU5USU1FIHwgZGl2ZSBvbmUgbGV2ZWwgSW50byBwYXRoMS9wYXRoMi8uLi4uL3BhdGhODQogIHNlbGYucEkgPSBmdW5jdGlvbihzdGF0ZSwgbmFtZSkgew0KICAgIHZhciBwcmlvciA9IHN0YXRlW3N0YXRlLmN1cnJlbnRdOw0KICAgIGlmICghKG5hbWUgaW4gcHJpb3IuZGVsdGEpKSB7DQogICAgICBwcmlvci5kZWx0YVtuYW1lXSA9IHt9Ow0KICAgIH0NCiAgICB2YXIgbmV4dCA9IHtzZXJ2aWNlOiBzdGF0ZS5zZXJ2aWNlLCBkYXRhOnN0YXRlLmRhdGEsIHZpZXc6c3RhdGUudmlldywgY3VycmVudDpzdGF0ZS5jdXJyZW50fTsNCiAgICBuZXh0W3N0YXRlLmN1cnJlbnRdID0gew0KICAgICAgdHJlZTpwcmlvci50cmVlLA0KICAgICAgZGVsdGE6cHJpb3IuZGVsdGFbbmFtZV0sDQogICAgICBwYXJlbnQ6cHJpb3IsDQogICAgICBwYXRoOm5hbWUsDQogICAgfTsNCiAgICBpZiAobmV4dC5jdXJyZW50ID09ICJkYXRhIikgew0KICAgICAgbmV4dC5kYXRhLmNvbm5lY3Rpb24gPSBwcmlvci5jb25uZWN0aW9uOw0KICAgIH0NCiAgICByZXR1cm4gbmV4dDsNCiAgfTsNCg0KICAvLyBSVU5USU1FIHwgZXh0ZW5kIHRoZSBnaXZlbiBzdGF0ZSB3aXRoIHRoZSB2aWV3IGhhdmluZyBhIHNlcGVyYXRlIGNoaWxkDQogIHNlbGYucEVWID0gZnVuY3Rpb24oc3RhdGUsIG5hbWUpIHsNCiAgICBpZiAoIShuYW1lIGluIHN0YXRlLnZpZXcuZGVsdGEpKSB7DQogICAgICBzdGF0ZS52aWV3LmRlbHRhW25hbWVdID0ge307DQogICAgfQ0KICAgIHJldHVybiB7DQogICAgICBzZXJ2aWNlOiBzdGF0ZS5zZXJ2aWNlLA0KICAgICAgZGF0YTogc3RhdGUuZGF0YSwNCiAgICAgIHZpZXc6IHsNCiAgICAgICAgdHJlZTpzdGF0ZS52aWV3LnRyZWUsDQogICAgICAgIGRlbHRhOnN0YXRlLnZpZXcuZGVsdGFbbmFtZV0sDQogICAgICAgIHBhcmVudDpzdGF0ZS52aWV3LA0KICAgICAgICBwYXRoOm5hbWUsDQogICAgICB9LA0KICAgICAgY3VycmVudDpzdGF0ZS5jdXJyZW50DQogICAgfTsNCiAgfTsNCg0KICB2YXIgZm9yayA9IGZ1bmN0aW9uKHByaW9yU3RhdGUpIHsNCiAgICB2YXIgc3RhdGUgPSB7DQogICAgICBzZXJ2aWNlOiBwcmlvclN0YXRlLnNlcnZpY2UsDQogICAgICBkYXRhOiBuZXdfZGVsdGFfY29weShwcmlvclN0YXRlLmRhdGEpLA0KICAgICAgdmlldzogbmV3X2RlbHRhX2NvcHkocHJpb3JTdGF0ZS52aWV3KSwNCiAgICAgIGN1cnJlbnQ6cHJpb3JTdGF0ZS5jdXJyZW50DQogICAgfTsNCiAgICBpZiAoc3RhdGUuZGF0YSAhPSBudWxsKSB7DQogICAgICBzdGF0ZS5kYXRhLmNvbm5lY3Rpb24gPSBwcmlvclN0YXRlLmRhdGEuY29ubmVjdGlvbjsNCiAgICB9DQogICAgcmV0dXJuIHN0YXRlOw0KICB9DQoNCiAgLy8gUlVOVElNRSB8IHN1YnNjcmliZSBiZXR3ZWVuIHRoZSBzdGF0ZSBhbmQgdGhlIG9iamVjdC4NCiAgLy8gV2hlbiB0aGUgbWVtYmVyIGZpZWxkIHdpdGhpbiBzdGF0ZSBvZiBuYW1lIGNoYW5nZXMsIGNvcHkgdGhhdCB2YWx1ZSBpbnRvIHRoZSBvYmogYW5kIHJ1biByZWNvbXB1dGUoKQ0KICBzZWxmLlkgPSBmdW5jdGlvbihzdGF0ZSwgb2JqLCBuYW1lLCByZWNvbXB1dGUpIHsNCiAgICB2YXIgc3ViID0gZnVuY3Rpb24odmFsdWUpIHsNCiAgICAgIG9ialtuYW1lXSA9IHZhbHVlOw0KICAgICAgcmVjb21wdXRlKCk7DQogICAgfTsNCiAgICBzdWJzY3JpYmUoc3RhdGUsIG5hbWUsIHN1Yik7DQogIH07DQoNCiAgLy8gUlVOVElNRSB8IEp1c3Qgc3Vic2NyaWJlZSB2YWx1ZSB0byB0aGUgb2JqZWN0IGZpZWxkIG9mIG5hbWUgKG5vLXJlY29tcHV0ZSkNCiAgc2VsZi5ZUyA9IGZ1bmN0aW9uKHN0YXRlLCBvYmosIG5hbWUpIHsNCiAgICB2YXIgc3ViID0gZnVuY3Rpb24odmFsdWUpIHsNCiAgICAgIG9ialtuYW1lXSA9IHZhbHVlOw0KICAgIH07DQogICAgc3Vic2NyaWJlKHN0YXRlLCBuYW1lLCBzdWIpOw0KICB9Ow0KDQogIC8vIFJVTlRJTUUgfCAiVGV4dCINCiAgc2VsZi5UID0gZnVuY3Rpb24odHgpIHsNCiAgICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodHgpOw0KICB9Ow0KDQogIC8vIFJVTlRJTUUgfCA8bG9va3VwIHBhdGg9Li4uPg0KICBzZWxmLkwgPSBmdW5jdGlvbihzdGF0ZSwgbmFtZSkgew0KICAgIHZhciBkb20gPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgiIik7DQogICAgdmFyIHN1YiA9IGZ1bmN0aW9uKHZhbHVlKSB7IGRvbS5ub2RlVmFsdWUgPSB2YWx1ZTsgfTsNCiAgICBzdWJzY3JpYmUoc3RhdGUsIG5hbWUsIHN1Yik7DQogICAgcmV0dXJuIGRvbTsNCiAgfTsNCg0KICAvLyBSVU5USU1FIHwgPGxvb2t1cCBwYXRoPS4uLiB0cmFuc2Zvcm09IiR0cmFuc2Zvcm0iIC8+DQogIHNlbGYuTFQgPSBmdW5jdGlvbihzdGF0ZSwgbmFtZSwgdHJhbnNmb3JtKSB7DQogICAgdmFyIGRvbSA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCIiKTsNCiAgICB2YXIgc3ViID0gZnVuY3Rpb24odmFsdWUpIHsgZG9tLm5vZGVWYWx1ZSA9IHRyYW5zZm9ybSh2YWx1ZSk7IH07DQogICAgc3Vic2NyaWJlKHN0YXRlLCBuYW1lLCBzdWIpOw0KICAgIHJldHVybiBkb207DQogIH07DQoNCiAgLy8gUlVOVElNRSB8IDx0YWc+DQogIHNlbGYuRSA9IGZ1bmN0aW9uKHRhZywgbnMpIHsNCiAgICBpZiAobnMgPT0gdW5kZWZpbmVkIHx8IG5zID09IG51bGwpIHsNCiAgICAgIHJldHVybiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZyk7DQogICAgfSBlbHNlIHsNCiAgICAgIHZhciByZXN1bHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMobnMsIHRhZyk7DQogICAgICByZXN1bHQuc2V0QXR0cmlidXRlKCd4bWxucycsIG5zKTsNCiAgICAgIHJldHVybiByZXN1bHQ7DQogICAgfQ0KICB9Ow0KDQogIC8vIFJVTlRJTUUgfCA8cGljayBuYW1lPS4uLj4NCiAgc2VsZi5QID0gZnVuY3Rpb24ocGFyZW50LCBwcmlvclN0YXRlLCByeE9iaiwgY2hpbGRNYWtlcikgew0KICAgIHZhciB1bnN1YiA9IG1ha2VfdW5zdWIoKTsNCiAgICByeE9iai5fXyA9IGZ1bmN0aW9uKCkgew0KICAgICAgaWYgKHRoaXMubmFtZSA9PSByeE9iai5uYW1lKSB7IHJldHVybjsgfQ0KICAgICAgZmlyZV91bnN1Yih1bnN1Yik7DQogICAgICB0aGlzLm5hbWUgPSByeE9iai5uYW1lOw0KICAgICAgdmFyIGNvID0gZ2V0X2Nvbm5lY3Rpb25fb2JqKHJ4T2JqLm5hbWUpOw0KICAgICAgbnVrZShwYXJlbnQpOw0KICAgICAgdmFyIHN0YXRlID0gew0KICAgICAgICBzZXJ2aWNlOiBwcmlvclN0YXRlLnNlcnZpY2UsDQogICAgICAgIGRhdGE6IHtjb25uZWN0aW9uOiBjbywgdHJlZTpjby50cmVlLCBkZWx0YTp7fSwgcGFyZW50Om51bGwsIHBhdGg6bnVsbH0sDQogICAgICAgIHZpZXc6IG5ld19kZWx0YV9jb3B5KHByaW9yU3RhdGUudmlldyksDQogICAgICAgIGN1cnJlbnQ6J2RhdGEnDQogICAgICB9Ow0KICAgICAgY2hpbGRNYWtlcihzdGF0ZSk7DQogICAgICBzdWJzY3JpYmVfc3RhdGUoc3RhdGUsIHVuc3ViKTsNCiAgICB9LmJpbmQoe25hbWU6IiJ9KTsNCiAgfTsNCg0KICAvLyBSVU5USU1FIHwgPHRlbXBsYXRlIG5hbWU9Ii4uLiI+DQogIHNlbGYuVFAgPSBmdW5jdGlvbihuYW1lLCBmb28pIHsNCiAgICB0ZW1wbGF0ZXNbbmFtZV0gPSBmb287DQogIH07DQoNCiAgLy8gUlVOVElNRSB8IDwuLi4gaHJlZj0iIiAuLi4+DQogIHNlbGYuSFJFRiA9IGZ1bmN0aW9uKGRvbSwgaHJlZikgew0KICAgIGRvbS5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCBmaXhIcmVmKGhyZWYpKTsNCiAgICBkb20ub25jbGljayA9IGZ1bmN0aW9uKGV2dCkgew0KICAgICAgdmFyIHBhcnRzID0gKGhyZWYuc3RhcnRzV2l0aCgiLyIpID8gaHJlZi5zdWJzdHJpbmcoMSkgOiBocmVmKS5zcGxpdCgiLyIpOw0KICAgICAgaWYgKHJvdXRlKHBhcnRzLCAwLCByb3V0ZXIsIHt9KSkgew0KICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsNCiAgICAgICAgc2VsZi5ydW4oZG9jdW1lbnQuYm9keSwgaHJlZiwgdHJ1ZSk7DQogICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgIH0NCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH07DQogIH07DQogIC8vIFJVTlRJTUUgfCA8Li4uIGNsYXNzPSIiIC4uLj4NCiAgc2VsZi5BQ0xBU1MgPSBmdW5jdGlvbihkb20sIHZhbHVlKSB7DQogICAgZG9tLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCB2YWx1ZSk7DQogIH07DQogIC8vIFJVTlRJTUUgfCA8Li4uIHNyYz0iIiAuLi4+DQogIHNlbGYuQVNSQyA9IGZ1bmN0aW9uKGRvbSwgdmFsdWUpIHsNCiAgICBkb20uc2V0QXR0cmlidXRlKCdzcmMnLCB2YWx1ZSk7DQogIH07DQoNCiAgLy8gUlVOVElNRSB8IDx0YWcgcng6dGVtcGxhdGU9JG5hbWU+DQogIHNlbGYuVVQgPSBmdW5jdGlvbihwYXJlbnQsIHN0YXRlLCBuYW1lLCBjaGlsZF9tYWtlcikgew0KICAgIHZhciBmb28gPSB0ZW1wbGF0ZXNbbmFtZV07DQogICAgZm9vKHBhcmVudCwgc3RhdGUsIGNoaWxkX21ha2VyKTsNCiAgfTsNCg0KICAvLyBSVU5USU1FIHwgPHRhZyByeDpzd2l0Y2g9cGF0aCAuLj4NCiAgc2VsZi5TVyA9IGZ1bmN0aW9uKHBhcmVudCwgcHJpb3JTdGF0ZSwgbmFtZSwgY2hpbGRyZW5NYWtlcikgew0KICAgIHZhciBzd3N0ID0ge3ByaW9yOm51bGx9Ow0KICAgIGFkZF91bnN1Yihzd3N0KTsNCiAgICB2YXIgc3ViID0gZnVuY3Rpb24odmFsdWUpIHsNCiAgICAgIGlmICh2YWx1ZSA9PSB0aGlzLnByaW9yKSB7DQogICAgICAgIHJldHVybjsNCiAgICAgIH0NCiAgICAgIHRoaXMucHJpb3IgPSB2YWx1ZTsNCiAgICAgIGZpcmVfdW5zdWIodGhpcyk7DQogICAgICBudWtlKHBhcmVudCk7DQogICAgICB2YXIgc3RhdGUgPSBmb3JrKHByaW9yU3RhdGUpOw0KICAgICAgY2hpbGRyZW5NYWtlcihwYXJlbnQsIHN0YXRlLCAnJyArIHZhbHVlKTsNCiAgICAgIHN1YnNjcmliZV9zdGF0ZShzdGF0ZSwgdGhpcyk7DQoNCiAgICB9LmJpbmQoc3dzdCk7DQogICAgc3Vic2NyaWJlKHByaW9yU3RhdGUsIG5hbWUsIHN1Yik7DQogIH07DQoNCiAgLy8gUlVOVElNRSB8IDx0YWcgcng6aXRlcmF0ZT1wYXRoIC4uLj4NCiAgc2VsZi5JVCA9IGZ1bmN0aW9uKHBhcmVudERvbSwgc3RhdGUsIG5hbWUsIGV4cGFuZFZpZXcsIG1ha2VyKSB7DQogICAgdmFyIGl0X3N0YXRlID0gc2VsZi5wSShzdGF0ZSwgbmFtZSk7DQogICAgdmFyIGRvbUJ5S2V5ID0ge307DQogICAgdmFyIHZpZXdVblN1YkJ5S2V5ID0ge307DQoNCiAgICB2YXIgc3ViID0gew0KICAgICAgJysnOiBmdW5jdGlvbihrZXkpIHsNCiAgICAgICAgLy8gVE9ETzogdmlldyBwcm9wYWdhdGVzIGRvbid0IHdvcmsgaGVyZQ0KICAgICAgICB2YXIgbmV3X3N0YXRlID0gc2VsZi5wSShpdF9zdGF0ZSwga2V5KTsNCiAgICAgICAgaWYgKGV4cGFuZFZpZXcpIHsNCiAgICAgICAgICBuZXdfc3RhdGUgPSBzZWxmLnBFVihpdF9zdGF0ZSwga2V5KTsNCiAgICAgICAgfQ0KICAgICAgICBuZXdfc3RhdGUgPSB7DQogICAgICAgICAgc2VydmljZTogbmV3X3N0YXRlLnNlcnZpY2UsDQogICAgICAgICAgZGF0YTogbmV3X3N0YXRlLmRhdGEsDQogICAgICAgICAgdmlldzogbmV3X2RlbHRhX2NvcHkobmV3X3N0YXRlLnZpZXcpLA0KICAgICAgICAgIGN1cnJlbnQ6bmV3X3N0YXRlLmN1cnJlbnQNCiAgICAgICAgfTsNCiAgICAgICAgDQogICAgICAgIHZhciB1bnN1YiA9IG1ha2VfdW5zdWIoKTsNCiAgICAgICAgdmFyIGRvbSA9IG1ha2VyKG5ld19zdGF0ZSk7DQogICAgICAgIGRvbUJ5S2V5W2tleV0gPSBkb207DQogICAgICAgIHZpZXdVblN1YkJ5S2V5W2tleV0gPSB1bnN1YjsNCiAgICAgICAgcGFyZW50RG9tLmFwcGVuZChkb20pOw0KICAgICAgICBzdWJzY3JpYmVfdmlldyhuZXdfc3RhdGUsIHVuc3ViKTsNCiAgICAgICAgcmV0dXJuIG5ld19zdGF0ZVtuZXdfc3RhdGUuY3VycmVudF0uZGVsdGE7DQogICAgICB9LA0KICAgICAgJy0nOiBmdW5jdGlvbihrZXkpIHsNCiAgICAgICAgaWYgKGtleSBpbiBkb21CeUtleSkgew0KICAgICAgICAgIHBhcmVudERvbS5yZW1vdmVDaGlsZChkb21CeUtleVtrZXldKTsNCiAgICAgICAgICBkZWxldGUgZG9tQnlLZXlba2V5XTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoa2V5IGluIHZpZXdVblN1YkJ5S2V5KSB7DQogICAgICAgICAgZmlyZV91bnN1Yih2aWV3VW5TdWJCeUtleVtrZXldKTsNCiAgICAgICAgICBkZWxldGUgdmlld1VuU3ViQnlLZXlba2V5XTsNCiAgICAgICAgfQ0KICAgICAgfSwNCiAgICAgICd+JzogZnVuY3Rpb24ob3JkKSB7DQogICAgICAgIG51a2UocGFyZW50RG9tKTsNCiAgICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCBvcmQubGVuZ3RoOyBrKyspIHsNCiAgICAgICAgICBwYXJlbnREb20uYXBwZW5kKGRvbUJ5S2V5W29yZFtrXV0pOw0KICAgICAgICB9DQogICAgICB9DQogICAgfTsNCiAgICBzdWJzY3JpYmUoc3RhdGUsIG5hbWUsIHN1Yik7DQogIH07DQoNCiAgdmFyIGZpbmQgPSBmdW5jdGlvbihzdGF0ZSwgY2hhbm5lbCwga2V5LCB2YWx1ZSkgew0KICAgIGlmIChjaGFubmVsIGluIHN0YXRlWydkYXRhJ10uY29ubmVjdGlvbi5vdXRzdGFuZGluZykgew0KICAgICAgdmFyIGFyciA9IHN0YXRlWydkYXRhJ10uY29ubmVjdGlvbi5vdXRzdGFuZGluZ1tjaGFubmVsXS5vcHRpb25zOw0KICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCBhcnIubGVuZ3RoOyBrKyspIHsNCiAgICAgICAgdmFyIHMgPSBhcnJba107DQogICAgICAgIGlmIChrZXkgaW4gcyAmJiBzW2tleV0gPT0gdmFsdWUpIHsNCiAgICAgICAgICByZXR1cm4gczsNCiAgICAgICAgfSANCiAgICAgIH0NCiAgICAgIHJldHVybiBudWxsOw0KICAgIH0gZWxzZSB7DQogICAgICByZXR1cm4gbnVsbDsNCiAgICB9DQogIH07DQoNCiAgdmFyIGN1c3RvbXMgPSB7fTsNCg0KICBzZWxmLlBSQ1VBQyA9IGZ1bmN0aW9uKG5hbWUsIGZvbykgew0KICAgIGN1c3RvbXNbbmFtZV0gPSBmb287DQogIH07DQoNCiAgc2VsZi5leENDID0gZnVuY3Rpb24oZG9tLCB0eXBlLCBzdGF0ZSwgY3VzdG9tQ29tbWFuZE5hbWUpIHsNCiAgICBkb20uYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBmdW5jdGlvbigpIHsNCiAgICAgIGlmIChjdXN0b21Db21tYW5kTmFtZSBpbiBjdXN0b21zKSB7DQogICAgICAgIGN1c3RvbXNbY3VzdG9tQ29tbWFuZE5hbWVdKCk7DQogICAgICB9DQogICAgfSk7DQogIH07DQoNCiAgc2VsZi5hQ0MgPSBmdW5jdGlvbihmb3JtLCBzdGF0ZSwgY3VzdG9tQ29tbWFuZE5hbWUsIHN0YXR1c1Zhcikgew0KICAgIHZhciBzaWduYWwgPSBtYWtlX2ZhaWx1cmVfc2lnbmFsKHN0YXRlLCBzdGF0dXNWYXIpOw0KICAgIGZvcm0ub25zdWJtaXQgPSBmdW5jdGlvbihldnQpIHsNCiAgICAgIGlmIChjdXN0b21Db21tYW5kTmFtZSBpbiBjdXN0b21zKSB7DQogICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpOw0KICAgICAgICB2YXIgb2JqID0gZ2V0X2Zvcm0oZm9ybSk7DQogICAgICAgIGN1c3RvbXNbY3VzdG9tQ29tbWFuZE5hbWVdKG9iaiwgc3RhdGUsIHNpZ25hbCwgc2VsZik7DQogICAgICB9DQogICAgfTsNCiAgfTsNCg0KICBzZWxmLmV4RCA9IGZ1bmN0aW9uKGRvbSwgdHlwZSwgc3RhdGUsIG5hbWUsIGNoYW5uZWwsIGtleSkgew0KICAgIHZhciBkZWNpZGUgPSB7IHZhbHVlOiBudWxsIH07DQogICAgZG9tLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgZnVuY3Rpb24oKSB7DQogICAgICB2YXIgcmVzdWx0ID0gZmluZChzdGF0ZSwgY2hhbm5lbCwga2V5LCBkZWNpZGUudmFsdWUpOw0KICAgICAgaWYgKHJlc3VsdCAhPSBudWxsKSB7DQogICAgICAgIGxldCBzdGFydCA9IHBlcmZvcm1hbmNlLm5vdygpOw0KICAgICAgICBzdGF0ZS5kYXRhLmNvbm5lY3Rpb24ucHRyLnNlbmQoY2hhbm5lbCwgcmVzdWx0LCB7DQogICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24ocmVhc29uKSB7DQoNCiAgICAgICAgICB9LA0KICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKHBheWxvYWQpIHsNCiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJTdWNjZXNzfCIgKyBwYXlsb2FkLnNlcSArICI7bGF0ZW5jeT0iICsgKHBlcmZvcm1hbmNlLm5vdygpIC0gc3RhcnQpKTsNCiAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgICAgfSAgICAgIA0KICAgIH0pOw0KICAgIHN1YnNjcmliZShzdGF0ZSwgbmFtZSwgZnVuY3Rpb24odmFsdWUpIHsgZGVjaWRlLnZhbHVlID0gdmFsdWU7IH0pOw0KICB9Ow0KDQogIC8vIFJVTlRJTUU6IDx0YWcgLi4gcng6ZXZlbnQ9Ii4uLiBzZXQ6bmFtZT12YWx1ZSAuLi4iPg0KICBzZWxmLm9uUyA9IGZ1bmN0aW9uKGRvbSwgdHlwZSwgc3RhdGUsIG5hbWUsIHZhbHVlKSB7DQogICAgdmFyIHJ1bm5hYmxlID0gZnVuY3Rpb24oKSB7DQogICAgICB2YXIgb2JqID0ge307DQogICAgICBpZiAodHlwZW9mKHZhbHVlKSA9PSAnZnVuY3Rpb24nKSB7DQogICAgICAgIG9ialtuYW1lXSA9IHZhbHVlKCk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBvYmpbbmFtZV0gPSB2YWx1ZTsNCiAgICAgIH0NCiAgICAgIHZhciBkZWx0YSA9IHBhdGhfdG8oc3RhdGUsIG9iaik7DQogICAgICBzdGF0ZVtzdGF0ZS5jdXJyZW50XS50cmVlLnVwZGF0ZShkZWx0YSk7DQogICAgfTsNCiAgICBpZiAodHlwZSA9PSAnbG9hZCcpIHsNCiAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KHJ1bm5hYmxlLCAxKTsNCiAgICB9IGVsc2Ugew0KICAgICAgZG9tLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgcnVubmFibGUpOw0KICAgIH0NCiAgfTsNCg0KICAvLyBSVU5USU1FOiA8dGFnIC4uIHJ4OmV2ZW50PSIuLi4gdG9nZ2xlOm5hbWUgLi4uIj4NCiAgc2VsZi5vblQgPSBmdW5jdGlvbihkb20sIHR5cGUsIHN0YXRlLCBuYW1lKSB7DQogICAgdmFyIGNhcHR1cmVkID0ge3ZhbHVlOiBmYWxzZX07DQogICAgZG9tLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgZnVuY3Rpb24oKSB7DQogICAgICB2YXIgb2JqID0ge307DQogICAgICBvYmpbbmFtZV0gPSAhY2FwdHVyZWQudmFsdWU7DQogICAgICB2YXIgZGVsdGEgPSBwYXRoX3RvKHN0YXRlLCBvYmopOw0KICAgICAgc3RhdGVbc3RhdGUuY3VycmVudF0udHJlZS51cGRhdGUoZGVsdGEpOw0KICAgIH0pOw0KICAgIHN1YnNjcmliZShzdGF0ZSwgbmFtZSwgZnVuY3Rpb24odmFsdWUpIHsNCiAgICAgIGNhcHR1cmVkLnZhbHVlID0gdmFsdWUgPT0gdHJ1ZTsNCiAgICB9KTsNCiAgfTsNCg0KICAvLyBSVU5USU1FOiA8dGFnIC4uIHJ4OmV2ZW50PSIuLi4gZGVsdGE6bmFtZT1kaWZmIiAuLi4iPg0KICBzZWxmLm9uRCA9IGZ1bmN0aW9uKGRvbSwgdHlwZSwgc3RhdGUsIG5hbWUsIGRpZmYpIHsNCiAgICB2YXIgY2FwdHVyZWQgPSB7dmFsdWU6IDB9Ow0KICAgIGRvbS5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGZ1bmN0aW9uKCkgew0KICAgICAgdmFyIG9iaiA9IHt9Ow0KICAgICAgb2JqW25hbWVdID0gY2FwdHVyZWQudmFsdWUgKyBkaWZmOw0KICAgICAgdmFyIGRlbHRhID0gcGF0aF90byhzdGF0ZSwgb2JqKTsNCiAgICAgIHN0YXRlW3N0YXRlLmN1cnJlbnRdLnRyZWUudXBkYXRlKGRlbHRhKTsNCiAgICB9KTsNCiAgICBzdWJzY3JpYmUoc3RhdGUsIG5hbWUsIGZ1bmN0aW9uKHZhbHVlKSB7DQogICAgICBpZiAodHlwZW9mKHZhbHVlKSA9PSAibnVtYmVyIikgew0KICAgICAgICBjYXB0dXJlZC52YWx1ZSA9IHZhbHVlOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgdmFyIHZhbCA9IHBhcnNlRmxvYXQodmFsdWUpOw0KICAgICAgICBpZiAoIWlzTmFOKHZhbCkpIHsNCiAgICAgICAgICBjYXB0dXJlZC52YWx1ZSA9IHZhbDsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0pOw0KICB9Ow0KDQogIHNlbGYuREUgPSBmdW5jdGlvbihwYXJlbnQsIHByaW9yU3RhdGUsIGV2YWxTdGF0ZSwgY2hhbm5lbCwga2V5LCBuYW1lLCBzaG91bGRCZSwgX2V4cGFuZCwgbWFrZXJUcnVlLCBtYWtlckZhbHNlKSB7DQogICAgdmFyIGRlY2lkZSA9IHsNCiAgICAgIHZhbHVlOiAnJywNCiAgICAgIG93bmVyOiBwYXJlbnQsDQogICAgICBzaG93bjogZmFsc2UsDQogICAgICBldmFsOiBudWxsLA0KICAgIH07DQogICAgYWRkX3Vuc3ViKGRlY2lkZSk7DQogICAgdmFyIGNoYW5nZSA9IGZ1bmN0aW9uKHNob3cpIHsNCiAgICAgIGZpcmVfdW5zdWIoZGVjaWRlKTsNCiAgICAgIG51a2UocGFyZW50KTsNCiAgICAgIHZhciBzdGF0ZSA9IGZvcmsocHJpb3JTdGF0ZSk7DQogICAgICBpZiAoc2hvdyA9PT0gc2hvdWxkQmUpIHsNCiAgICAgICAgbWFrZXJUcnVlKHBhcmVudCwgc3RhdGUpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgbWFrZXJGYWxzZShwYXJlbnQsIHN0YXRlKTsNCiAgICAgIH0NCiAgICAgIHN1YnNjcmliZV9zdGF0ZShzdGF0ZSwgZGVjaWRlKTsNCiAgICB9Ow0KDQogICAgZGVjaWRlLnVwZGF0ZSA9IGZ1bmN0aW9uKCkgew0KICAgICAgdmFyIGV2YWwgPSBmaW5kKHByaW9yU3RhdGUsIGNoYW5uZWwsIGtleSwgZGVjaWRlLnZhbHVlKSAhPSBudWxsOw0KICAgICAgaWYgKGRlY2lkZS5ldmFsICE9IGV2YWwpIHsNCiAgICAgICAgZGVjaWRlLmV2YWwgPSBldmFsOw0KICAgICAgICBjaGFuZ2UoZGVjaWRlLmV2YWwpOw0KICAgICAgfQ0KICAgIH07DQoNCiAgICBwcmlvclN0YXRlLmRhdGEuY29ubmVjdGlvbi5zdWJzY3JpYmUoY2hhbm5lbCwgZnVuY3Rpb24oKSB7DQogICAgICBkZWNpZGUudXBkYXRlKCk7DQogICAgfSk7DQoNCiAgICBzdWJzY3JpYmUoZXZhbFN0YXRlLCBuYW1lLCBmdW5jdGlvbih2YWx1ZSkgew0KICAgICAgZGVjaWRlLnZhbHVlID0gdmFsdWU7DQogICAgICBkZWNpZGUudXBkYXRlKCk7DQogICAgfSk7DQogIH07DQoNCiAgc2VsZi5JRiA9IGZ1bmN0aW9uKHBhcmVudCwgcHJpb3JTdGF0ZSwgbmFtZSwgc2hvdWxkQmUsIGV4cGFuZFZpZXcsIG1ha2VyVHJ1ZSwgbWFrZXJGYWxzZSkgew0KICAgIHZhciB1bnN1YiA9IG1ha2VfdW5zdWIoKTsNCiAgICB2YXIgc2V0ID0gZnVuY3Rpb24odmFsdWUpIHsNCiAgICAgIHZhciBzaG93ID0gKHZhbHVlID8gdHJ1ZSA6IGZhbHNlKSA9PT0gc2hvdWxkQmU7DQogICAgICBpZiAodGhpcy5zaG93biA9PSBzaG93KSB7DQogICAgICAgIHJldHVybjsNCiAgICAgIH0NCiAgICAgIHRoaXMuc2hvd24gPSBzaG93Ow0KICAgICAgbnVrZShwYXJlbnQpOw0KICAgICAgZmlyZV91bnN1Yih1bnN1Yik7DQogICAgICB2YXIgc3RhdGUgPSBmb3JrKHByaW9yU3RhdGUpOw0KICAgICAgdmFyIG5leHQgPSBzdGF0ZTsNCiAgICAgIGlmICh0eXBlb2YodmFsdWUpID09ICdvYmplY3QnKSB7DQogICAgICAgIG5leHQgPSBzZWxmLnBJKG5leHQsIG5hbWUpOw0KICAgICAgICBpZiAoZXhwYW5kVmlldykgew0KICAgICAgICAgIG5leHQgPSBzZWxmLnBFVihuZXh0LCBuYW1lKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgaWYgKHNob3cpIHsNCiAgICAgICAgbWFrZXJUcnVlKHBhcmVudCwgbmV4dCk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBtYWtlckZhbHNlKHBhcmVudCwgbmV4dCk7DQogICAgICB9DQogICAgICBzdWJzY3JpYmVfc3RhdGUoc3RhdGUsIHVuc3ViKTsNCiAgICB9LmJpbmQoe3Nob3duOnNob3VsZEJlfSk7DQogICAgc2V0KCFzaG91bGRCZSk7DQogICAgc3Vic2NyaWJlKHByaW9yU3RhdGUsIG5hbWUsIHNldCk7DQogIH07DQoNCiAgLy8vIFJVTlRJTUUgfCByeDphY3Rpb249Y29weTpwYXRoDQogIHNlbGYuYUNQID0gZnVuY3Rpb24oZm9ybSwgc3RhdGUsIG5hbWUpIHsNCiAgICBmb3JtLm9uc3VibWl0ID0gZnVuY3Rpb24oZXZ0KSB7DQogICAgICBldnQucHJldmVudERlZmF1bHQoKTsNCiAgICAgIHZhciBvYmogPSBnZXRfZm9ybShmb3JtKTsNCiAgICAgIGlmIChuYW1lICE9ICIuIiAmJiBuYW1lICE9ICIiKSB7DQogICAgICAgIHZhciBubyA9IHt9Ow0KICAgICAgICBub1tuYW1lXSA9IG9iajsNCiAgICAgICAgb2JqID0gbm87DQogICAgICB9DQogICAgICB2YXIgZGVsdGEgPSBwYXRoX3RvKHN0YXRlLCBvYmopOw0KICAgICAgc3RhdGUudmlldy50cmVlLnVwZGF0ZShkZWx0YSk7DQogICAgfTsNCiAgfTsNCiAgICANCiAgLy8gUlVOVElNRSB8IDxpbnB1dCAuLi4gcng6c3luYz1wYXRoIC4uLj4NCiAgc2VsZi5TWSA9IGZ1bmN0aW9uKGVsLCBzdGF0ZSwgbmFtZSwgbXMpIHsNCiAgICB2YXIgdHlwZSA9ICgndHlwZScgaW4gZWwpID8gZWwudHlwZS50b1VwcGVyQ2FzZSgpIDogJ3RleHQnOw0KICAgIHZhciBzaWduYWwgPSBmdW5jdGlvbih2YWx1ZSkgew0KICAgICAgdmFyIG9iaiA9IHt9Ow0KICAgICAgb2JqW25hbWVdID0gZWwudmFsdWU7DQogICAgICB2YXIgZGVsdGEgPSBwYXRoX3RvKHN0YXRlLCBvYmopOw0KICAgICAgc3RhdGUudmlldy50cmVlLnVwZGF0ZShkZWx0YSk7DQogICAgfTsNCiAgICBpZiAodHlwZSA9PSAiQ0hFQ0tCT1giKSB7DQogICAgICBlbC5vbmNoYW5nZSA9IGRlYm91bmNlKG1zLCBmdW5jdGlvbihldnQpIHsNCiAgICAgICAgc2lnbmFsKGVsLmNoZWNrZWQgPyB0cnVlIDogZmFsc2UpOw0KICAgICAgfSk7DQogICAgfSBlbHNlIGlmICh0eXBlID09ICJSQURJTyIpIHsNCiAgICAgIGVsLm9uY2hhbmdlID0gZGVib3VuY2UobXMsIGZ1bmN0aW9uKGV2dCkgew0KICAgICAgICBpZiAoZWwuY2hlY2tlZCkgew0KICAgICAgICAgIHNpZ25hbChlbC52YWx1ZSk7DQogICAgICAgIH0NCiAgICAgIH0pOw0KICAgIH0gZWxzZSB7DQogICAgICBlbC5vbmNoYW5nZSA9IGRlYm91bmNlKG1zLCBmdW5jdGlvbihldnQpIHsNCiAgICAgICAgc2lnbmFsKGVsLnZhbHVlKTsNCiAgICAgIH0pOw0KICAgICAgZWwub25rZXl1cCA9IGVsLm9uY2hhbmdlOw0KICAgICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7DQogICAgICAgIHNpZ25hbChlbC52YWx1ZSk7DQogICAgICB9LCAxKTsNCiAgICB9DQogIH07DQoNCiAgLy8gSEVMUEVSIHwgZXh0cmFjdCBhbGwgdGhlIGlucHV0cyBmcm9tIHRoZSBnaXZlbiBlbGVtZW50IGFuZCBidWlsZCBhbiBvYmplY3QNCiAgdmFyIGJ1aWxkX29iaiA9IGZ1bmN0aW9uKGVsLCBvYmopIHsNCiAgICBpZiAoZWwudGFnTmFtZS50b1VwcGVyQ2FzZSgpID09ICJURVhUQVJFQSIpIHsNCiAgICAgIG9ialtlbC5uYW1lXSA9IGVsLnZhbHVlOw0KICAgIH0gZWxzZSBpZiAoZWwudGFnTmFtZS50b1VwcGVyQ2FzZSgpID09ICJTRUxFQ1QiKSB7DQogICAgICBvYmpbZWwubmFtZV0gPSBlbC52YWx1ZTsNCiAgICB9IGVsc2UgaWYgKGVsLnRhZ05hbWUudG9VcHBlckNhc2UoKSA9PSAiSU5QVVQiKSB7DQogICAgICB2YXIgdHlwZSA9ICgndHlwZScgaW4gZWwpID8gZWwudHlwZS50b1VwcGVyQ2FzZSgpIDogJ3RleHQnOw0KICAgICAgaWYgKHR5cGUgPT0gIlNVQk1JVCIgfHwgdHlwZSA9PSAiUkVTRVQiKSByZXR1cm47DQogICAgICBpZiAoJ25hbWUnIGluIGVsKSB7DQogICAgICAgIHZhciBuYW1lID0gZWwubmFtZTsNCiAgICAgICAgdmFyIGluc2VydEF0ID0gb2JqOw0KICAgICAgICB2YXIgcHVzaCA9IG5hbWUuZW5kc1dpdGgoIltdIik7DQogICAgICAgIGlmIChwdXNoKSB7DQogICAgICAgICAgbmFtZSA9IG5hbWUuc3Vic3RyKDAsIG5hbWUubGVuZ3RoIC0gMik7DQogICAgICAgICAgaWYgKG5hbWUgaW4gaW5zZXJ0QXQpIHsNCiAgICAgICAgICAgIGluc2VydEF0W25hbWVdID0gW107DQogICAgICAgICAgfQ0KICAgICAgICAgIGluc2VydEF0ID0gaW5zZXJ0QXRbbmFtZV07DQogICAgICAgICAgaWYgKHR5cGUgPT0gIkNIRUNLQk9YIikgew0KICAgICAgICAgICAgaW5zZXJ0QXQucHVzaChlbC5jaGVja2VkID8gdHJ1ZSA6IGZhbHNlKTsNCiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT0gIlJBRElPIikgew0KICAgICAgICAgICAgaWYgKGVsLmNoZWNrZWQpIHsNCiAgICAgICAgICAgICAgaW5zZXJ0QXQucHVzaChlbC52YWx1ZSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIGluc2VydEF0LnB1c2goZWwudmFsdWUpOw0KICAgICAgICAgIH0NCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBpZiAodHlwZSA9PSAiQ0hFQ0tCT1giKSB7DQogICAgICAgICAgICBpbnNlcnRBdFtuYW1lXSA9IGVsLmNoZWNrZWQgPyB0cnVlIDogZmFsc2U7DQogICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09ICJSQURJTyIpIHsNCiAgICAgICAgICAgIGlmIChlbC5jaGVja2VkKSB7DQogICAgICAgICAgICAgIGluc2VydEF0W25hbWVdID0gZWwudmFsdWU7DQogICAgICAgICAgICB9DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIGluc2VydEF0W25hbWVdID0gZWwudmFsdWU7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9DQogICAgfSBlbHNlIHsNCiAgICAgIGlmICgnY2hpbGRyZW4nIGluIGVsKSB7DQogICAgICAgIHZhciBhcnIgPSBlbC5jaGlsZHJlbjsNCiAgICAgICAgdmFyIG4gPSBhcnIubGVuZ3RoOw0KICAgICAgICBmb3IgKHZhciBrID0gMDsgayA8IG47IGsrKykgew0KICAgICAgICAgIHZhciBjaCA9IGVsLmNoaWxkcmVuW2tdOw0KICAgICAgICAgIGJ1aWxkX29iaihjaCwgb2JqKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCiAgfTsNCg0KICAvLyBIRUxQRVIgfCByZXR1cm4gYW4gb2JqZWN0IG9mIGFsbCB0aGUgaW5wdXRzIG9mIHRoZSBnaXZlbiBmb3JtIGVsZW1lbnQNCiAgdmFyIGdldF9mb3JtID0gZnVuY3Rpb24oZm9ybSkgew0KICAgIHZhciBvYmogPSB7fTsNCiAgICBidWlsZF9vYmooZm9ybSwgb2JqKTsNCiAgICByZXR1cm4gb2JqOw0KICB9Ow0KDQogIC8vIEhFTFBFUiB8IGNyZWF0ZSBhIHNpZ25hbCBmb3Igd2hlbiB0aGluZ3MgZmFpbDsgdGhpcyB3aWxsIHdyaXRlIGludG8gdGhlIHRoZSB2aWV3DQogIHZhciBtYWtlX2ZhaWx1cmVfc2lnbmFsID0gZnVuY3Rpb24oc3RhdGUsIGZhaWx1cmVWYXIpIHsNCiAgICByZXR1cm4gZnVuY3Rpb24oZmFpbCkgew0KICAgICAgdmFyIG9iaiA9IHt9Ow0KICAgICAgb2JqW2ZhaWx1cmVWYXJdID0gZmFpbDsNCiAgICAgIHZhciBkZWx0YSA9IHBhdGhfdG8oc2VsZi5wVihzdGF0ZSksIG9iaik7DQogICAgICBjb25zb2xlLmxvZyhkZWx0YSk7DQogICAgICBzdGF0ZS52aWV3LnRyZWUudXBkYXRlKGRlbHRhKTsNCiAgICB9Ow0KICB9Ow0KDQogIC8qKg0KIC8kJCQkJCQkJCAvJCQkJCQkICAvJCQkJCQkJCAgIC8kJCQkJCQgDQp8X18gICQkX18vLyQkX18gICQkfCAkJF9fICAkJCAvJCRfXyAgJCQNCiAgIHwgJCQgIHwgJCQgIFwgJCR8ICQkICBcICQkfCAkJCAgXCAkJA0KICAgfCAkJCAgfCAkJCAgfCAkJHwgJCQgIHwgJCR8ICQkICB8ICQkDQogICB8ICQkICB8ICQkICB8ICQkfCAkJCAgfCAkJHwgJCQgIHwgJCQNCiAgIHwgJCQgIHwgJCQgIHwgJCR8ICQkICB8ICQkfCAkJCAgfCAkJA0KICAgfCAkJCAgfCAgJCQkJCQkL3wgJCQkJCQkJC98ICAkJCQkJCQvDQogICB8X18vICAgXF9fX19fXy8gfF9fX19fX18vICBcX19fX19fLyANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICovDQogIA0KICAvLyBSVU5USU1FIHwgcmVnaXN0ZXIgdGhlIHBhZ2UgZm9yIHRoZSB1cmkgdG8gdGhlIGdpdmVuIGZvbygpLg0KICBzZWxmLlBHID0gZnVuY3Rpb24odXJpLCBmb28pIHsNCiAgICB2YXIgaGVhZCA9IHJvdXRlcjsNCiAgICBmb3IgKHZhciBrID0gMDsgayA8IHVyaS5sZW5ndGg7IGsrKykgew0KICAgICAgdmFyIHBhcnQgPSB1cmlba107DQogICAgICBpZiAoIShwYXJ0IGluIGhlYWQpKSB7DQogICAgICAgIGhlYWRbcGFydF0gPSB7fTsNCiAgICAgIH0NCiAgICAgIGhlYWQgPSBoZWFkW3BhcnRdOw0KICAgIH0NCiAgICBoZWFkWydAJ10gPSBmb287DQogIH07DQoNCiAgdmFyIHJvdXRlID0gZnVuY3Rpb24ocGFydHMsIGF0LCBoZWFkLCB2aWV3KSB7DQogICAgaWYgKGF0IDwgcGFydHMubGVuZ3RoKSB7DQogICAgICBpZiAoJ251bWJlcicgaW4gaGVhZCkgew0KICAgICAgICB2YXIgbmVjayA9IGhlYWRbJ251bWJlciddOw0KICAgICAgICB2YXIgdmFsID0gcGFyc2VGbG9hdChwYXJ0c1thdF0pOw0KICAgICAgICBpZiAoIWlzTmFOKHZhbCkpIHsNCiAgICAgICAgICBmb3IgKHZhciBicmFuY2ggaW4gbmVjaykgew0KICAgICAgICAgICAgdmlld1ticmFuY2hdID0gdmFsOw0KICAgICAgICAgICAgdmFyIGNhbmRpZGF0ZSA9IHJvdXRlKHBhcnRzLCBhdCArIDEsIG5lY2tbYnJhbmNoXSwgdmlldyk7DQogICAgICAgICAgICBpZiAoY2FuZGlkYXRlICE9PSBudWxsKSB7DQogICAgICAgICAgICAgIHJldHVybiBjYW5kaWRhdGU7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBkZWxldGUgdmlld1ticmFuY2hdOw0KICAgICAgICAgIH0NCiAgICAgICAgfTsNCiAgICAgIH0NCiAgICAgIGlmICgndGV4dCcgaW4gaGVhZCkgew0KICAgICAgICB2YXIgbmVjayA9IGhlYWRbJ3RleHQnXTsNCiAgICAgICAgdmFyIHZhbCA9IHBhcnRzW2F0XTsNCiAgICAgICAgZm9yICh2YXIgYnJhbmNoIGluIG5lY2spIHsNCiAgICAgICAgICB2aWV3W2JyYW5jaF0gPSB2YWw7DQogICAgICAgICAgdmFyIGNhbmRpZGF0ZSA9IHJvdXRlKHBhcnRzLCBhdCArIDEsIG5lY2tbYnJhbmNoXSwgdmlldyk7DQogICAgICAgICAgaWYgKGNhbmRpZGF0ZSAhPT0gbnVsbCkgew0KICAgICAgICAgICAgcmV0dXJuIGNhbmRpZGF0ZTsNCiAgICAgICAgICB9DQogICAgICAgICAgZGVsZXRlIHZpZXdbYnJhbmNoXTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgaWYgKCdmaXhlZCcgaW4gaGVhZCkgew0KICAgICAgICB2YXIgbmVjayA9IGhlYWRbJ2ZpeGVkJ107DQogICAgICAgIGZvciAodmFyIGJyYW5jaCBpbiBuZWNrKSB7DQogICAgICAgICAgaWYgKGJyYW5jaCA9PSBwYXJ0c1thdF0pIHsNCiAgICAgICAgICAgIHZhciBjYW5kaWRhdGUgPSByb3V0ZShwYXJ0cywgYXQgKyAxLCBuZWNrW2JyYW5jaF0sIHZpZXcpOw0KICAgICAgICAgICAgaWYgKGNhbmRpZGF0ZSAhPT0gbnVsbCkgew0KICAgICAgICAgICAgICByZXR1cm4gY2FuZGlkYXRlOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0gZWxzZSB7DQogICAgICBpZiAoJ0AnIGluIGhlYWQpIHsNCiAgICAgICAgcmV0dXJuIGhlYWRbJ0AnXTsNCiAgICAgIH0NCiAgICB9DQogIH07DQoNCiAgc2VsZi5nb3RvID0gZnVuY3Rpb24odmlld1N0YXRlLCB1cmkpIHsNCiAgICAvLyBUT0RPOiBmaWd1cmUgb3V0IGEgYmV0dGVyIG1vZGVsLg0KICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgew0KICAgICAgaWYgKHVyaS5zdGFydHNXaXRoKCIvIikpIHsNCiAgICAgICAgc2VsZi5ydW4oZG9jdW1lbnQuYm9keSwgdXJpLCB0cnVlKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gZml4SHJlZih1cmkpOw0KICAgICAgfQ0KICAgIH0sIDEwKTsNCiAgfTsNCg0KICBzZWxmLmluaXQgPSBmdW5jdGlvbigpIHsNCiAgICBzZWxmLnJ1bihkb2N1bWVudC5ib2R5LCBmaXhQYXRoKHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZSArIHdpbmRvdy5sb2NhdGlvbi5oYXNoKSwgZmFsc2UpOw0KICAgIHdpbmRvdy5vbnBvcHN0YXRlID0gZnVuY3Rpb24oKSB7DQogICAgICBjb25zb2xlLmxvZygicG9wc3RhdGU6IiArIGZpeFBhdGgod2luZG93LmxvY2F0aW9uLnBhdGhuYW1lKSk7DQogICAgICBzZWxmLnJ1bihkb2N1bWVudC5ib2R5LCBmaXhQYXRoKHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZSArIHdpbmRvdy5sb2NhdGlvbi5oYXNoKSwgZmFsc2UpOw0KICAgIH07DQogIH07DQoNCiAgLy8gQVBJIHwgUnVuIHRoZSBwYWdlIGluIHRoZSBnaXZlbiBwbGFjZQ0KICBzZWxmLnJ1biA9IGZ1bmN0aW9uKHdoZXJlLCBwYXRoLCBwdXNoKSB7DQogICAgZm9yIChjb25LZXkgaW4gY29ubmVjdGlvbnMpIHsNCiAgICAgIGNvbm5lY3Rpb25zW2NvbktleV0udHJlZS5udWtlKCk7DQogICAgfQ0KICAgIHZhciBwYXJ0cyA9IChwYXRoLnN0YXJ0c1dpdGgoIi8iKSA/IHBhdGguc3Vic3RyaW5nKDEpIDogcGF0aCkuc3BsaXQoIi8iKTsNCiAgICB2YXIgaW5pdCA9IHsnc2Vzc2lvbl9pZCc6IlIiICsgTWF0aC5yYW5kb20oKX07DQogICAgdmFyIGZvbyA9IHJvdXRlKHBhcnRzLCAwLCByb3V0ZXIsIGluaXQpOw0KICAgIGlmIChmb28gIT0gbnVsbCkgew0KICAgICAgbnVrZSh3aGVyZSk7DQogICAgICB2YXIgc3RhdGUgPSB7c2VydmljZTogY29ubmVjdGlvbiwgZGF0YTpudWxsLCB2aWV3OmZyZXNoKHdoZXJlKSwgY3VycmVudDondmlldyd9Ow0KICAgICAgZm9vKHdoZXJlLCBzdGF0ZSk7DQogICAgICBzdGF0ZS52aWV3LnRyZWUuc3Vic2NyaWJlKHN0YXRlLnZpZXcuZGVsdGEpOw0KICAgICAgc3RhdGUudmlldy50cmVlLnVwZGF0ZShpbml0KTsNCiAgICAgIGlmIChwdXNoKSB7DQogICAgICAgIHdpbmRvdy5oaXN0b3J5LnB1c2hTdGF0ZSh7fSwgJycsIGZpeEhyZWYocGF0aCkpOw0KICAgICAgfQ0KICAgIH0gZWxzZSB7DQogICAgICBpZiAocGF0aCAhPSAiLzQwNCIpIHsNCiAgICAgICAgc2VsZi5ydW4od2hlcmUsICIvNDA0Iik7DQogICAgICB9IGVsc2Ugew0KICAgICAgICAvLyBkZWZhdWx0IDQwNA0KICAgICAgfQ0KICAgIH0NCiAgfTsNCg0KICB2YXIgaWRlbnRpdGllcyA9IHt9Ow0KDQogIHNlbGYuU0lHTk9VVCA9IGZ1bmN0aW9uKCkgew0KICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCJpZGVudGl0eV9kZWZhdWx0Iik7DQogICAgc2VsZi5nb3RvKG51bGwsICcvJyk7DQogIH07DQoNCiAgc2VsZi5HT09HTEVfU0lHTl9PTiA9IGZ1bmN0aW9uKGFjY2Vzc1Rva2VuKSB7DQogICAgY29ubmVjdGlvbi5Jbml0Q29udmVydEdvb2dsZVVzZXIoYWNjZXNzVG9rZW4sIHsNCiAgICAgIHN1Y2Nlc3M6ZnVuY3Rpb24ocGF5bG9hZCkgew0KICAgICAgICBpZGVudGl0aWVzWydkZWZhdWx0J10gPSBwYXlsb2FkLmlkZW50aXR5Ow0KICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgiaWRlbnRpdHlfZGVmYXVsdCIsIHBheWxvYWQuaWRlbnRpdHkpOw0KICAgICAgICBzZWxmLmdvdG8obnVsbCwgJy8nKTsNCiAgICAgIH0sDQogICAgICBmYWlsdXJlOiBmdW5jdGlvbihyZWFzb24pIHsNCiAgICAgICAgY29uc29sZS5sb2coIkdvb2dsZSBmYWlsdXJlOiAiICtyZWFzb24pOw0KICAgICAgfQ0KICAgIH0pOw0KICB9Ow0KDQogIC8qKiBmb3IgY3VzdG9tIGVsZW1lbnRzIHRvIGxlYXJuIG9mIHRoZSBpZGVudGl0eSAqLw0KICBzZWxmLklEID0gZnVuY3Rpb24oaWRlbnRpdHlOYW1lLCByZWRpcmVjdFRvKSB7DQogICAgICAvLyBJRiBpZGVudGl0eSBjb250YWlucyBkb3RzDQogICAgICB2YXIgaWRlbnRpdHkgPSBudWxsOw0KICAgICAgdmFyIGNsZWFudXAgPSBmdW5jdGlvbigpIHt9Ow0KDQogICAgICB2YXIgdmFsID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oImlkZW50aXR5XyIgK2lkZW50aXR5TmFtZSk7DQogICAgICBpZiAodmFsKSB7DQogICAgICAgIGlkZW50aXRpZXNbaWRlbnRpdHlOYW1lXSA9IHZhbDsNCiAgICAgIH0NCg0KICAgICAgaWYgKGlkZW50aXR5TmFtZS5zdGFydHNXaXRoKCJkaXJlY3Q6IikpIHsNCiAgICAgICAgLy8gVXNlLCBhcyBpcw0KICAgICAgICBpZGVudGl0eSA9IGlkZW50aXR5TmFtZS5zdWJzdHIoNyk7DQogICAgICB9IGVsc2UgaWYgKGlkZW50aXR5TmFtZSBpbiBpZGVudGl0aWVzKSB7DQogICAgICAgIGlkZW50aXR5ID0gaWRlbnRpdGllc1tpZGVudGl0eU5hbWVdOw0KICAgICAgICBjbGVhbnVwID0gZnVuY3Rpb24oKSB7DQogICAgICAgICAgZGVsZXRlIGlkZW50aXRpZXNbaWRlbnRpdHlOYW1lXTsNCiAgICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgiaWRlbnRpdHlfIiArIGlkZW50aXR5TmFtZSk7DQogICAgICAgIH07DQogICAgICB9IGVsc2Ugew0KICAgICAgICAvLyB3aGF0ZXZlciBwYWdlIHdlIGFyZSwgbmVlZHMgdG8gZGllIHdoaWNoIG1lYW5zIHdlIG5lZWQgdG8gbnVrZSBldmVyeXRoaW5nIQ0KICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsNCiAgICAgICAgICAvLyBUT0RPOiB0aGlzIGFzc3VtZXMgYSBmdWxsIGFwcCBnb2VzIHRvIHRoZSB3aW5kb3cNCiAgICAgICAgICBzZWxmLmdvdG8obnVsbCwgcmVkaXJlY3RUbyk7DQogICAgICAgIH0sIDEwKTsNCiAgICAgICAgcmV0dXJuIHthYm9ydDp0cnVlfTsNCiAgICAgIH0NCg0KICAgICAgcmV0dXJuIHthYm9ydDpmYWxzZSwgY2xlYW51cDpjbGVhbnVwLCBpZGVudGl0eTppZGVudGl0eX07DQogIH07DQoNCiAgdmFyIGN1c3RvbURhdGFTb3VyY2VzID0ge307DQoNCiAgLyoqIHByb3ZpZGUgY3VzdG9tIGRhdGEgKi8NCiAgc2VsZi5QUkNVREEgPSBmdW5jdGlvbihuYW1lLCBmb28pIHsNCiAgICBjdXN0b21EYXRhU291cmNlc1tuYW1lXSA9IGZvbzsNCiAgfTsNCg0KICAvLyA8Y3VzdG9tZGF0YSBzcmM9c3JjIChwYXJhbWV0ZXI6eD15KSogPg0KICBzZWxmLkNVREEgPSBmdW5jdGlvbihwYXJlbnQsIHByaW9yU3RhdGUsIHNyYywgcnhvYmosIHJlZGlyZWN0VG8sIGNoaWxkTWFrZXIpIHsNCiAgICB2YXIgdW5zdWIgPSBtYWtlX3Vuc3ViKCk7DQogICAgcnhvYmouX18gPSBkZWJvdW5jZSgxMCwgZnVuY3Rpb24oKSB7DQogICAgICBmaXJlX3Vuc3ViKHVuc3ViKTsNCiAgICAgIG51a2UocGFyZW50KTsNCiAgICAgIHZhciBjdXN0b21UcmVlID0gZmFsc2U7DQogICAgICBpZiAoc3JjIGluIGN1c3RvbURhdGFTb3VyY2VzKSB7DQogICAgICAgIHZhciBjb25zID0gY3VzdG9tRGF0YVNvdXJjZXNbc3JjXTsNCiAgICAgICAgaWYgKHR5cGVvZihjb25zKT09J2Z1bmN0aW9uJykgew0KICAgICAgICAgIGN1c3RvbVRyZWUgPSBjb25zKHJ4b2JqLCBwcmlvclN0YXRlLCByZWRpcmVjdFRvLCBzZWxmKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgaWYgKCFjdXN0b21UcmVlKSB7DQogICAgICAgIGN1c3RvbVRyZWUgPSBuZXcgQWRhbWFUcmVlU2ltcGxlKCk7DQogICAgICB9DQogICAgICB2YXIgc3RhdGUgPSB7DQogICAgICAgIHNlcnZpY2U6IHByaW9yU3RhdGUuc2VydmljZSwNCiAgICAgICAgZGF0YToge2Nvbm5lY3Rpb246IHByaW9yU3RhdGUuY29ubmVjdGlvbiwgdHJlZTpjdXN0b21UcmVlLCBkZWx0YTp7fSwgcGFyZW50Om51bGwsIHBhdGg6bnVsbH0sDQogICAgICAgIHZpZXc6IG5ld19kZWx0YV9jb3B5KHByaW9yU3RhdGUudmlldyksDQogICAgICAgIGN1cnJlbnQ6J2RhdGEnDQogICAgICB9Ow0KICAgICAgY2hpbGRNYWtlcihzdGF0ZSk7DQogICAgICBzdWJzY3JpYmVfc3RhdGUoc3RhdGUsIHVuc3ViKTsNCiAgICB9KTsNCiAgfTsNCg0KICAvLyA8Y29ubmVjdGlvbiAuLi4+DQogIHNlbGYuQ09OTkVDVCA9IGZ1bmN0aW9uKHN0YXRlLCByeG9iaiwgaWRlbnRpdHlOYW1lLCByZWRpcmVjdFRvKSB7DQogICAgdmFyIHVuc3ViID0ge3ZpZXc6ZnVuY3Rpb24oKXt9fTsNCiAgICByeG9iai5fXyA9IGRlYm91bmNlKDEwLCBmdW5jdGlvbigpIHsNCiAgICAgIHZhciBjbyA9IGdldF9jb25uZWN0aW9uX29iaihyeG9iai5uYW1lKTsNCiAgICAgIHZhciBkZXNpcmVkID0gcnhvYmouc3BhY2UgKyAiLyIgKyByeG9iai5rZXk7DQoNCiAgICAgIHZhciBiaW5kID0gZnVuY3Rpb24oc2VuZE5vdykgew0KICAgICAgICB1bnN1Yi52aWV3ID0gc3RhdGUudmlldy50cmVlLnN1YnNjcmliZShmdW5jdGlvbigpIHsNCiAgICAgICAgICBpZiAoY28ucHRyID09IG51bGwpIHsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICB9DQogICAgICAgICAgY28ucHRyLnVwZGF0ZShzdGF0ZS52aWV3LnRyZWUuY29weSgpLCB7DQogICAgICAgICAgICBzdWNjZXNzOmZ1bmN0aW9uKCkge30sDQogICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbigpIHt9DQogICAgICAgICAgfSk7DQogICAgICAgIH0pOw0KICAgICAgICBpZiAoc2VuZE5vdykgew0KICAgICAgICAgIGNvbnNvbGUubG9nKHN0YXRlLnZpZXcudHJlZS5zdHIoKSk7DQogICAgICAgICAgY28ucHRyLnVwZGF0ZShzdGF0ZS52aWV3LnRyZWUuY29weSgpLCB7DQogICAgICAgICAgICBzdWNjZXNzOmZ1bmN0aW9uKCkge30sDQogICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbigpIHt9DQogICAgICAgICAgfSk7DQogICAgICAgIH0NCiAgICAgIH07DQoNCiAgICAgIGlmIChjby5wdHIgIT0gbnVsbCAmJiBjby5ib3VuZCA9PSBkZXNpcmVkKSB7DQogICAgICAgIGJpbmQodHJ1ZSk7DQogICAgICAgIHJldHVybjsNCiAgICAgIH0NCiAgICAgIGlmIChjby5wdHIgIT0gbnVsbCkgew0KICAgICAgICBjby5wdHIuZW5kKCk7DQogICAgICB9DQoNCiAgICAgIHZhciBpZExvb2t1cCA9IHNlbGYuSUQoaWRlbnRpdHlOYW1lLCByZWRpcmVjdFRvKTsNCiAgICAgIGlmIChpZExvb2t1cC5hYm9ydCkgew0KICAgICAgICByZXR1cm47DQogICAgICB9DQogICAgICB2YXIgaWRlbnRpdHkgPSBpZExvb2t1cC5pZGVudGl0eTsNCiAgICAgIHZhciBjbGVhbnVwID0gaWRMb29rdXAuY2xlYW51cDsNCiAgICAgIGNvLmJvdW5kID0gZGVzaXJlZDsNCg0KICAgICAgdW5zdWIudmlldygpOw0KICAgICAgdmFyIHZ3ID0gc3RhdGUudmlldy50cmVlLmNvcHkoKTsNCiAgICAgIGNvLnNwYWNlID0gcnhvYmouc3BhY2U7DQogICAgICBjby5rZXkgPSByeG9iai5rZXk7DQogICAgICBjby5wdHIgPSBjb25uZWN0aW9uLkNvbm5lY3Rpb25DcmVhdGUoaWRlbnRpdHksIHJ4b2JqLnNwYWNlLCByeG9iai5rZXksIHZ3LCB7DQogICAgICAgIG5leHQ6IGZ1bmN0aW9uKHBheWxvYWQpIHsNCiAgICAgICAgICBpZiAoJ2RhdGEnIGluIHBheWxvYWQuZGVsdGEpIHsNCiAgICAgICAgICAgIGNvLnRyZWUudXBkYXRlKHBheWxvYWQuZGVsdGEuZGF0YSk7DQogICAgICAgICAgfQ0KICAgICAgICAgIGlmICgnb3V0c3RhbmRpbmcnIGluIHBheWxvYWQuZGVsdGEpIHsNCiAgICAgICAgICAgIGNvLm9uZGVjaWRlKHBheWxvYWQuZGVsdGEub3V0c3RhbmRpbmcpOw0KICAgICAgICAgIH0NCiAgICAgICAgfSwNCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24ocmVhc29uKSB7DQogICAgICAgICAgLy8gVE9ETzogaWYgbm90IGF1dGhvcml6ZWQNCiAgICAgICAgICAvKg0KICAgICAgICAgIGlmIChmYWxzZSkgew0KICAgICAgICAgICAgY2xlYW51cCgpOw0KICAgICAgICAgIH0NCiAgICAgICAgICAqLw0KICAgICAgICAgIGNvLnB0ciA9IG51bGw7DQogICAgICAgICAgLy8gVE9ETzogc2NoZWR1bGUgYSByZXRyeT8gaW52b2tlOiAgcnhvYmouX18oKTsNCiAgICAgICAgfSwNCiAgICAgIH0pOw0KICAgICAgYmluZChmYWxzZSk7DQogICAgfSk7DQogIH07DQogIA0KICBzZWxmLklOVEVSTkFMID0gZnVuY3Rpb24ocHJpb3JTdGF0ZSkgew0KICAgIHJldHVybiB7DQogICAgICBzZXJ2aWNlOiBwcmlvclN0YXRlLnNlcnZpY2UsDQogICAgICBkYXRhOiB7Y29ubmVjdGlvbjogbnVsbCwgdHJlZTpuZXcgQWRhbWFUcmVlU2ltcGxlKCksIGRlbHRhOnt9LCBwYXJlbnQ6bnVsbCwgcGF0aDpudWxsfSwNCiAgICAgIHZpZXc6IG5ld19kZWx0YV9jb3B5KHByaW9yU3RhdGUudmlldyksDQogICAgICBjdXJyZW50OidkYXRhJw0KICAgIH07DQogIH07DQoNCiAgdmFyIHJlY2FsbF9lbWFpbCA9IGZ1bmN0aW9uKGVsKSB7DQogICAgaWYgKGVsLnRhZ05hbWUudG9VcHBlckNhc2UoKSA9PSAiSU5QVVQiKSB7DQogICAgICBpZiAoImVtYWlsIiA9PSBlbC50eXBlICYmICJlbWFpbCIgPT0gZWwubmFtZSkgew0KICAgICAgICBlbC52YWx1ZSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJlbWFpbF9yZW1lbWJlciIpOw0KICAgICAgfQ0KICAgIH0gZWxzZSB7DQogICAgICBpZiAoJ2NoaWxkcmVuJyBpbiBlbCkgew0KICAgICAgICB2YXIgYXJyID0gZWwuY2hpbGRyZW47DQogICAgICAgIHZhciBuID0gYXJyLmxlbmd0aDsNCiAgICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCBuOyBrKyspIHsNCiAgICAgICAgICByZWNhbGxfZW1haWwoZWwuY2hpbGRyZW5ba10pOw0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICB9Ow0KDQogIC8vIFJVTlRJTUUgfCByeDphY3Rpb249YWRhbWE6c2lnbi1pbg0KICBzZWxmLmFTTyA9IGZ1bmN0aW9uKGZvcm0sIHN0YXRlLCBpZGVudGl0eU5hbWUsIGZhaWx1cmVWYXIsIGZvcndhcmRUbykgew0KICAgIHZhciBzaWduYWwgPSBtYWtlX2ZhaWx1cmVfc2lnbmFsKHN0YXRlLCBmYWlsdXJlVmFyKTsNCiAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsNCiAgICAgIHJlY2FsbF9lbWFpbChmb3JtKTsNCiAgICB9LCAxKTsNCiAgICBmb3JtLm9uc3VibWl0ID0gZnVuY3Rpb24oZXZ0KSB7DQogICAgICBldnQucHJldmVudERlZmF1bHQoKTsNCiAgICAgIHZhciByZXEgPSBnZXRfZm9ybShmb3JtKTsNCiAgICAgIGlmIChyZXEucmVtZW1iZXIpIHsNCiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oImVtYWlsX3JlbWVtYmVyIiwgcmVxLmVtYWlsKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJlbWFpbF9yZW1lbWJlciIsICIiKTsNCiAgICAgIH0NCiAgICAgIGNvbm5lY3Rpb24uQWNjb3VudExvZ2luKHJlcS5lbWFpbCwgcmVxLnBhc3N3b3JkLCB7DQogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKHBheWxvYWQpIHsNCiAgICAgICAgICBzaWduYWwoZmFsc2UpOw0KICAgICAgICAgIGlkZW50aXRpZXNbaWRlbnRpdHlOYW1lXSA9IHBheWxvYWQuaWRlbnRpdHk7DQogICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oImlkZW50aXR5XyIgKyBpZGVudGl0eU5hbWUsIHBheWxvYWQuaWRlbnRpdHkpOw0KICAgICAgICAgIHNlbGYuZ290byhzdGF0ZS52aWV3LCBmb3J3YXJkVG8pOw0KICAgICAgICB9LA0KICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbihjb2RlKSB7DQogICAgICAgICAgc2lnbmFsKHRydWUpOw0KICAgICAgICAgIC8vIFRPRE86IHNvcnQgb3V0IGNvbnNvbGUgbG9nZ2luZw0KICAgICAgICAgIGNvbnNvbGUubG9nKCJGQUlMVVJFOiIgKyBjb2RlKTsNCiAgICAgICAgfQ0KICAgICAgfSk7DQogICAgfTsNCiAgfTsNCg0KICAvLyBSVU5USU1FIHwgcng6YWN0aW9uPWFkYW1hOnNpZ24tdXANCiAgc2VsZi5hU1UgPSBmdW5jdGlvbihmb3JtLCBzdGF0ZSwgZmFpbHVyZVZhciwgZm9yd2FyZFRvKSB7DQogICAgdmFyIHNpZ25hbCA9IG1ha2VfZmFpbHVyZV9zaWduYWwoc3RhdGUsIGZhaWx1cmVWYXIpOw0KICAgIGZvcm0ub25zdWJtaXQgPSBmdW5jdGlvbihldnQpIHsNCiAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpOw0KICAgICAgdmFyIHJlcSA9IGdldF9mb3JtKGZvcm0pOw0KICAgICAgY29ubmVjdGlvbi5Jbml0U2V0dXBBY2NvdW50KHJlcS5lbWFpbCwgew0KICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihwYXlsb2FkKSB7DQogICAgICAgICAgc2lnbmFsKGZhbHNlKTsNCiAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgiZW1haWwiLCByZXEuZW1haWwpOw0KICAgICAgICAgIHNlbGYuZ290byhzdGF0ZS52aWV3LCBmb3J3YXJkVG8pOw0KICAgICAgICB9LA0KICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbihjb2RlKSB7DQogICAgICAgICAgc2lnbmFsKHRydWUpOw0KICAgICAgICAgIGNvbnNvbGUubG9nKCJGQUlMVVJFOiIpOw0KICAgICAgICB9DQogICAgICB9KTsNCiAgICB9Ow0KICB9Ow0KDQogIC8vIFJVTlRJTUUgfCByeDphY3Rpb249YWRhbWE6c2V0LXBhc3N3b3JkDQogIHNlbGYuYVNQID0gZnVuY3Rpb24oZm9ybSwgc3RhdGUsIGZhaWx1cmVWYXIsIGZvcndhcmRUbykgew0KICAgIHZhciBzaWduYWwgPSBtYWtlX2ZhaWx1cmVfc2lnbmFsKHN0YXRlLCBmYWlsdXJlVmFyKTsNCiAgICBmb3JtLm9uc3VibWl0ID0gZnVuY3Rpb24oZXZ0KSB7DQogICAgICBldnQucHJldmVudERlZmF1bHQoKTsNCiAgICAgIHZhciByZXEgPSBnZXRfZm9ybShmb3JtKTsNCiAgICAgIGlmICghKCdlbWFpbCcgaW4gcmVxKSkgew0KICAgICAgICByZXEuZW1haWwgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnZW1haWwnKTsNCiAgICAgIH0NCiAgICAgIGNvbm5lY3Rpb24uSW5pdENvbXBsZXRlQWNjb3VudChyZXEuZW1haWwsIGZhbHNlLCByZXEuY29kZSwgew0KICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihpbml0KSB7DQogICAgICAgICAgY29uc29sZS5sb2coaW5pdCk7DQogICAgICAgICAgdmFyIGlkZW50aXR5ID0gaW5pdC5pZGVudGl0eTsNCiAgICAgICAgICBjb25uZWN0aW9uLkFjY291bnRTZXRQYXNzd29yZChpbml0LmlkZW50aXR5LCByZXEucGFzc3dvcmQsIHsNCiAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICBzaWduYWwoZmFsc2UpOw0KICAgICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgiaWRlbnRpdHlfZGVmYXVsdCIsIGlkZW50aXR5KTsNCiAgICAgICAgICAgICAgc2VsZi5nb3RvKHN0YXRlLnZpZXcsIGZvcndhcmRUbyk7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24ocmVhc29uKSB7DQogICAgICAgICAgICAgIHNpZ25hbCh0cnVlKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9KTsNCg0KICAgICAgICB9LA0KICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbihyZWFzb24pIHsNCiAgICAgICAgICBzaWduYWwodHJ1ZSk7DQogICAgICAgIH0NCiAgICAgIH0pOw0KICAgIH07DQogIH07DQogIA0KICAvLyBSVU5USU1FIHwgcng6YWN0aW9uPXNlbmQ6JGNoYW5uZWwNCiAgc2VsZi5hU0QgPSBmdW5jdGlvbihmb3JtLCBzdGF0ZSwgY2hhbm5lbCwgZmFpbHVyZVZhcikgew0KICAgIHZhciBzaWduYWwgPSBtYWtlX2ZhaWx1cmVfc2lnbmFsKHN0YXRlLCBmYWlsdXJlVmFyKTsNCiAgICBmb3JtLm9uc3VibWl0ID0gZnVuY3Rpb24oZXZ0KSB7DQogICAgICBldnQucHJldmVudERlZmF1bHQoKTsNCiAgICAgIHZhciBzdGFydCA9IHBlcmZvcm1hbmNlLm5vdygpOw0KICAgICAgc3RhdGUuZGF0YS5jb25uZWN0aW9uLnB0ci5zZW5kKGNoYW5uZWwsIGdldF9mb3JtKGZvcm0pLCB7DQogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKHBheWxvYWQpIHsNCiAgICAgICAgICBzaWduYWwoZmFsc2UpOw0KICAgICAgICAgIGNvbnNvbGUubG9nKCJTdWNjZXNzfCIgKyBwYXlsb2FkLnNlcSArICI7bGF0ZW5jeT0iICsgKHBlcmZvcm1hbmNlLm5vdygpIC0gc3RhcnQpKTsgLy8gVE9ETzogZ3JhcGggaXQNCiAgICAgICAgfSwNCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24ocmVhc29uKSB7DQogICAgICAgICAgc2lnbmFsKHRydWUpOw0KICAgICAgICAgIGNvbnNvbGUubG9nKCJGQUlMVVJFIFRPIFNFTkQ6ICIgKyByZWFzb24pOyAvLyBUT0RPOiBsb2cgaXQNCiAgICAgICAgfQ0KICAgICAgfSk7DQogICAgfTsNCiAgfTsNCg0KICB3aW5kb3cucnhodG1sID0gc2VsZjsNCiAgcmV0dXJuIHNlbGY7DQp9KSgpOw==");
}
