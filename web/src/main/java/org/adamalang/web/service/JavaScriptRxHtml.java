/*
 * This file is subject to the terms and conditions outlined in the file 'LICENSE' (hint: it's MIT); this file is located in the root directory near the README.md which you should also read.
 *
 * This file is part of the 'Adama' project which is a programming language and document store for board games; however, it can be so much more.
 *
 * See https://www.adama-platform.com/ for more information.
 *
 * (c) 2020 - 2022 by Jeffrey M. Barber ( http://jeffrey.io )
 */
package org.adamalang.web.service;

import java.util.Base64;

public class JavaScriptRxHtml {
  public static final byte[] RXHTML_JS_BYTES = Base64.getDecoder().decode("dmFyIFJ4SFRNTCA9IChmdW5jdGlvbiAoKSB7DQogIHZhciBzZWxmID0ge307DQoNCiAgdmFyIHRlbXBsYXRlcyA9IHt9Ow0KICB2YXIgcm91dGVyID0ge307DQogIHZhciBjb25uZWN0aW9uID0gbmV3IEFkYW1hLkNvbm5lY3Rpb24oQWRhbWEuUHJvZHVjdGlvbik7DQogIHZhciBjb25uZWN0aW9ucyA9IHt9Ow0KDQogIGNvbm5lY3Rpb24uc3RhcnQoKTsNCg0KICB2YXIgZ2V0X2Nvbm5lY3Rpb25fb2JqID0gZnVuY3Rpb24obmFtZSkgew0KICAgIGlmIChuYW1lIGluIGNvbm5lY3Rpb25zKSB7DQogICAgICByZXR1cm4gY29ubmVjdGlvbnNbbmFtZV07DQogICAgfSBlbHNlIHsNCiAgICAgIHZhciBvYmogPSB7DQogICAgICAgIG5hbWU6IG5hbWUsDQogICAgICAgIHB0cjogbnVsbCwNCiAgICAgICAgdHJlZTogbmV3IEFkYW1hVHJlZVNpbXBsZSgpLA0KICAgICAgICBvdXRzdGFuZGluZzoge30sDQogICAgICAgIGRlY2lzaW9uczoge30sDQogICAgICAgIGlkOjANCiAgICAgIH07DQogICAgICBvYmouc3Vic2NyaWJlID0gZnVuY3Rpb24oY2hhbm5lbCwgY2FsbGJhY2spIHsNCiAgICAgICAgdmFyIHMgPSBjaGFubmVsICsgInwiICsgdGhpcy5pZCsrOw0KICAgICAgICB0aGlzLmRlY2lzaW9uc1tzXSA9IGNhbGxiYWNrOw0KICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7DQogICAgICAgICAgZGVsZXRlIHRoaXMuZGVjaXNpb25zW3NdOw0KICAgICAgICB9LmJpbmQodGhpcyk7DQogICAgICB9LmJpbmQob2JqKTsNCiAgICAgIG9iai5vbmRlY2lkZSA9IGZ1bmN0aW9uKG91dHN0YW5kaW5nKSB7DQogICAgICAgIGZvciAodmFyIGNoIGluIG9iai5vdXRzdGFuZGluZykgew0KICAgICAgICAgIG9iai5vdXRzdGFuZGluZ1tjaF0gPSB7b3B0aW9uczpbXX07DQogICAgICAgIH0NCiAgICAgICAgdmFyIG4gPSBvdXRzdGFuZGluZy5sZW5ndGg7DQogICAgICAgIGZvciAodmFyIGsgPSAwOyBrIDwgbjsgaysrKSB7DQogICAgICAgICAgdmFyIG8gPSBvdXRzdGFuZGluZ1trXTsNCiAgICAgICAgICBvYmoub3V0c3RhbmRpbmdbby5jaGFubmVsXSA9IG87DQogICAgICAgIH0NCiAgICAgICAgZm9yICh2YXIgY2ggaW4gb2JqLm91dHN0YW5kaW5nKSB7DQogICAgICAgICAgZm9yICh2YXIgc3ViIGluIG9iai5kZWNpc2lvbnMpIHsNCiAgICAgICAgICAgIGlmIChzdWIuc3RhcnRzV2l0aChjaCArICJ8IikpIHsNCiAgICAgICAgICAgICAgb2JqLmRlY2lzaW9uc1tzdWJdKCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9Ow0KICAgICAgY29ubmVjdGlvbnNbbmFtZV0gPSBvYmo7DQogICAgICByZXR1cm4gb2JqOw0KICAgIH0NCiAgfTsNCg0KICBzZWxmLm1ha2UgPSBmdW5jdGlvbigpIHsNCiAgICByZXR1cm4gbmV3IEFkYW1hVHJlZVNpbXBsZSgpOw0KICB9Ow0KDQogIC8vIEhFTFBFUiB8IHN1YnNjcmliZSB0aGUgZ2l2ZW4gJ3N1YicgdG8gY2hhbmdlcyB3aXRoaW4gc3RhdGUgZm9yIHRoZSBnaXZlbiBmaWVsZCBuYW1lZCBuYW1lDQogIHZhciBzdWJzY3JpYmUgPSBmdW5jdGlvbihzdGF0ZSwgbmFtZSwgc3ViKSB7DQogICAgdmFyIHNzID0gc2VsZi5wSShzdGF0ZSwgbmFtZSk7DQogICAgdmFyIHMgPSBzc1tzcy5jdXJyZW50XTsNCiAgICBpZiAoJ0BlJyBpbiBzLmRlbHRhKSB7DQogICAgICBzLmRlbHRhWydAZSddLnB1c2goc3ViKTsNCiAgICB9IGVsc2Ugew0KICAgICAgcy5kZWx0YVsnQGUnXSA9IFtzdWJdOw0KICAgIH0NCiAgfTsNCg0KICAvLyBIRUxQRVIgfCBjcmVhdGUgZnJlc2ggc3RhdGUNCiAgdmFyIGZyZXNoID0gZnVuY3Rpb24od2hlcmUpIHsNCiAgICByZXR1cm4gew0KICAgICAgdHJlZTpuZXcgQWRhbWFUcmVlU2ltcGxlKCksDQogICAgICBkZWx0YTp7fSwNCiAgICAgIHBhcmVudDpudWxsLA0KICAgICAgcGF0aDpudWxsLA0KICAgICAgd2hlcmU6d2hlcmUNCiAgICB9Ow0KICB9Ow0KDQogIC8vIEhFTFBFUiB8IGNyZWF0ZSBhIG5ldyBkZWx0YSBjb3B5IGZyb20gdGhlIGdpdmVuIHNwZWNpZmljIHN0YXRlIChpLmUuIGVpdGhlciBkYXRhIG9yIHZpZXcpDQogIHZhciBuZXdfZGVsdGFfY29weSA9IGZ1bmN0aW9uKHNzKSB7DQogICAgaWYgKHNzID09IG51bGwpIHsNCiAgICAgIHJldHVybiBudWxsOw0KICAgIH0NCiAgICB2YXIgcGFyZW50ID0gbnVsbDsNCiAgICBpZiAoc3MucGFyZW50ICE9IG51bGwpIHsNCiAgICAgIHBhcmVudCA9IG5ld19kZWx0YV9jb3B5KHNzLnBhcmVudCk7DQogICAgfQ0KICAgIHZhciBuZXdfZGVsdGEgPSB7fTsNCiAgICBpZiAocGFyZW50ICE9IG51bGwpIHsNCiAgICAgIHBhcmVudC5kZWx0YVtzcy5wYXRoXSA9IG5ld19kZWx0YTsNCiAgICB9DQogICAgcmV0dXJuIHt0cmVlOnNzLnRyZWUsIHBhcmVudDpwYXJlbnQsIGRlbHRhOm5ld19kZWx0YSwgcGF0aDpzcy5wYXRofTsNCiAgfTsNCg0KICAvLyBIRUxQRVIgfCBjb25zdHJ1Y3QgYSBwYXRoIHRvDQogIHZhciBwYXRoX3RvID0gZnVuY3Rpb24oc3MsIG9iaikgew0KICAgIGlmIChzcy5wYXJlbnQgIT0gbnVsbCkgew0KICAgICAgdmFyIHBhcmVudCA9IHBhdGhfdG8oc3MucGFyZW50LCB7fSk7DQogICAgICBwYXJlbnRbc3MucGF0aF0gPSBvYmo7DQogICAgICByZXR1cm4gcGFyZW50Ow0KICAgIH0gZWxzZSB7DQogICAgICByZXR1cm4gb2JqOw0KICAgIH0NCiAgfTsNCg0KICAvLyBIRUxQRVIgfCBnZXQgdGhlIHJvb3Qgb2YgdGhlIHNwZWNpZmljIHN0YXRlIChpLmUuIGVpdGhlciB0aGUgZGF0YSdzIHJvb3Qgb3IgdGhlIHZpZXcncyByb290KQ0KICB2YXIgcm9vdF9vZiA9IGZ1bmN0aW9uKHNzKSB7DQogICAgdmFyIHggPSBzczsNCiAgICB3aGlsZSAoeC5wYXJlbnQgIT0gbnVsbCkgew0KICAgICAgeCA9IHgucGFyZW50Ow0KICAgIH0NCiAgICByZXR1cm4geDsNCiAgfQ0KDQogIC8vIEhFTFBFUiB8IHJlbW92ZSBhbGwgdGhlIGNoaWxkcmVuIGZyb20gdGhlIGdpdmVuIERPTSBub2RlDQogIHZhciBudWtlID0gZnVuY3Rpb24ocGFyZW50KSB7DQogICAgdmFyIGxhc3QgPSBwYXJlbnQubGFzdENoaWxkOyANCiAgICB3aGlsZSAobGFzdCkgew0KICAgICAgcGFyZW50LnJlbW92ZUNoaWxkKGxhc3QpOw0KICAgICAgbGFzdCA9IHBhcmVudC5sYXN0Q2hpbGQ7DQogICAgfQ0KICB9Ow0KDQogIC8vIEhFTFBFUjogZGVib3VuY2UgdGhlIGdpdmVuIGZ1bmN0aW9uYWwgd2hlbiByYXBpZCBmdW5jdGlvbiBzcHJlYWQgaXMgZXhwZWN0ZWQNCiAgdmFyIGRlYm91bmNlID0gZnVuY3Rpb24obXMsIGZvbykgew0KICAgIHZhciBzdGF0dXMgPSB7aW5mbGlnaHQ6ZmFsc2UsIHRpbWVvdXQ6bnVsbH07DQogICAgc3RhdHVzLmluZmxpZ2h0ID0gZmFsc2U7DQogICAgcmV0dXJuIGZ1bmN0aW9uKCkgew0KICAgICAgaWYgKCFzdGF0dXMuaW5mbGlnaHQpIHsNCiAgICAgICAgc3RhdHVzLmluZmxpZ2h0ID0gdHJ1ZTsNCiAgICAgICAgc3RhdHVzLnRpbWVvdXQgPSB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsNCiAgICAgICAgICBzdGF0dXMuaW5mbGlnaHQgPSBmYWxzZTsNCiAgICAgICAgICBzdGF0dXMudGltZW91dCA9IG51bGw7DQogICAgICAgICAgZm9vKCk7DQogICAgICAgIH0sIG1zIC8qIG1zICovKTsgLy8gZGVib3VuY2UgdGhlIHBhcmFtZXRlcnMNCiAgICAgIH0NCiAgICB9Ow0KICB9Ow0KDQogIC8vIEhFTFBFUiB8IHByZXBhcmUgYSBmcmVlIHVuc3Vic2NyaWJlIG9iamVjdA0KICB2YXIgbWFrZV91bnN1YiA9IGZ1bmN0aW9uKCkgew0KICAgIHJldHVybiB7X19kYXRhOiBmdW5jdGlvbigpIHt9LCBfX3ZpZXc6IGZ1bmN0aW9uKCkge319Ow0KICB9Ow0KDQogIC8vIEhFTFBFUiB8IGF1Z21lbnQgYW4gZXhpc3Rpbmcgb2JqZWN0IHdpdGggdW5zdWJzY3JpYmUgZGF0YQ0KICB2YXIgYWRkX3Vuc3ViID0gZnVuY3Rpb24ob2JqKSB7DQogICAgb2JqLl9fZGF0YSA9IGZ1bmN0aW9uKCkge307DQogICAgb2JqLl9fdmlldyA9IGZ1bmN0aW9uKCkge307DQogIH0NCg0KICAvLyBIRUxQRVIgfCBmaXJlIHRoZSB1bnN1YnNjcmliZSBjYWxscyB3aXRoaW4gYW4gb2JqZWN0DQogIHZhciBmaXJlX3Vuc3ViID0gZnVuY3Rpb24odW5zdWIpIHsNCiAgICB1bnN1Yi5fX2RhdGEoKTsNCiAgICB1bnN1Yi5fX3ZpZXcoKTsNCiAgfQ0KDQogIC8vIEhFTFBFUiB8IHN1YnNjcmliZSB0byBzdGF0ZSBhbmQgcG9wdWxhdGUgdW5zdWJzY3JpYmUgb2JqZWN0DQogIHZhciBzdWJzY3JpYmVfc3RhdGUgPSBmdW5jdGlvbihzdGF0ZSwgdW5zdWIpIHsNCiAgICBpZiAoc3RhdGUuZGF0YSAhPSBudWxsKSB7DQogICAgICB1bnN1Yi5fX2RhdGEgPSBzdGF0ZS5kYXRhLnRyZWUuc3Vic2NyaWJlKHJvb3Rfb2Yoc3RhdGUuZGF0YSkuZGVsdGEpOw0KICAgIH0gZWxzZSB7DQogICAgICB1bnN1Yi5fX2RhdGEgPSBmdW5jdGlvbigpIHt9Ow0KICAgIH0NCiAgICBpZiAoc3RhdGUudmlldyAhPSBudWxsKSB7DQogICAgICB1bnN1Yi5fX3ZpZXcgPSBzdGF0ZS52aWV3LnRyZWUuc3Vic2NyaWJlKHJvb3Rfb2Yoc3RhdGUudmlldykuZGVsdGEpOyANCiAgICB9IGVsc2Ugew0KICAgICAgdW5zdWIuX192aWV3ID0gZnVuY3Rpb24oKSB7fTsNCiAgICB9DQogIH07DQoNCiAgdmFyIHN1YnNjcmliZV92aWV3ID0gZnVuY3Rpb24oc3RhdGUsIHVuc3ViKSB7DQogICAgaWYgKHN0YXRlLnZpZXcgIT0gbnVsbCkgew0KICAgICAgdW5zdWIuX192aWV3ID0gc3RhdGUudmlldy50cmVlLnN1YnNjcmliZShyb290X29mKHN0YXRlLnZpZXcpLmRlbHRhKTsgDQogICAgfSBlbHNlIHsNCiAgICAgIHVuc3ViLl9fdmlldyA9IGZ1bmN0aW9uKCkge307DQogICAgfQ0KICB9Ow0KDQogIC8vIFJVTlRJTUUgfCBTd2l0Y2ggdG8gdGhlIHZpZXcgb2JqZWN0DQogIHNlbGYucFYgPSBmdW5jdGlvbihzdGF0ZSkgew0KICAgIHJldHVybiB7c2VydmljZTpzdGF0ZS5zZXJ2aWNlLCBkYXRhOnN0YXRlLmRhdGEsIHZpZXc6c3RhdGUudmlldywgY3VycmVudDondmlldyd9Ow0KICB9Ow0KDQogIC8vIFJVTlRJTUUgfCBTd2l0Y2ggdG8gdGhlIGRhdGEgb2JqZWN0DQogIHNlbGYucEQgPSBmdW5jdGlvbihzdGF0ZSkgew0KICAgIHJldHVybiB7c2VydmljZTogc3RhdGUuc2VydmljZSwgZGF0YTpzdGF0ZS5kYXRhLCB2aWV3OnN0YXRlLnZpZXcsIGN1cnJlbnQ6J2RhdGEnfTsNCiAgfTsNCg0KICAvLyBSVU5USU1FIHwgU3dpdGNoIHRvIHRoZSByb290IG9iamVjdCAvIChSb290KQ0KICBzZWxmLnBSID0gZnVuY3Rpb24oc3RhdGUpIHsNCiAgICB2YXIgbmV4dCA9IHtzZXJ2aWNlOiBzdGF0ZS5zZXJ2aWNlLCBkYXRhOnN0YXRlLmRhdGEsIHZpZXc6c3RhdGUudmlldywgY3VycmVudDpzdGF0ZS5jdXJyZW50fTsNCiAgICB2YXIgcHJpb3IgPSBuZXh0W3N0YXRlLmN1cnJlbnRdOw0KICAgIHdoaWxlIChwcmlvci5wYXJlbnQgIT0gbnVsbCkgew0KICAgICAgaWYgKHByaW9yLnBhcmVudCA9PSBudWxsKSB7DQogICAgICAgIG5leHRbc3RhdGUuY3VycmVudF0NCiAgICAgICAgcmV0dXJuIHByaW9yOw0KICAgICAgfQ0KICAgICAgcHJpb3IgPSBwcmlvci5wYXJlbnQ7DQogICAgfQ0KICAgIG5leHRbc3RhdGUuY3VycmVudF0gPSBwcmlvcjsNCiAgICByZXR1cm4gbmV4dDsNCiAgfTsNCg0KICAvLyBSVU5USU1FIHwgLi4vIChVcCkNCiAgc2VsZi5wVSA9IGZ1bmN0aW9uKHN0YXRlKSB7DQogICAgdmFyIG5leHQgPSB7c2VydmljZTogc3RhdGUuc2VydmljZSwgZGF0YTpzdGF0ZS5kYXRhLCB2aWV3OnN0YXRlLnZpZXcsIGN1cnJlbnQ6c3RhdGUuY3VycmVudH07DQogICAgdmFyIHByaW9yID0gbmV4dFtzdGF0ZS5jdXJyZW50XTsNCiAgICBpZiAocHJpb3IucGFyZW50ICE9IG51bGwpIHsNCiAgICAgIG5leHRbc3RhdGUuY3VycmVudF0gPSBwcmlvcjsNCiAgICB9DQogICAgcmV0dXJuIG5leHQ7DQogIH07DQoNCiAgLy8gUlVOVElNRSB8IGRpdmUgb25lIGxldmVsIEludG8gcGF0aDEvcGF0aDIvLi4uLi9wYXRoTg0KICBzZWxmLnBJID0gZnVuY3Rpb24oc3RhdGUsIG5hbWUpIHsNCiAgICB2YXIgcHJpb3IgPSBzdGF0ZVtzdGF0ZS5jdXJyZW50XTsNCiAgICBpZiAoIShuYW1lIGluIHByaW9yLmRlbHRhKSkgew0KICAgICAgcHJpb3IuZGVsdGFbbmFtZV0gPSB7fTsNCiAgICB9DQogICAgdmFyIG5leHQgPSB7c2VydmljZTogc3RhdGUuc2VydmljZSwgZGF0YTpzdGF0ZS5kYXRhLCB2aWV3OnN0YXRlLnZpZXcsIGN1cnJlbnQ6c3RhdGUuY3VycmVudH07DQogICAgbmV4dFtzdGF0ZS5jdXJyZW50XSA9IHsNCiAgICAgIHRyZWU6cHJpb3IudHJlZSwNCiAgICAgIGRlbHRhOnByaW9yLmRlbHRhW25hbWVdLA0KICAgICAgcGFyZW50OnByaW9yLA0KICAgICAgcGF0aDpuYW1lLA0KICAgIH07DQogICAgaWYgKG5leHQuY3VycmVudCA9PSAiZGF0YSIpIHsNCiAgICAgIG5leHQuZGF0YS5jb25uZWN0aW9uID0gcHJpb3IuY29ubmVjdGlvbjsNCiAgICB9DQogICAgcmV0dXJuIG5leHQ7DQogIH07DQoNCiAgLy8gUlVOVElNRSB8IGV4dGVuZCB0aGUgZ2l2ZW4gc3RhdGUgd2l0aCB0aGUgdmlldyBoYXZpbmcgYSBzZXBlcmF0ZSBjaGlsZA0KICBzZWxmLnBFViA9IGZ1bmN0aW9uKHN0YXRlLCBuYW1lKSB7DQogICAgaWYgKCEobmFtZSBpbiBzdGF0ZS52aWV3LmRlbHRhKSkgew0KICAgICAgc3RhdGUudmlldy5kZWx0YVtuYW1lXSA9IHt9Ow0KICAgIH0NCiAgICByZXR1cm4gew0KICAgICAgc2VydmljZTogc3RhdGUuc2VydmljZSwNCiAgICAgIGRhdGE6IHN0YXRlLmRhdGEsDQogICAgICB2aWV3OiB7DQogICAgICAgIHRyZWU6c3RhdGUudmlldy50cmVlLA0KICAgICAgICBkZWx0YTpzdGF0ZS52aWV3LmRlbHRhW25hbWVdLA0KICAgICAgICBwYXJlbnQ6c3RhdGUudmlldywNCiAgICAgICAgcGF0aDpuYW1lLA0KICAgICAgfSwNCiAgICAgIGN1cnJlbnQ6c3RhdGUuY3VycmVudA0KICAgIH07DQogIH07DQoNCiAgdmFyIGZvcmsgPSBmdW5jdGlvbihwcmlvclN0YXRlKSB7DQogICAgdmFyIHN0YXRlID0gew0KICAgICAgc2VydmljZTogcHJpb3JTdGF0ZS5zZXJ2aWNlLA0KICAgICAgZGF0YTogbmV3X2RlbHRhX2NvcHkocHJpb3JTdGF0ZS5kYXRhKSwNCiAgICAgIHZpZXc6IG5ld19kZWx0YV9jb3B5KHByaW9yU3RhdGUudmlldyksDQogICAgICBjdXJyZW50OnByaW9yU3RhdGUuY3VycmVudA0KICAgIH07DQogICAgaWYgKHN0YXRlLmRhdGEgIT0gbnVsbCkgew0KICAgICAgc3RhdGUuZGF0YS5jb25uZWN0aW9uID0gcHJpb3JTdGF0ZS5kYXRhLmNvbm5lY3Rpb247DQogICAgfQ0KICAgIHJldHVybiBzdGF0ZTsNCiAgfQ0KDQogIC8vIFJVTlRJTUUgfCBzdWJzY3JpYmUgYmV0d2VlbiB0aGUgc3RhdGUgYW5kIHRoZSBvYmplY3QuDQogIC8vIFdoZW4gdGhlIG1lbWJlciBmaWVsZCB3aXRoaW4gc3RhdGUgb2YgbmFtZSBjaGFuZ2VzLCBjb3B5IHRoYXQgdmFsdWUgaW50byB0aGUgb2JqIGFuZCBydW4gcmVjb21wdXRlKCkNCiAgc2VsZi5ZID0gZnVuY3Rpb24oc3RhdGUsIG9iaiwgbmFtZSwgcmVjb21wdXRlKSB7DQogICAgdmFyIHN1YiA9IGZ1bmN0aW9uKHZhbHVlKSB7DQogICAgICBvYmpbbmFtZV0gPSB2YWx1ZTsNCiAgICAgIHJlY29tcHV0ZSgpOw0KICAgIH07DQogICAgc3Vic2NyaWJlKHN0YXRlLCBuYW1lLCBzdWIpOw0KICB9Ow0KDQogIC8vIFJVTlRJTUUgfCBKdXN0IHN1YnNjcmliZWUgdmFsdWUgdG8gdGhlIG9iamVjdCBmaWVsZCBvZiBuYW1lIChuby1yZWNvbXB1dGUpDQogIHNlbGYuWVMgPSBmdW5jdGlvbihzdGF0ZSwgb2JqLCBuYW1lKSB7DQogICAgdmFyIHN1YiA9IGZ1bmN0aW9uKHZhbHVlKSB7DQogICAgICBvYmpbbmFtZV0gPSB2YWx1ZTsNCiAgICB9Ow0KICAgIHN1YnNjcmliZShzdGF0ZSwgbmFtZSwgc3ViKTsNCiAgfTsNCg0KICAvLyBSVU5USU1FIHwgIlRleHQiDQogIHNlbGYuVCA9IGZ1bmN0aW9uKHR4KSB7DQogICAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHR4KTsNCiAgfTsNCg0KICAvLyBSVU5USU1FIHwgPGxvb2t1cCBwYXRoPS4uLj4NCiAgc2VsZi5MID0gZnVuY3Rpb24oc3RhdGUsIG5hbWUpIHsNCiAgICB2YXIgZG9tID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIiIpOw0KICAgIHZhciBzdWIgPSBmdW5jdGlvbih2YWx1ZSkgeyBkb20ubm9kZVZhbHVlID0gdmFsdWU7IH07DQogICAgc3Vic2NyaWJlKHN0YXRlLCBuYW1lLCBzdWIpOw0KICAgIHJldHVybiBkb207DQogIH07DQoNCiAgLy8gUlVOVElNRSB8IDxsb29rdXAgcGF0aD0uLi4gdHJhbnNmb3JtPSIkdHJhbnNmb3JtIiAvPg0KICBzZWxmLkxUID0gZnVuY3Rpb24oc3RhdGUsIG5hbWUsIHRyYW5zZm9ybSkgew0KICAgIHZhciBkb20gPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgiIik7DQogICAgdmFyIHN1YiA9IGZ1bmN0aW9uKHZhbHVlKSB7IGRvbS5ub2RlVmFsdWUgPSB0cmFuc2Zvcm0odmFsdWUpOyB9Ow0KICAgIHN1YnNjcmliZShzdGF0ZSwgbmFtZSwgc3ViKTsNCiAgICByZXR1cm4gZG9tOw0KICB9Ow0KDQogIC8vIFJVTlRJTUUgfCA8dGFnPg0KICBzZWxmLkUgPSBmdW5jdGlvbih0YWcsIG5zKSB7DQogICAgaWYgKG5zID09IHVuZGVmaW5lZCB8fCBucyA9PSBudWxsKSB7DQogICAgICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWcpOw0KICAgIH0gZWxzZSB7DQogICAgICB2YXIgcmVzdWx0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKG5zLCB0YWcpOw0KICAgICAgcmVzdWx0LnNldEF0dHJpYnV0ZSgneG1sbnMnLCBucyk7DQogICAgICByZXR1cm4gcmVzdWx0Ow0KICAgIH0NCiAgfTsNCg0KICAvLyBSVU5USU1FIHwgPHBpY2sgbmFtZT0uLi4+DQogIHNlbGYuUCA9IGZ1bmN0aW9uKHBhcmVudCwgcHJpb3JTdGF0ZSwgcnhPYmosIGNoaWxkTWFrZXIpIHsNCiAgICB2YXIgdW5zdWIgPSBtYWtlX3Vuc3ViKCk7DQogICAgcnhPYmouX18gPSBmdW5jdGlvbigpIHsNCiAgICAgIGlmICh0aGlzLm5hbWUgPT0gcnhPYmoubmFtZSkgeyByZXR1cm47IH0NCiAgICAgIGZpcmVfdW5zdWIodW5zdWIpOw0KICAgICAgdGhpcy5uYW1lID0gcnhPYmoubmFtZTsNCiAgICAgIHZhciBjbyA9IGdldF9jb25uZWN0aW9uX29iaihyeE9iai5uYW1lKTsNCiAgICAgIG51a2UocGFyZW50KTsNCiAgICAgIHZhciBzdGF0ZSA9IHsNCiAgICAgICAgc2VydmljZTogcHJpb3JTdGF0ZS5zZXJ2aWNlLA0KICAgICAgICBkYXRhOiB7Y29ubmVjdGlvbjogY28sIHRyZWU6Y28udHJlZSwgZGVsdGE6e30sIHBhcmVudDpudWxsLCBwYXRoOm51bGx9LA0KICAgICAgICB2aWV3OiBuZXdfZGVsdGFfY29weShwcmlvclN0YXRlLnZpZXcpLA0KICAgICAgICBjdXJyZW50OidkYXRhJw0KICAgICAgfTsNCiAgICAgIGNoaWxkTWFrZXIoc3RhdGUpOw0KICAgICAgc3Vic2NyaWJlX3N0YXRlKHN0YXRlLCB1bnN1Yik7DQogICAgfS5iaW5kKHtuYW1lOiIifSk7DQogIH07DQoNCiAgLy8gUlVOVElNRSB8IDx0ZW1wbGF0ZSBuYW1lPSIuLi4iPg0KICBzZWxmLlRQID0gZnVuY3Rpb24obmFtZSwgZm9vKSB7DQogICAgdGVtcGxhdGVzW25hbWVdID0gZm9vOw0KICB9Ow0KDQogIC8vIFJVTlRJTUUgfCA8dGFnIHJ4OnRlbXBsYXRlPSRuYW1lPg0KICBzZWxmLlVUID0gZnVuY3Rpb24ocGFyZW50LCBzdGF0ZSwgbmFtZSwgY2hpbGRfbWFrZXIpIHsNCiAgICB2YXIgZm9vID0gdGVtcGxhdGVzW25hbWVdOw0KICAgIGZvbyhwYXJlbnQsIHN0YXRlLCBjaGlsZF9tYWtlcik7DQogIH07DQoNCiAgLy8gUlVOVElNRSB8IDx0YWcgcng6c3dpdGNoPXBhdGggLi4+DQogIHNlbGYuU1cgPSBmdW5jdGlvbihwYXJlbnQsIHByaW9yU3RhdGUsIG5hbWUsIGNoaWxkcmVuTWFrZXIpIHsNCiAgICB2YXIgc3dzdCA9IHtwcmlvcjpudWxsfTsNCiAgICBhZGRfdW5zdWIoc3dzdCk7DQogICAgdmFyIHN1YiA9IGZ1bmN0aW9uKHZhbHVlKSB7DQogICAgICBpZiAodmFsdWUgPT0gdGhpcy5wcmlvcikgew0KICAgICAgICByZXR1cm47DQogICAgICB9DQogICAgICB0aGlzLnByaW9yID0gdmFsdWU7DQogICAgICBmaXJlX3Vuc3ViKHRoaXMpOw0KICAgICAgbnVrZShwYXJlbnQpOw0KICAgICAgdmFyIHN0YXRlID0gZm9yayhwcmlvclN0YXRlKTsNCiAgICAgIGNoaWxkcmVuTWFrZXIocGFyZW50LCBzdGF0ZSwgJycgKyB2YWx1ZSk7DQogICAgICBzdWJzY3JpYmVfc3RhdGUoc3RhdGUsIHRoaXMpOw0KDQogICAgfS5iaW5kKHN3c3QpOw0KICAgIHN1YnNjcmliZShwcmlvclN0YXRlLCBuYW1lLCBzdWIpOw0KICB9Ow0KDQogIC8vIFJVTlRJTUUgfCA8dGFnIHJ4Oml0ZXJhdGU9cGF0aCAuLi4+DQogIHNlbGYuSVQgPSBmdW5jdGlvbihwYXJlbnREb20sIHN0YXRlLCBuYW1lLCBleHBhbmRWaWV3LCBtYWtlcikgew0KICAgIHZhciBpdF9zdGF0ZSA9IHNlbGYucEkoc3RhdGUsIG5hbWUpOw0KICAgIHZhciBkb21CeUtleSA9IHt9Ow0KICAgIHZhciB2aWV3VW5TdWJCeUtleSA9IHt9Ow0KDQogICAgdmFyIHN1YiA9IHsNCiAgICAgICcrJzogZnVuY3Rpb24oa2V5KSB7DQogICAgICAgIC8vIFRPRE86IHZpZXcgcHJvcGFnYXRlcyBkb24ndCB3b3JrIGhlcmUNCiAgICAgICAgdmFyIG5ld19zdGF0ZSA9IHNlbGYucEkoaXRfc3RhdGUsIGtleSk7DQogICAgICAgIGlmIChleHBhbmRWaWV3KSB7DQogICAgICAgICAgbmV3X3N0YXRlID0gc2VsZi5wRVYoaXRfc3RhdGUsIGtleSk7DQogICAgICAgIH0NCiAgICAgICAgbmV3X3N0YXRlID0gew0KICAgICAgICAgIHNlcnZpY2U6IG5ld19zdGF0ZS5zZXJ2aWNlLA0KICAgICAgICAgIGRhdGE6IG5ld19zdGF0ZS5kYXRhLA0KICAgICAgICAgIHZpZXc6IG5ld19kZWx0YV9jb3B5KG5ld19zdGF0ZS52aWV3KSwNCiAgICAgICAgICBjdXJyZW50Om5ld19zdGF0ZS5jdXJyZW50DQogICAgICAgIH07DQogICAgICAgIA0KICAgICAgICB2YXIgdW5zdWIgPSBtYWtlX3Vuc3ViKCk7DQogICAgICAgIHZhciBkb20gPSBtYWtlcihuZXdfc3RhdGUpOw0KICAgICAgICBkb21CeUtleVtrZXldID0gZG9tOw0KICAgICAgICB2aWV3VW5TdWJCeUtleVtrZXldID0gdW5zdWI7DQogICAgICAgIHBhcmVudERvbS5hcHBlbmQoZG9tKTsNCiAgICAgICAgc3Vic2NyaWJlX3ZpZXcobmV3X3N0YXRlLCB1bnN1Yik7DQogICAgICAgIHJldHVybiBuZXdfc3RhdGVbbmV3X3N0YXRlLmN1cnJlbnRdLmRlbHRhOw0KICAgICAgfSwNCiAgICAgICctJzogZnVuY3Rpb24oa2V5KSB7DQogICAgICAgIGlmIChrZXkgaW4gZG9tQnlLZXkpIHsNCiAgICAgICAgICBwYXJlbnREb20ucmVtb3ZlQ2hpbGQoZG9tQnlLZXlba2V5XSk7DQogICAgICAgICAgZGVsZXRlIGRvbUJ5S2V5W2tleV07DQogICAgICAgIH0NCiAgICAgICAgaWYgKGtleSBpbiB2aWV3VW5TdWJCeUtleSkgew0KICAgICAgICAgIGZpcmVfdW5zdWIodmlld1VuU3ViQnlLZXlba2V5XSk7DQogICAgICAgICAgZGVsZXRlIHZpZXdVblN1YkJ5S2V5W2tleV07DQogICAgICAgIH0NCiAgICAgIH0sDQogICAgICAnfic6IGZ1bmN0aW9uKG9yZCkgew0KICAgICAgICBudWtlKHBhcmVudERvbSk7DQogICAgICAgIGZvciAodmFyIGsgPSAwOyBrIDwgb3JkLmxlbmd0aDsgaysrKSB7DQogICAgICAgICAgcGFyZW50RG9tLmFwcGVuZChkb21CeUtleVtvcmRba11dKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH07DQogICAgc3Vic2NyaWJlKHN0YXRlLCBuYW1lLCBzdWIpOw0KICB9Ow0KDQogIHZhciBmaW5kID0gZnVuY3Rpb24oc3RhdGUsIGNoYW5uZWwsIGtleSwgdmFsdWUpIHsNCiAgICBpZiAoY2hhbm5lbCBpbiBzdGF0ZVsnZGF0YSddLmNvbm5lY3Rpb24ub3V0c3RhbmRpbmcpIHsNCiAgICAgIHZhciBhcnIgPSBzdGF0ZVsnZGF0YSddLmNvbm5lY3Rpb24ub3V0c3RhbmRpbmdbY2hhbm5lbF0ub3B0aW9uczsNCiAgICAgIGZvciAodmFyIGsgPSAwOyBrIDwgYXJyLmxlbmd0aDsgaysrKSB7DQogICAgICAgIHZhciBzID0gYXJyW2tdOw0KICAgICAgICBpZiAoa2V5IGluIHMgJiYgc1trZXldID09IHZhbHVlKSB7DQogICAgICAgICAgcmV0dXJuIHM7DQogICAgICAgIH0gDQogICAgICB9DQogICAgICByZXR1cm4gbnVsbDsNCiAgICB9IGVsc2Ugew0KICAgICAgcmV0dXJuIG51bGw7DQogICAgfQ0KICB9Ow0KDQogIHZhciBjdXN0b21zID0ge307DQoNCiAgc2VsZi5QUkNVQUMgPSBmdW5jdGlvbihuYW1lLCBmb28pIHsNCiAgICBjdXN0b21zW25hbWVdID0gZm9vOw0KICB9Ow0KDQogIHNlbGYuZXhDQyA9IGZ1bmN0aW9uKGRvbSwgdHlwZSwgc3RhdGUsIGN1c3RvbUNvbW1hbmROYW1lKSB7DQogICAgZG9tLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgZnVuY3Rpb24oKSB7DQogICAgICBpZiAoY3VzdG9tQ29tbWFuZE5hbWUgaW4gY3VzdG9tcykgew0KICAgICAgICBjdXN0b21zW2N1c3RvbUNvbW1hbmROYW1lXSgpOw0KICAgICAgfQ0KICAgIH0pOw0KICB9Ow0KDQogIHNlbGYuYUNDID0gZnVuY3Rpb24oZm9ybSwgc3RhdGUsIGN1c3RvbUNvbW1hbmROYW1lLCBzdGF0dXNWYXIpIHsNCiAgICB2YXIgc2lnbmFsID0gbWFrZV9mYWlsdXJlX3NpZ25hbChzdGF0ZSwgc3RhdHVzVmFyKTsNCiAgICBmb3JtLm9uc3VibWl0ID0gZnVuY3Rpb24oZXZ0KSB7DQogICAgICBpZiAoY3VzdG9tQ29tbWFuZE5hbWUgaW4gY3VzdG9tcykgew0KICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsNCiAgICAgICAgdmFyIG9iaiA9IGdldF9mb3JtKGZvcm0pOw0KICAgICAgICBjdXN0b21zW2N1c3RvbUNvbW1hbmROYW1lXShvYmosIHN0YXRlLCBzaWduYWwsIHNlbGYpOw0KICAgICAgfQ0KICAgIH07DQogIH07DQoNCiAgc2VsZi5leEQgPSBmdW5jdGlvbihkb20sIHR5cGUsIHN0YXRlLCBuYW1lLCBjaGFubmVsLCBrZXkpIHsNCiAgICB2YXIgZGVjaWRlID0geyB2YWx1ZTogbnVsbCB9Ow0KICAgIGRvbS5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGZ1bmN0aW9uKCkgew0KICAgICAgdmFyIHJlc3VsdCA9IGZpbmQoc3RhdGUsIGNoYW5uZWwsIGtleSwgZGVjaWRlLnZhbHVlKTsNCiAgICAgIGlmIChyZXN1bHQgIT0gbnVsbCkgew0KICAgICAgICBsZXQgc3RhcnQgPSBwZXJmb3JtYW5jZS5ub3coKTsNCiAgICAgICAgc3RhdGUuZGF0YS5jb25uZWN0aW9uLnB0ci5zZW5kKGNoYW5uZWwsIHJlc3VsdCwgew0KICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uKHJlYXNvbikgew0KDQogICAgICAgICAgfSwNCiAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihwYXlsb2FkKSB7DQogICAgICAgICAgICBjb25zb2xlLmxvZygiU3VjY2Vzc3wiICsgcGF5bG9hZC5zZXEgKyAiO2xhdGVuY3k9IiArIChwZXJmb3JtYW5jZS5ub3coKSAtIHN0YXJ0KSk7DQogICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgIH0gICAgICANCiAgICB9KTsNCiAgICBzdWJzY3JpYmUoc3RhdGUsIG5hbWUsIGZ1bmN0aW9uKHZhbHVlKSB7IGRlY2lkZS52YWx1ZSA9IHZhbHVlOyB9KTsNCiAgfTsNCg0KICAvLyBSVU5USU1FOiA8dGFnIC4uIHJ4OmV2ZW50PSIuLi4gc2V0Om5hbWU9dmFsdWUgLi4uIj4NCiAgc2VsZi5vblMgPSBmdW5jdGlvbihkb20sIHR5cGUsIHN0YXRlLCBuYW1lLCB2YWx1ZSkgew0KICAgIHZhciBydW5uYWJsZSA9IGZ1bmN0aW9uKCkgew0KICAgICAgdmFyIG9iaiA9IHt9Ow0KICAgICAgaWYgKHR5cGVvZih2YWx1ZSkgPT0gJ2Z1bmN0aW9uJykgew0KICAgICAgICBvYmpbbmFtZV0gPSB2YWx1ZSgpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgb2JqW25hbWVdID0gdmFsdWU7DQogICAgICB9DQogICAgICB2YXIgZGVsdGEgPSBwYXRoX3RvKHN0YXRlLCBvYmopOw0KICAgICAgc3RhdGVbc3RhdGUuY3VycmVudF0udHJlZS51cGRhdGUoZGVsdGEpOw0KICAgIH07DQogICAgaWYgKHR5cGUgPT0gJ2xvYWQnKSB7DQogICAgICB3aW5kb3cuc2V0VGltZW91dChydW5uYWJsZSwgMSk7DQogICAgfSBlbHNlIHsNCiAgICAgIGRvbS5hZGRFdmVudExpc3RlbmVyKHR5cGUsIHJ1bm5hYmxlKTsNCiAgICB9DQogIH07DQoNCiAgLy8gUlVOVElNRTogPHRhZyAuLiByeDpldmVudD0iLi4uIHRvZ2dsZTpuYW1lIC4uLiI+DQogIHNlbGYub25UID0gZnVuY3Rpb24oZG9tLCB0eXBlLCBzdGF0ZSwgbmFtZSkgew0KICAgIHZhciBjYXB0dXJlZCA9IHt2YWx1ZTogZmFsc2V9Ow0KICAgIGRvbS5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGZ1bmN0aW9uKCkgew0KICAgICAgdmFyIG9iaiA9IHt9Ow0KICAgICAgb2JqW25hbWVdID0gIWNhcHR1cmVkLnZhbHVlOw0KICAgICAgdmFyIGRlbHRhID0gcGF0aF90byhzdGF0ZSwgb2JqKTsNCiAgICAgIHN0YXRlW3N0YXRlLmN1cnJlbnRdLnRyZWUudXBkYXRlKGRlbHRhKTsNCiAgICB9KTsNCiAgICBzdWJzY3JpYmUoc3RhdGUsIG5hbWUsIGZ1bmN0aW9uKHZhbHVlKSB7DQogICAgICBjYXB0dXJlZC52YWx1ZSA9IHZhbHVlID09IHRydWU7DQogICAgfSk7DQogIH07DQoNCiAgLy8gUlVOVElNRTogPHRhZyAuLiByeDpldmVudD0iLi4uIGRlbHRhOm5hbWU9ZGlmZiIgLi4uIj4NCiAgc2VsZi5vbkQgPSBmdW5jdGlvbihkb20sIHR5cGUsIHN0YXRlLCBuYW1lLCBkaWZmKSB7DQogICAgdmFyIGNhcHR1cmVkID0ge3ZhbHVlOiAwfTsNCiAgICBkb20uYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBmdW5jdGlvbigpIHsNCiAgICAgIHZhciBvYmogPSB7fTsNCiAgICAgIG9ialtuYW1lXSA9IGNhcHR1cmVkLnZhbHVlICsgZGlmZjsNCiAgICAgIHZhciBkZWx0YSA9IHBhdGhfdG8oc3RhdGUsIG9iaik7DQogICAgICBzdGF0ZVtzdGF0ZS5jdXJyZW50XS50cmVlLnVwZGF0ZShkZWx0YSk7DQogICAgfSk7DQogICAgc3Vic2NyaWJlKHN0YXRlLCBuYW1lLCBmdW5jdGlvbih2YWx1ZSkgew0KICAgICAgaWYgKHR5cGVvZih2YWx1ZSkgPT0gIm51bWJlciIpIHsNCiAgICAgICAgY2FwdHVyZWQudmFsdWUgPSB2YWx1ZTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHZhciB2YWwgPSBwYXJzZUZsb2F0KHZhbHVlKTsNCiAgICAgICAgaWYgKCFpc05hTih2YWwpKSB7DQogICAgICAgICAgY2FwdHVyZWQudmFsdWUgPSB2YWw7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9KTsNCiAgfTsNCg0KICBzZWxmLkRFID0gZnVuY3Rpb24ocGFyZW50LCBwcmlvclN0YXRlLCBldmFsU3RhdGUsIGNoYW5uZWwsIGtleSwgbmFtZSwgc2hvdWxkQmUsIF9leHBhbmQsIG1ha2VyVHJ1ZSwgbWFrZXJGYWxzZSkgew0KICAgIHZhciBkZWNpZGUgPSB7DQogICAgICB2YWx1ZTogJycsDQogICAgICBvd25lcjogcGFyZW50LA0KICAgICAgc2hvd246IGZhbHNlLA0KICAgICAgZXZhbDogbnVsbCwNCiAgICB9Ow0KICAgIGFkZF91bnN1YihkZWNpZGUpOw0KICAgIHZhciBjaGFuZ2UgPSBmdW5jdGlvbihzaG93KSB7DQogICAgICBmaXJlX3Vuc3ViKGRlY2lkZSk7DQogICAgICBudWtlKHBhcmVudCk7DQogICAgICB2YXIgc3RhdGUgPSBmb3JrKHByaW9yU3RhdGUpOw0KICAgICAgaWYgKHNob3cgPT09IHNob3VsZEJlKSB7DQogICAgICAgIG1ha2VyVHJ1ZShwYXJlbnQsIHN0YXRlKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIG1ha2VyRmFsc2UocGFyZW50LCBzdGF0ZSk7DQogICAgICB9DQogICAgICBzdWJzY3JpYmVfc3RhdGUoc3RhdGUsIGRlY2lkZSk7DQogICAgfTsNCg0KICAgIGRlY2lkZS51cGRhdGUgPSBmdW5jdGlvbigpIHsNCiAgICAgIHZhciBldmFsID0gZmluZChwcmlvclN0YXRlLCBjaGFubmVsLCBrZXksIGRlY2lkZS52YWx1ZSkgIT0gbnVsbDsNCiAgICAgIGlmIChkZWNpZGUuZXZhbCAhPSBldmFsKSB7DQogICAgICAgIGRlY2lkZS5ldmFsID0gZXZhbDsNCiAgICAgICAgY2hhbmdlKGRlY2lkZS5ldmFsKTsNCiAgICAgIH0NCiAgICB9Ow0KDQogICAgcHJpb3JTdGF0ZS5kYXRhLmNvbm5lY3Rpb24uc3Vic2NyaWJlKGNoYW5uZWwsIGZ1bmN0aW9uKCkgew0KICAgICAgZGVjaWRlLnVwZGF0ZSgpOw0KICAgIH0pOw0KDQogICAgc3Vic2NyaWJlKGV2YWxTdGF0ZSwgbmFtZSwgZnVuY3Rpb24odmFsdWUpIHsNCiAgICAgIGRlY2lkZS52YWx1ZSA9IHZhbHVlOw0KICAgICAgZGVjaWRlLnVwZGF0ZSgpOw0KICAgIH0pOw0KICB9Ow0KDQogIHNlbGYuSUYgPSBmdW5jdGlvbihwYXJlbnQsIHByaW9yU3RhdGUsIG5hbWUsIHNob3VsZEJlLCBleHBhbmRWaWV3LCBtYWtlclRydWUsIG1ha2VyRmFsc2UpIHsNCiAgICB2YXIgdW5zdWIgPSBtYWtlX3Vuc3ViKCk7DQogICAgdmFyIHNldCA9IGZ1bmN0aW9uKHZhbHVlKSB7DQogICAgICB2YXIgc2hvdyA9ICh2YWx1ZSA/IHRydWUgOiBmYWxzZSkgPT09IHNob3VsZEJlOw0KICAgICAgaWYgKHRoaXMuc2hvd24gPT0gc2hvdykgew0KICAgICAgICByZXR1cm47DQogICAgICB9DQogICAgICB0aGlzLnNob3duID0gc2hvdzsNCiAgICAgIG51a2UocGFyZW50KTsNCiAgICAgIGZpcmVfdW5zdWIodW5zdWIpOw0KICAgICAgdmFyIHN0YXRlID0gZm9yayhwcmlvclN0YXRlKTsNCiAgICAgIHZhciBuZXh0ID0gc3RhdGU7DQogICAgICBpZiAodHlwZW9mKHZhbHVlKSA9PSAnb2JqZWN0Jykgew0KICAgICAgICBuZXh0ID0gc2VsZi5wSShuZXh0LCBuYW1lKTsNCiAgICAgICAgaWYgKGV4cGFuZFZpZXcpIHsNCiAgICAgICAgICBuZXh0ID0gc2VsZi5wRVYobmV4dCwgbmFtZSk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIGlmIChzaG93KSB7DQogICAgICAgIG1ha2VyVHJ1ZShwYXJlbnQsIG5leHQpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgbWFrZXJGYWxzZShwYXJlbnQsIG5leHQpOw0KICAgICAgfQ0KICAgICAgc3Vic2NyaWJlX3N0YXRlKHN0YXRlLCB1bnN1Yik7DQogICAgfS5iaW5kKHtzaG93bjpzaG91bGRCZX0pOw0KICAgIHNldCghc2hvdWxkQmUpOw0KICAgIHN1YnNjcmliZShwcmlvclN0YXRlLCBuYW1lLCBzZXQpOw0KICB9Ow0KDQogIC8vLyBSVU5USU1FIHwgcng6YWN0aW9uPWNvcHk6cGF0aA0KICBzZWxmLmFDUCA9IGZ1bmN0aW9uKGZvcm0sIHN0YXRlLCBuYW1lKSB7DQogICAgZm9ybS5vbnN1Ym1pdCA9IGZ1bmN0aW9uKGV2dCkgew0KICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7DQogICAgICB2YXIgb2JqID0gZ2V0X2Zvcm0oZm9ybSk7DQogICAgICBpZiAobmFtZSAhPSAiLiIgJiYgbmFtZSAhPSAiIikgew0KICAgICAgICB2YXIgbm8gPSB7fTsNCiAgICAgICAgbm9bbmFtZV0gPSBvYmo7DQogICAgICAgIG9iaiA9IG5vOw0KICAgICAgfQ0KICAgICAgdmFyIGRlbHRhID0gcGF0aF90byhzdGF0ZSwgb2JqKTsNCiAgICAgIHN0YXRlLnZpZXcudHJlZS51cGRhdGUoZGVsdGEpOw0KICAgIH07DQogIH07DQogICAgDQogIC8vIFJVTlRJTUUgfCA8aW5wdXQgLi4uIHJ4OnN5bmM9cGF0aCAuLi4+DQogIHNlbGYuU1kgPSBmdW5jdGlvbihlbCwgc3RhdGUsIG5hbWUsIG1zKSB7DQogICAgdmFyIHR5cGUgPSAoJ3R5cGUnIGluIGVsKSA/IGVsLnR5cGUudG9VcHBlckNhc2UoKSA6ICd0ZXh0JzsNCiAgICB2YXIgc2lnbmFsID0gZnVuY3Rpb24odmFsdWUpIHsNCiAgICAgIHZhciBvYmogPSB7fTsNCiAgICAgIG9ialtuYW1lXSA9IGVsLnZhbHVlOw0KICAgICAgdmFyIGRlbHRhID0gcGF0aF90byhzdGF0ZSwgb2JqKTsNCiAgICAgIHN0YXRlLnZpZXcudHJlZS51cGRhdGUoZGVsdGEpOw0KICAgIH07DQogICAgaWYgKHR5cGUgPT0gIkNIRUNLQk9YIikgew0KICAgICAgZWwub25jaGFuZ2UgPSBkZWJvdW5jZShtcywgZnVuY3Rpb24oZXZ0KSB7DQogICAgICAgIHNpZ25hbChlbC5jaGVja2VkID8gdHJ1ZSA6IGZhbHNlKTsNCiAgICAgIH0pOw0KICAgIH0gZWxzZSBpZiAodHlwZSA9PSAiUkFESU8iKSB7DQogICAgICBlbC5vbmNoYW5nZSA9IGRlYm91bmNlKG1zLCBmdW5jdGlvbihldnQpIHsNCiAgICAgICAgaWYgKGVsLmNoZWNrZWQpIHsNCiAgICAgICAgICBzaWduYWwoZWwudmFsdWUpOw0KICAgICAgICB9DQogICAgICB9KTsNCiAgICB9IGVsc2Ugew0KICAgICAgZWwub25jaGFuZ2UgPSBkZWJvdW5jZShtcywgZnVuY3Rpb24oZXZ0KSB7DQogICAgICAgIHNpZ25hbChlbC52YWx1ZSk7DQogICAgICB9KTsNCiAgICAgIGVsLm9ua2V5dXAgPSBlbC5vbmNoYW5nZTsNCiAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgew0KICAgICAgICBzaWduYWwoZWwudmFsdWUpOw0KICAgICAgfSwgMSk7DQogICAgfQ0KICB9Ow0KDQogIC8vIEhFTFBFUiB8IGV4dHJhY3QgYWxsIHRoZSBpbnB1dHMgZnJvbSB0aGUgZ2l2ZW4gZWxlbWVudCBhbmQgYnVpbGQgYW4gb2JqZWN0DQogIHZhciBidWlsZF9vYmogPSBmdW5jdGlvbihlbCwgb2JqKSB7DQogICAgaWYgKGVsLnRhZ05hbWUudG9VcHBlckNhc2UoKSA9PSAiVEVYVEFSRUEiKSB7DQogICAgICBvYmpbZWwubmFtZV0gPSBlbC52YWx1ZTsNCiAgICB9IGVsc2UgaWYgKGVsLnRhZ05hbWUudG9VcHBlckNhc2UoKSA9PSAiU0VMRUNUIikgew0KICAgICAgb2JqW2VsLm5hbWVdID0gZWwudmFsdWU7DQogICAgfSBlbHNlIGlmIChlbC50YWdOYW1lLnRvVXBwZXJDYXNlKCkgPT0gIklOUFVUIikgew0KICAgICAgdmFyIHR5cGUgPSAoJ3R5cGUnIGluIGVsKSA/IGVsLnR5cGUudG9VcHBlckNhc2UoKSA6ICd0ZXh0JzsNCiAgICAgIGlmICh0eXBlID09ICJTVUJNSVQiIHx8IHR5cGUgPT0gIlJFU0VUIikgcmV0dXJuOw0KICAgICAgaWYgKCduYW1lJyBpbiBlbCkgew0KICAgICAgICB2YXIgbmFtZSA9IGVsLm5hbWU7DQogICAgICAgIHZhciBpbnNlcnRBdCA9IG9iajsNCiAgICAgICAgdmFyIHB1c2ggPSBuYW1lLmVuZHNXaXRoKCJbXSIpOw0KICAgICAgICBpZiAocHVzaCkgew0KICAgICAgICAgIG5hbWUgPSBuYW1lLnN1YnN0cigwLCBuYW1lLmxlbmd0aCAtIDIpOw0KICAgICAgICAgIGlmIChuYW1lIGluIGluc2VydEF0KSB7DQogICAgICAgICAgICBpbnNlcnRBdFtuYW1lXSA9IFtdOw0KICAgICAgICAgIH0NCiAgICAgICAgICBpbnNlcnRBdCA9IGluc2VydEF0W25hbWVdOw0KICAgICAgICAgIGlmICh0eXBlID09ICJDSEVDS0JPWCIpIHsNCiAgICAgICAgICAgIGluc2VydEF0LnB1c2goZWwuY2hlY2tlZCA/IHRydWUgOiBmYWxzZSk7DQogICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09ICJSQURJTyIpIHsNCiAgICAgICAgICAgIGlmIChlbC5jaGVja2VkKSB7DQogICAgICAgICAgICAgIGluc2VydEF0LnB1c2goZWwudmFsdWUpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBpbnNlcnRBdC5wdXNoKGVsLnZhbHVlKTsNCiAgICAgICAgICB9DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgaWYgKHR5cGUgPT0gIkNIRUNLQk9YIikgew0KICAgICAgICAgICAgaW5zZXJ0QXRbbmFtZV0gPSBlbC5jaGVja2VkID8gdHJ1ZSA6IGZhbHNlOw0KICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PSAiUkFESU8iKSB7DQogICAgICAgICAgICBpZiAoZWwuY2hlY2tlZCkgew0KICAgICAgICAgICAgICBpbnNlcnRBdFtuYW1lXSA9IGVsLnZhbHVlOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBpbnNlcnRBdFtuYW1lXSA9IGVsLnZhbHVlOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0gZWxzZSB7DQogICAgICBpZiAoJ2NoaWxkcmVuJyBpbiBlbCkgew0KICAgICAgICB2YXIgYXJyID0gZWwuY2hpbGRyZW47DQogICAgICAgIHZhciBuID0gYXJyLmxlbmd0aDsNCiAgICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCBuOyBrKyspIHsNCiAgICAgICAgICB2YXIgY2ggPSBlbC5jaGlsZHJlbltrXTsNCiAgICAgICAgICBidWlsZF9vYmooY2gsIG9iaik7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQogIH07DQoNCiAgLy8gSEVMUEVSIHwgcmV0dXJuIGFuIG9iamVjdCBvZiBhbGwgdGhlIGlucHV0cyBvZiB0aGUgZ2l2ZW4gZm9ybSBlbGVtZW50DQogIHZhciBnZXRfZm9ybSA9IGZ1bmN0aW9uKGZvcm0pIHsNCiAgICB2YXIgb2JqID0ge307DQogICAgYnVpbGRfb2JqKGZvcm0sIG9iaik7DQogICAgcmV0dXJuIG9iajsNCiAgfTsNCg0KICAvLyBIRUxQRVIgfCBjcmVhdGUgYSBzaWduYWwgZm9yIHdoZW4gdGhpbmdzIGZhaWw7IHRoaXMgd2lsbCB3cml0ZSBpbnRvIHRoZSB0aGUgdmlldw0KICB2YXIgbWFrZV9mYWlsdXJlX3NpZ25hbCA9IGZ1bmN0aW9uKHN0YXRlLCBmYWlsdXJlVmFyKSB7DQogICAgcmV0dXJuIGZ1bmN0aW9uKGZhaWwpIHsNCiAgICAgIHZhciBvYmogPSB7fTsNCiAgICAgIG9ialtmYWlsdXJlVmFyXSA9IGZhaWw7DQogICAgICB2YXIgZGVsdGEgPSBwYXRoX3RvKHNlbGYucFYoc3RhdGUpLCBvYmopOw0KICAgICAgY29uc29sZS5sb2coZGVsdGEpOw0KICAgICAgc3RhdGUudmlldy50cmVlLnVwZGF0ZShkZWx0YSk7DQogICAgfTsNCiAgfTsNCg0KICAvKioNCiAvJCQkJCQkJCQgLyQkJCQkJCAgLyQkJCQkJCQgICAvJCQkJCQkIA0KfF9fICAkJF9fLy8kJF9fICAkJHwgJCRfXyAgJCQgLyQkX18gICQkDQogICB8ICQkICB8ICQkICBcICQkfCAkJCAgXCAkJHwgJCQgIFwgJCQNCiAgIHwgJCQgIHwgJCQgIHwgJCR8ICQkICB8ICQkfCAkJCAgfCAkJA0KICAgfCAkJCAgfCAkJCAgfCAkJHwgJCQgIHwgJCR8ICQkICB8ICQkDQogICB8ICQkICB8ICQkICB8ICQkfCAkJCAgfCAkJHwgJCQgIHwgJCQNCiAgIHwgJCQgIHwgICQkJCQkJC98ICQkJCQkJCQvfCAgJCQkJCQkLw0KICAgfF9fLyAgIFxfX19fX18vIHxfX19fX19fLyAgXF9fX19fXy8gDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLw0KICANCiAgLy8gUlVOVElNRSB8IHJlZ2lzdGVyIHRoZSBwYWdlIGZvciB0aGUgdXJpIHRvIHRoZSBnaXZlbiBmb28oKS4NCiAgc2VsZi5QRyA9IGZ1bmN0aW9uKHVyaSwgZm9vKSB7DQogICAgdmFyIGhlYWQgPSByb3V0ZXI7DQogICAgZm9yICh2YXIgayA9IDA7IGsgPCB1cmkubGVuZ3RoOyBrKyspIHsNCiAgICAgIHZhciBwYXJ0ID0gdXJpW2tdOw0KICAgICAgaWYgKCEocGFydCBpbiBoZWFkKSkgew0KICAgICAgICBoZWFkW3BhcnRdID0ge307DQogICAgICB9DQogICAgICBoZWFkID0gaGVhZFtwYXJ0XTsNCiAgICB9DQogICAgaGVhZFsnQCddID0gZm9vOw0KICB9Ow0KDQogIHZhciByb3V0ZSA9IGZ1bmN0aW9uKHBhcnRzLCBhdCwgaGVhZCwgdmlldykgew0KICAgIGlmIChhdCA8IHBhcnRzLmxlbmd0aCkgew0KICAgICAgaWYgKCdudW1iZXInIGluIGhlYWQpIHsNCiAgICAgICAgdmFyIG5lY2sgPSBoZWFkWydudW1iZXInXTsNCiAgICAgICAgdmFyIHZhbCA9IHBhcnNlRmxvYXQocGFydHNbYXRdKTsNCiAgICAgICAgaWYgKCFpc05hTih2YWwpKSB7DQogICAgICAgICAgZm9yICh2YXIgYnJhbmNoIGluIG5lY2spIHsNCiAgICAgICAgICAgIHZpZXdbYnJhbmNoXSA9IHZhbDsNCiAgICAgICAgICAgIHZhciBjYW5kaWRhdGUgPSByb3V0ZShwYXJ0cywgYXQgKyAxLCBuZWNrW2JyYW5jaF0sIHZpZXcpOw0KICAgICAgICAgICAgaWYgKGNhbmRpZGF0ZSAhPT0gbnVsbCkgew0KICAgICAgICAgICAgICByZXR1cm4gY2FuZGlkYXRlOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZGVsZXRlIHZpZXdbYnJhbmNoXTsNCiAgICAgICAgICB9DQogICAgICAgIH07DQogICAgICB9DQogICAgICBpZiAoJ3RleHQnIGluIGhlYWQpIHsNCiAgICAgICAgdmFyIG5lY2sgPSBoZWFkWyd0ZXh0J107DQogICAgICAgIHZhciB2YWwgPSBwYXJ0c1thdF07DQogICAgICAgIGZvciAodmFyIGJyYW5jaCBpbiBuZWNrKSB7DQogICAgICAgICAgdmlld1ticmFuY2hdID0gdmFsOw0KICAgICAgICAgIHZhciBjYW5kaWRhdGUgPSByb3V0ZShwYXJ0cywgYXQgKyAxLCBuZWNrW2JyYW5jaF0sIHZpZXcpOw0KICAgICAgICAgIGlmIChjYW5kaWRhdGUgIT09IG51bGwpIHsNCiAgICAgICAgICAgIHJldHVybiBjYW5kaWRhdGU7DQogICAgICAgICAgfQ0KICAgICAgICAgIGRlbGV0ZSB2aWV3W2JyYW5jaF07DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIGlmICgnZml4ZWQnIGluIGhlYWQpIHsNCiAgICAgICAgdmFyIG5lY2sgPSBoZWFkWydmaXhlZCddOw0KICAgICAgICBmb3IgKHZhciBicmFuY2ggaW4gbmVjaykgew0KICAgICAgICAgIGlmIChicmFuY2ggPT0gcGFydHNbYXRdKSB7DQogICAgICAgICAgICB2YXIgY2FuZGlkYXRlID0gcm91dGUocGFydHMsIGF0ICsgMSwgbmVja1ticmFuY2hdLCB2aWV3KTsNCiAgICAgICAgICAgIGlmIChjYW5kaWRhdGUgIT09IG51bGwpIHsNCiAgICAgICAgICAgICAgcmV0dXJuIGNhbmRpZGF0ZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9IGVsc2Ugew0KICAgICAgaWYgKCdAJyBpbiBoZWFkKSB7DQogICAgICAgIHJldHVybiBoZWFkWydAJ107DQogICAgICB9DQogICAgfQ0KICB9Ow0KDQogIHNlbGYuZ290byA9IGZ1bmN0aW9uKHZpZXdTdGF0ZSwgdXJpKSB7DQogICAgLy8gVE9ETzogZmlndXJlIG91dCBhIGJldHRlciBtb2RlbC4NCiAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsNCiAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gdXJpOw0KICAgIH0sIDEwKTsNCiAgfTsNCg0KICAvLyBBUEkgfCBSdW4gdGhlIHBhZ2UgaW4gdGhlIGdpdmVuIHBsYWNlDQogIHNlbGYucnVuID0gZnVuY3Rpb24od2hlcmUsIHBhdGgpIHsNCiAgICBmb3IgKGNvbktleSBpbiBjb25uZWN0aW9ucykgew0KICAgICAgY29ubmVjdGlvbnNbY29uS2V5XS50cmVlLm51a2UoKTsNCiAgICB9DQogICAgdmFyIHBhcnRzID0gKHBhdGguc3RhcnRzV2l0aCgiLyIpID8gcGF0aC5zdWJzdHIoMSkgOiBwYXRoKS5zcGxpdCgiLyIpOw0KICAgIHZhciBpbml0ID0geydzZXNzaW9uX2lkJzoiUiIgKyBNYXRoLnJhbmRvbSgpfTsNCiAgICB2YXIgZm9vID0gcm91dGUocGFydHMsIDAsIHJvdXRlciwgaW5pdCk7DQogICAgaWYgKGZvbyAhPSBudWxsKSB7DQogICAgICBudWtlKHdoZXJlKTsNCiAgICAgIHZhciBzdGF0ZSA9IHtzZXJ2aWNlOiBjb25uZWN0aW9uLCBkYXRhOm51bGwsIHZpZXc6ZnJlc2god2hlcmUpLCBjdXJyZW50Oid2aWV3J307DQogICAgICBmb28od2hlcmUsIHN0YXRlKTsNCiAgICAgIHN0YXRlLnZpZXcudHJlZS5zdWJzY3JpYmUoc3RhdGUudmlldy5kZWx0YSk7DQogICAgICBzdGF0ZS52aWV3LnRyZWUudXBkYXRlKGluaXQpOw0KICAgIH0gZWxzZSB7DQogICAgICBpZiAocGF0aCAhPSAiLzQwNCIpIHsNCiAgICAgICAgc2VsZi5ydW4od2hlcmUsICIvNDA0Iik7DQogICAgICB9IGVsc2Ugew0KICAgICAgICAvLyBkZWZhdWx0IDQwNA0KICAgICAgfQ0KICAgIH0NCiAgfTsNCg0KICB2YXIgaWRlbnRpdGllcyA9IHt9Ow0KDQogIHNlbGYuU0lHTk9VVCA9IGZ1bmN0aW9uKCkgew0KICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCJpZGVudGl0eV9kZWZhdWx0Iik7DQogICAgc2VsZi5nb3RvKG51bGwsICcvJyk7DQogIH07DQoNCiAgc2VsZi5HT09HTEVfU0lHTl9PTiA9IGZ1bmN0aW9uKGFjY2Vzc1Rva2VuKSB7DQogICAgY29ubmVjdGlvbi5Jbml0Q29udmVydEdvb2dsZVVzZXIoYWNjZXNzVG9rZW4sIHsNCiAgICAgIHN1Y2Nlc3M6ZnVuY3Rpb24ocGF5bG9hZCkgew0KICAgICAgICBpZGVudGl0aWVzWydkZWZhdWx0J10gPSBwYXlsb2FkLmlkZW50aXR5Ow0KICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgiaWRlbnRpdHlfZGVmYXVsdCIsIHBheWxvYWQuaWRlbnRpdHkpOw0KICAgICAgICBzZWxmLmdvdG8obnVsbCwgJy8nKTsNCiAgICAgIH0sDQogICAgICBmYWlsdXJlOiBmdW5jdGlvbihyZWFzb24pIHsNCiAgICAgICAgY29uc29sZS5sb2coIkdvb2dsZSBmYWlsdXJlOiAiICtyZWFzb24pOw0KICAgICAgfQ0KICAgIH0pOw0KICB9Ow0KDQogIC8qKiBmb3IgY3VzdG9tIGVsZW1lbnRzIHRvIGxlYXJuIG9mIHRoZSBpZGVudGl0eSAqLw0KICBzZWxmLklEID0gZnVuY3Rpb24oaWRlbnRpdHlOYW1lLCByZWRpcmVjdFRvKSB7DQogICAgICAvLyBJRiBpZGVudGl0eSBjb250YWlucyBkb3RzDQogICAgICB2YXIgaWRlbnRpdHkgPSBudWxsOw0KICAgICAgdmFyIGNsZWFudXAgPSBmdW5jdGlvbigpIHt9Ow0KDQogICAgICB2YXIgdmFsID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oImlkZW50aXR5XyIgK2lkZW50aXR5TmFtZSk7DQogICAgICBpZiAodmFsKSB7DQogICAgICAgIGlkZW50aXRpZXNbaWRlbnRpdHlOYW1lXSA9IHZhbDsNCiAgICAgIH0NCg0KICAgICAgaWYgKGlkZW50aXR5TmFtZS5zdGFydHNXaXRoKCJkaXJlY3Q6IikpIHsNCiAgICAgICAgLy8gVXNlLCBhcyBpcw0KICAgICAgICBpZGVudGl0eSA9IGlkZW50aXR5TmFtZS5zdWJzdHIoNyk7DQogICAgICB9IGVsc2UgaWYgKGlkZW50aXR5TmFtZSBpbiBpZGVudGl0aWVzKSB7DQogICAgICAgIGlkZW50aXR5ID0gaWRlbnRpdGllc1tpZGVudGl0eU5hbWVdOw0KICAgICAgICBjbGVhbnVwID0gZnVuY3Rpb24oKSB7DQogICAgICAgICAgZGVsZXRlIGlkZW50aXRpZXNbaWRlbnRpdHlOYW1lXTsNCiAgICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgiaWRlbnRpdHlfIiArIGlkZW50aXR5TmFtZSk7DQogICAgICAgIH07DQogICAgICB9IGVsc2Ugew0KICAgICAgICAvLyB3aGF0ZXZlciBwYWdlIHdlIGFyZSwgbmVlZHMgdG8gZGllIHdoaWNoIG1lYW5zIHdlIG5lZWQgdG8gbnVrZSBldmVyeXRoaW5nIQ0KICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsNCiAgICAgICAgICAvLyBUT0RPOiB0aGlzIGFzc3VtZXMgYSBmdWxsIGFwcCBnb2VzIHRvIHRoZSB3aW5kb3cNCiAgICAgICAgICBzZWxmLmdvdG8obnVsbCwgcmVkaXJlY3RUbyk7DQogICAgICAgIH0sIDEwKTsNCiAgICAgICAgcmV0dXJuIHthYm9ydDp0cnVlfTsNCiAgICAgIH0NCg0KICAgICAgcmV0dXJuIHthYm9ydDpmYWxzZSwgY2xlYW51cDpjbGVhbnVwLCBpZGVudGl0eTppZGVudGl0eX07DQogIH07DQoNCiAgdmFyIGN1c3RvbURhdGFTb3VyY2VzID0ge307DQoNCiAgLyoqIHByb3ZpZGUgY3VzdG9tIGRhdGEgKi8NCiAgc2VsZi5QUkNVREEgPSBmdW5jdGlvbihuYW1lLCBmb28pIHsNCiAgICBjdXN0b21EYXRhU291cmNlc1tuYW1lXSA9IGZvbzsNCiAgfTsNCg0KICAvLyA8Y3VzdG9tZGF0YSBzcmM9c3JjIChwYXJhbWV0ZXI6eD15KSogPg0KICBzZWxmLkNVREEgPSBmdW5jdGlvbihwYXJlbnQsIHByaW9yU3RhdGUsIHNyYywgcnhvYmosIHJlZGlyZWN0VG8sIGNoaWxkTWFrZXIpIHsNCiAgICB2YXIgdW5zdWIgPSBtYWtlX3Vuc3ViKCk7DQogICAgcnhvYmouX18gPSBkZWJvdW5jZSgxMCwgZnVuY3Rpb24oKSB7DQogICAgICBmaXJlX3Vuc3ViKHVuc3ViKTsNCiAgICAgIG51a2UocGFyZW50KTsNCiAgICAgIHZhciBjdXN0b21UcmVlID0gZmFsc2U7DQogICAgICBpZiAoc3JjIGluIGN1c3RvbURhdGFTb3VyY2VzKSB7DQogICAgICAgIHZhciBjb25zID0gY3VzdG9tRGF0YVNvdXJjZXNbc3JjXTsNCiAgICAgICAgaWYgKHR5cGVvZihjb25zKT09J2Z1bmN0aW9uJykgew0KICAgICAgICAgIGN1c3RvbVRyZWUgPSBjb25zKHJ4b2JqLCBwcmlvclN0YXRlLCByZWRpcmVjdFRvLCBzZWxmKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgaWYgKCFjdXN0b21UcmVlKSB7DQogICAgICAgIGN1c3RvbVRyZWUgPSBuZXcgQWRhbWFUcmVlU2ltcGxlKCk7DQogICAgICB9DQogICAgICB2YXIgc3RhdGUgPSB7DQogICAgICAgIHNlcnZpY2U6IHByaW9yU3RhdGUuc2VydmljZSwNCiAgICAgICAgZGF0YToge2Nvbm5lY3Rpb246IHByaW9yU3RhdGUuY29ubmVjdGlvbiwgdHJlZTpjdXN0b21UcmVlLCBkZWx0YTp7fSwgcGFyZW50Om51bGwsIHBhdGg6bnVsbH0sDQogICAgICAgIHZpZXc6IG5ld19kZWx0YV9jb3B5KHByaW9yU3RhdGUudmlldyksDQogICAgICAgIGN1cnJlbnQ6J2RhdGEnDQogICAgICB9Ow0KICAgICAgY2hpbGRNYWtlcihzdGF0ZSk7DQogICAgICBzdWJzY3JpYmVfc3RhdGUoc3RhdGUsIHVuc3ViKTsNCiAgICB9KTsNCiAgfTsNCg0KICAvLyA8Y29ubmVjdGlvbiAuLi4+DQogIHNlbGYuQ09OTkVDVCA9IGZ1bmN0aW9uKHN0YXRlLCByeG9iaiwgaWRlbnRpdHlOYW1lLCByZWRpcmVjdFRvKSB7DQogICAgdmFyIHVuc3ViID0ge3ZpZXc6ZnVuY3Rpb24oKXt9fTsNCiAgICByeG9iai5fXyA9IGRlYm91bmNlKDEwLCBmdW5jdGlvbigpIHsNCiAgICAgIHZhciBjbyA9IGdldF9jb25uZWN0aW9uX29iaihyeG9iai5uYW1lKTsNCiAgICAgIHZhciBkZXNpcmVkID0gcnhvYmouc3BhY2UgKyAiLyIgKyByeG9iai5rZXk7DQoNCiAgICAgIHZhciBiaW5kID0gZnVuY3Rpb24oc2VuZE5vdykgew0KICAgICAgICB1bnN1Yi52aWV3ID0gc3RhdGUudmlldy50cmVlLnN1YnNjcmliZShmdW5jdGlvbigpIHsNCiAgICAgICAgICBpZiAoY28ucHRyID09IG51bGwpIHsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICB9DQogICAgICAgICAgY28ucHRyLnVwZGF0ZShzdGF0ZS52aWV3LnRyZWUuY29weSgpLCB7DQogICAgICAgICAgICBzdWNjZXNzOmZ1bmN0aW9uKCkge30sDQogICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbigpIHt9DQogICAgICAgICAgfSk7DQogICAgICAgIH0pOw0KICAgICAgICBpZiAoc2VuZE5vdykgew0KICAgICAgICAgIGNvbnNvbGUubG9nKHN0YXRlLnZpZXcudHJlZS5zdHIoKSk7DQogICAgICAgICAgY28ucHRyLnVwZGF0ZShzdGF0ZS52aWV3LnRyZWUuY29weSgpLCB7DQogICAgICAgICAgICBzdWNjZXNzOmZ1bmN0aW9uKCkge30sDQogICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbigpIHt9DQogICAgICAgICAgfSk7DQogICAgICAgIH0NCiAgICAgIH07DQoNCiAgICAgIGlmIChjby5wdHIgIT0gbnVsbCAmJiBjby5ib3VuZCA9PSBkZXNpcmVkKSB7DQogICAgICAgIGJpbmQodHJ1ZSk7DQogICAgICAgIHJldHVybjsNCiAgICAgIH0NCiAgICAgIGlmIChjby5wdHIgIT0gbnVsbCkgew0KICAgICAgICBjby5wdHIuZW5kKCk7DQogICAgICB9DQoNCiAgICAgIHZhciBpZExvb2t1cCA9IHNlbGYuSUQoaWRlbnRpdHlOYW1lLCByZWRpcmVjdFRvKTsNCiAgICAgIGlmIChpZExvb2t1cC5hYm9ydCkgew0KICAgICAgICByZXR1cm47DQogICAgICB9DQogICAgICB2YXIgaWRlbnRpdHkgPSBpZExvb2t1cC5pZGVudGl0eTsNCiAgICAgIHZhciBjbGVhbnVwID0gaWRMb29rdXAuY2xlYW51cDsNCiAgICAgIGNvLmJvdW5kID0gZGVzaXJlZDsNCg0KICAgICAgdW5zdWIudmlldygpOw0KICAgICAgdmFyIHZ3ID0gc3RhdGUudmlldy50cmVlLmNvcHkoKTsNCiAgICAgIGNvLnNwYWNlID0gcnhvYmouc3BhY2U7DQogICAgICBjby5rZXkgPSByeG9iai5rZXk7DQogICAgICBjby5wdHIgPSBjb25uZWN0aW9uLkNvbm5lY3Rpb25DcmVhdGUoaWRlbnRpdHksIHJ4b2JqLnNwYWNlLCByeG9iai5rZXksIHZ3LCB7DQogICAgICAgIG5leHQ6IGZ1bmN0aW9uKHBheWxvYWQpIHsNCiAgICAgICAgICBpZiAoJ2RhdGEnIGluIHBheWxvYWQuZGVsdGEpIHsNCiAgICAgICAgICAgIGNvLnRyZWUudXBkYXRlKHBheWxvYWQuZGVsdGEuZGF0YSk7DQogICAgICAgICAgfQ0KICAgICAgICAgIGlmICgnb3V0c3RhbmRpbmcnIGluIHBheWxvYWQuZGVsdGEpIHsNCiAgICAgICAgICAgIGNvLm9uZGVjaWRlKHBheWxvYWQuZGVsdGEub3V0c3RhbmRpbmcpOw0KICAgICAgICAgIH0NCiAgICAgICAgfSwNCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24ocmVhc29uKSB7DQogICAgICAgICAgLy8gVE9ETzogaWYgbm90IGF1dGhvcml6ZWQNCiAgICAgICAgICAvKg0KICAgICAgICAgIGlmIChmYWxzZSkgew0KICAgICAgICAgICAgY2xlYW51cCgpOw0KICAgICAgICAgIH0NCiAgICAgICAgICAqLw0KICAgICAgICAgIGNvLnB0ciA9IG51bGw7DQogICAgICAgICAgLy8gVE9ETzogc2NoZWR1bGUgYSByZXRyeT8gaW52b2tlOiAgcnhvYmouX18oKTsNCiAgICAgICAgfSwNCiAgICAgIH0pOw0KICAgICAgYmluZChmYWxzZSk7DQogICAgfSk7DQogIH07DQogIA0KICBzZWxmLklOVEVSTkFMID0gZnVuY3Rpb24ocHJpb3JTdGF0ZSkgew0KICAgIHJldHVybiB7DQogICAgICBzZXJ2aWNlOiBwcmlvclN0YXRlLnNlcnZpY2UsDQogICAgICBkYXRhOiB7Y29ubmVjdGlvbjogbnVsbCwgdHJlZTpuZXcgQWRhbWFUcmVlU2ltcGxlKCksIGRlbHRhOnt9LCBwYXJlbnQ6bnVsbCwgcGF0aDpudWxsfSwNCiAgICAgIHZpZXc6IG5ld19kZWx0YV9jb3B5KHByaW9yU3RhdGUudmlldyksDQogICAgICBjdXJyZW50OidkYXRhJw0KICAgIH07DQogIH07DQoNCiAgdmFyIHJlY2FsbF9lbWFpbCA9IGZ1bmN0aW9uKGVsKSB7DQogICAgaWYgKGVsLnRhZ05hbWUudG9VcHBlckNhc2UoKSA9PSAiSU5QVVQiKSB7DQogICAgICBpZiAoImVtYWlsIiA9PSBlbC50eXBlICYmICJlbWFpbCIgPT0gZWwubmFtZSkgew0KICAgICAgICBlbC52YWx1ZSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJlbWFpbF9yZW1lbWJlciIpOw0KICAgICAgfQ0KICAgIH0gZWxzZSB7DQogICAgICBpZiAoJ2NoaWxkcmVuJyBpbiBlbCkgew0KICAgICAgICB2YXIgYXJyID0gZWwuY2hpbGRyZW47DQogICAgICAgIHZhciBuID0gYXJyLmxlbmd0aDsNCiAgICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCBuOyBrKyspIHsNCiAgICAgICAgICByZWNhbGxfZW1haWwoZWwuY2hpbGRyZW5ba10pOw0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICB9Ow0KDQogIC8vIFJVTlRJTUUgfCByeDphY3Rpb249YWRhbWE6c2lnbi1pbg0KICBzZWxmLmFTTyA9IGZ1bmN0aW9uKGZvcm0sIHN0YXRlLCBpZGVudGl0eU5hbWUsIGZhaWx1cmVWYXIsIGZvcndhcmRUbykgew0KICAgIHZhciBzaWduYWwgPSBtYWtlX2ZhaWx1cmVfc2lnbmFsKHN0YXRlLCBmYWlsdXJlVmFyKTsNCiAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsNCiAgICAgIHJlY2FsbF9lbWFpbChmb3JtKTsNCiAgICB9LCAxKTsNCiAgICBmb3JtLm9uc3VibWl0ID0gZnVuY3Rpb24oZXZ0KSB7DQogICAgICBldnQucHJldmVudERlZmF1bHQoKTsNCiAgICAgIHZhciByZXEgPSBnZXRfZm9ybShmb3JtKTsNCiAgICAgIGlmIChyZXEucmVtZW1iZXIpIHsNCiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oImVtYWlsX3JlbWVtYmVyIiwgcmVxLmVtYWlsKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJlbWFpbF9yZW1lbWJlciIsICIiKTsNCiAgICAgIH0NCiAgICAgIGNvbm5lY3Rpb24uQWNjb3VudExvZ2luKHJlcS5lbWFpbCwgcmVxLnBhc3N3b3JkLCB7DQogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKHBheWxvYWQpIHsNCiAgICAgICAgICBzaWduYWwoZmFsc2UpOw0KICAgICAgICAgIGlkZW50aXRpZXNbaWRlbnRpdHlOYW1lXSA9IHBheWxvYWQuaWRlbnRpdHk7DQogICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oImlkZW50aXR5XyIgKyBpZGVudGl0eU5hbWUsIHBheWxvYWQuaWRlbnRpdHkpOw0KICAgICAgICAgIHNlbGYuZ290byhzdGF0ZS52aWV3LCBmb3J3YXJkVG8pOw0KICAgICAgICB9LA0KICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbihjb2RlKSB7DQogICAgICAgICAgc2lnbmFsKHRydWUpOw0KICAgICAgICAgIC8vIFRPRE86IHNvcnQgb3V0IGNvbnNvbGUgbG9nZ2luZw0KICAgICAgICAgIGNvbnNvbGUubG9nKCJGQUlMVVJFOiIgKyBjb2RlKTsNCiAgICAgICAgfQ0KICAgICAgfSk7DQogICAgfTsNCiAgfTsNCg0KICAvLyBSVU5USU1FIHwgcng6YWN0aW9uPWFkYW1hOnNpZ24tdXANCiAgc2VsZi5hU1UgPSBmdW5jdGlvbihmb3JtLCBzdGF0ZSwgZmFpbHVyZVZhciwgZm9yd2FyZFRvKSB7DQogICAgdmFyIHNpZ25hbCA9IG1ha2VfZmFpbHVyZV9zaWduYWwoc3RhdGUsIGZhaWx1cmVWYXIpOw0KICAgIGZvcm0ub25zdWJtaXQgPSBmdW5jdGlvbihldnQpIHsNCiAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpOw0KICAgICAgdmFyIHJlcSA9IGdldF9mb3JtKGZvcm0pOw0KICAgICAgY29ubmVjdGlvbi5Jbml0U2V0dXBBY2NvdW50KHJlcS5lbWFpbCwgew0KICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihwYXlsb2FkKSB7DQogICAgICAgICAgc2lnbmFsKGZhbHNlKTsNCiAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgiZW1haWwiLCByZXEuZW1haWwpOw0KICAgICAgICAgIHNlbGYuZ290byhzdGF0ZS52aWV3LCBmb3J3YXJkVG8pOw0KICAgICAgICB9LA0KICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbihjb2RlKSB7DQogICAgICAgICAgc2lnbmFsKHRydWUpOw0KICAgICAgICAgIGNvbnNvbGUubG9nKCJGQUlMVVJFOiIpOw0KICAgICAgICB9DQogICAgICB9KTsNCiAgICB9Ow0KICB9Ow0KDQogIC8vIFJVTlRJTUUgfCByeDphY3Rpb249YWRhbWE6c2V0LXBhc3N3b3JkDQogIHNlbGYuYVNQID0gZnVuY3Rpb24oZm9ybSwgc3RhdGUsIGZhaWx1cmVWYXIsIGZvcndhcmRUbykgew0KICAgIHZhciBzaWduYWwgPSBtYWtlX2ZhaWx1cmVfc2lnbmFsKHN0YXRlLCBmYWlsdXJlVmFyKTsNCiAgICBmb3JtLm9uc3VibWl0ID0gZnVuY3Rpb24oZXZ0KSB7DQogICAgICBldnQucHJldmVudERlZmF1bHQoKTsNCiAgICAgIHZhciByZXEgPSBnZXRfZm9ybShmb3JtKTsNCiAgICAgIGlmICghKCdlbWFpbCcgaW4gcmVxKSkgew0KICAgICAgICByZXEuZW1haWwgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnZW1haWwnKTsNCiAgICAgIH0NCiAgICAgIGNvbm5lY3Rpb24uSW5pdENvbXBsZXRlQWNjb3VudChyZXEuZW1haWwsIGZhbHNlLCByZXEuY29kZSwgew0KICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihpbml0KSB7DQogICAgICAgICAgY29uc29sZS5sb2coaW5pdCk7DQogICAgICAgICAgdmFyIGlkZW50aXR5ID0gaW5pdC5pZGVudGl0eTsNCiAgICAgICAgICBjb25uZWN0aW9uLkFjY291bnRTZXRQYXNzd29yZChpbml0LmlkZW50aXR5LCByZXEucGFzc3dvcmQsIHsNCiAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICBzaWduYWwoZmFsc2UpOw0KICAgICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgiaWRlbnRpdHlfZGVmYXVsdCIsIGlkZW50aXR5KTsNCiAgICAgICAgICAgICAgc2VsZi5nb3RvKHN0YXRlLnZpZXcsIGZvcndhcmRUbyk7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24ocmVhc29uKSB7DQogICAgICAgICAgICAgIHNpZ25hbCh0cnVlKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9KTsNCg0KICAgICAgICB9LA0KICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbihyZWFzb24pIHsNCiAgICAgICAgICBzaWduYWwodHJ1ZSk7DQogICAgICAgIH0NCiAgICAgIH0pOw0KICAgIH07DQogIH07DQogIA0KICAvLyBSVU5USU1FIHwgcng6YWN0aW9uPXNlbmQ6JGNoYW5uZWwNCiAgc2VsZi5hU0QgPSBmdW5jdGlvbihmb3JtLCBzdGF0ZSwgY2hhbm5lbCwgZmFpbHVyZVZhcikgew0KICAgIHZhciBzaWduYWwgPSBtYWtlX2ZhaWx1cmVfc2lnbmFsKHN0YXRlLCBmYWlsdXJlVmFyKTsNCiAgICBmb3JtLm9uc3VibWl0ID0gZnVuY3Rpb24oZXZ0KSB7DQogICAgICBldnQucHJldmVudERlZmF1bHQoKTsNCiAgICAgIHZhciBzdGFydCA9IHBlcmZvcm1hbmNlLm5vdygpOw0KICAgICAgc3RhdGUuZGF0YS5jb25uZWN0aW9uLnB0ci5zZW5kKGNoYW5uZWwsIGdldF9mb3JtKGZvcm0pLCB7DQogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKHBheWxvYWQpIHsNCiAgICAgICAgICBzaWduYWwoZmFsc2UpOw0KICAgICAgICAgIGNvbnNvbGUubG9nKCJTdWNjZXNzfCIgKyBwYXlsb2FkLnNlcSArICI7bGF0ZW5jeT0iICsgKHBlcmZvcm1hbmNlLm5vdygpIC0gc3RhcnQpKTsgLy8gVE9ETzogZ3JhcGggaXQNCiAgICAgICAgfSwNCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24ocmVhc29uKSB7DQogICAgICAgICAgc2lnbmFsKHRydWUpOw0KICAgICAgICAgIGNvbnNvbGUubG9nKCJGQUlMVVJFIFRPIFNFTkQ6ICIgKyByZWFzb24pOyAvLyBUT0RPOiBsb2cgaXQNCiAgICAgICAgfQ0KICAgICAgfSk7DQogICAgfTsNCiAgfTsNCg0KICB3aW5kb3cucnhodG1sID0gc2VsZjsNCiAgcmV0dXJuIHNlbGY7DQp9KSgpOw==");
}
