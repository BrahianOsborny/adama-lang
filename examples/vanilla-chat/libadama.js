function e(e,t,n,r,i,s,o){try{var a=e[s](o),d=a.value}catch(e){return void n(e)}a.done?t(d):Promise.resolve(d).then(r,i)}function t(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function n(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var r=function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AdamaConnection=void 0;var i=r(require("isomorphic-ws")),s=function(){function r(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),n(this,"backoff",void 0),n(this,"maximum_backoff",void 0),n(this,"url",void 0),n(this,"connected",void 0),n(this,"dead",void 0),n(this,"scheduled",void 0),n(this,"socket",void 0),n(this,"callbacks",void 0),n(this,"rpcid",void 0),n(this,"onstatuschange",void 0),n(this,"onping",void 0),n(this,"onauthneeded",void 0),n(this,"nextId",void 0),n(this,"onreconnect",void 0),n(this,"sessionId",void 0),n(this,"sendId",void 0),this.backoff=1,this.url=e,this.connected=!1,this.dead=!1,this.maximum_backoff=2500,this.socket=null,this.onstatuschange=function(e){},this.onping=function(e,t){},this.onauthneeded=function(e){},this.scheduled=!1,this.callbacks=new Map,this.nextId=0,this.onreconnect=new Map,this.rpcid=1,this.sessionId="",this.sendId=0}var s,o,a,d,c;return s=r,o=[{key:"stop",value:function(){this.dead=!0,null!==this.socket&&this.socket.close()}},{key:"_retry",value:function(){if(this.socket=null,this.connected&&(this.connected=!1,this.onstatuschange(!1)),this.callbacks.clear(),!this.dead&&!this.scheduled){var e=!1;this.backoff+=Math.random()*this.backoff,this.backoff>this.maximum_backoff&&(this.backoff=this.maximum_backoff,e=!0),this.scheduled=!0;var t=this;setTimeout((function(){t.start()}),this.backoff),e&&(this.backoff/=2)}}},{key:"start",value:function(){var e=this;this.scheduled=!1,this.dead=!1,this.socket=new i.default(this.url),this.socket.onmessage=function(t){var n=JSON.parse(t.data);if("ping"in n)return e.onping(n.ping,n.latency),n.pong=(new Date).getTime()/1e3,void e.socket.send(JSON.stringify(n));if("status"in n)return"connected"!=n.status?(e.dead=!0,e.socket.close(),e.socket=null,void e.onauthneeded((function(){e.start()}))):(e.backoff=1,e.connected=!0,e.sessionId=n.session_id,e.onstatuschange(!0),void e._reconnect());if("failure"in n)e.callbacks.has(n.failure)&&(r=e.callbacks.get(n.failure))&&(e.callbacks.delete(n.failure),r(n));else if("deliver"in n){var r;e.callbacks.has(n.deliver)&&(r=e.callbacks.get(n.deliver))&&(n.done&&e.callbacks.delete(n.deliver),r(n))}},this.socket.onclose=function(t){e._retry()},this.socket.onerror=function(t){e._retry()}}},{key:"_write",value:function(e,t){if(this.connected){var n=this.rpcid;this.rpcid++,e.id=n,this.callbacks.set(n,t),this.socket.send(JSON.stringify(e))}else t({failure:600,reason:9999})}},{key:"wait_connected",value:(d=regeneratorRuntime.mark((function e(){var t,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.connected){e.next=4;break}return e.abrupt("return",new Promise((function(e){e(!0)})));case 4:return t=this,n=this.onstatuschange,e.abrupt("return",new Promise((function(e){t.onstatuschange=function(r){n(r),r&&(e(!0),t.onstatuschange=n)}})));case 7:case"end":return e.stop()}}),e,this)})),c=function(){var t=this,n=arguments;return new Promise((function(r,i){var s=d.apply(t,n);function o(t){e(s,r,i,o,a,"next",t)}function a(t){e(s,r,i,o,a,"throw",t)}o(void 0)}))},function(){return c.apply(this,arguments)})},{key:"_reconnect",value:function(){this.onreconnect.forEach((function(e,t){e.__retry()}))}},{key:"__execute_rr",value:function(e){var t=this;return e.first=!0,t._write(e.request,(function(n){e.first&&(e.first=!1,"failure"in n?e.responder.failure(n.reason):e.responder.success(n.response)),t.onreconnect.delete(e.id)})),t.onreconnect.set(e.id,e),e.__retry=function(){t.__execute_rr(e)},e}},{key:"__execute_stream",value:function(e){var t=this;return t._write(e.request,(function(n){if("failure"in n)return e.responder.failure(n.reason),void t.onreconnect.delete(e.id);n.response&&e.responder.next(n.response),n.done&&(e.responder.complete(),t.onreconnect.delete(e.id))})),t.onreconnect.set(e.id,e),e.__retry=function(){t.__execute_stream(e)},e}},{key:"InitSetupAccount",value:function(e,t){var n=this;n.nextId++;var r=n.nextId;return n.__execute_rr({id:r,responder:t,request:{method:"init/setup-account",id:r,email:e}})}},{key:"InitCompleteAccount",value:function(e,t,n,r){var i=this;i.nextId++;var s=i.nextId;return i.__execute_rr({id:s,responder:r,request:{method:"init/complete-account",id:s,email:e,revoke:t,code:n}})}},{key:"Probe",value:function(e,t){var n=this;n.nextId++;var r=n.nextId;return n.__execute_rr({id:r,responder:t,request:{method:"probe",id:r,identity:e}})}},{key:"AuthorityCreate",value:function(e,t){var n=this;n.nextId++;var r=n.nextId;return n.__execute_rr({id:r,responder:t,request:{method:"authority/create",id:r,identity:e}})}},{key:"AuthoritySet",value:function(e,t,n,r){var i=this;i.nextId++;var s=i.nextId;return i.__execute_rr({id:s,responder:r,request:{method:"authority/set",id:s,identity:e,authority:t,"key-store":n}})}},{key:"AuthorityGet",value:function(e,t,n){var r=this;r.nextId++;var i=r.nextId;return r.__execute_rr({id:i,responder:n,request:{method:"authority/get",id:i,identity:e,authority:t}})}},{key:"AuthorityList",value:function(e,t){var n=this;n.nextId++;var r=n.nextId;return n.__execute_stream({id:r,responder:t,request:{method:"authority/list",id:r,identity:e}})}},{key:"AuthorityDestroy",value:function(e,t,n){var r=this;r.nextId++;var i=r.nextId;return r.__execute_rr({id:i,responder:n,request:{method:"authority/destroy",id:i,identity:e,authority:t}})}},{key:"SpaceCreate",value:function(e,t,n){var r=this;r.nextId++;var i=r.nextId;return r.__execute_rr({id:i,responder:n,request:{method:"space/create",id:i,identity:e,space:t}})}},{key:"SpaceUsage",value:function(e,t,n,r){var i=this;i.nextId++;var s=i.nextId;return i.__execute_stream({id:s,responder:r,request:{method:"space/usage",id:s,identity:e,space:t,limit:n}})}},{key:"SpaceGet",value:function(e,t,n){var r=this;r.nextId++;var i=r.nextId;return r.__execute_rr({id:i,responder:n,request:{method:"space/get",id:i,identity:e,space:t}})}},{key:"SpaceSet",value:function(e,t,n,r){var i=this;i.nextId++;var s=i.nextId;return i.__execute_rr({id:s,responder:r,request:{method:"space/set",id:s,identity:e,space:t,plan:n}})}},{key:"SpaceDelete",value:function(e,t,n){var r=this;r.nextId++;var i=r.nextId;return r.__execute_rr({id:i,responder:n,request:{method:"space/delete",id:i,identity:e,space:t}})}},{key:"SpaceSetRole",value:function(e,t,n,r,i){var s=this;s.nextId++;var o=s.nextId;return s.__execute_rr({id:o,responder:i,request:{method:"space/set-role",id:o,identity:e,space:t,email:n,role:r}})}},{key:"SpaceReflect",value:function(e,t,n,r){var i=this;i.nextId++;var s=i.nextId;return i.__execute_rr({id:s,responder:r,request:{method:"space/reflect",id:s,identity:e,space:t,key:n}})}},{key:"SpaceList",value:function(e,t,n,r){var i=this;i.nextId++;var s=i.nextId;return i.__execute_stream({id:s,responder:r,request:{method:"space/list",id:s,identity:e,marker:t,limit:n}})}},{key:"DocumentCreate",value:function(e,t,n,r,i,s){var o=this;o.nextId++;var a=o.nextId;return o.__execute_rr({id:a,responder:s,request:{method:"document/create",id:a,identity:e,space:t,key:n,entropy:r,arg:i}})}},{key:"DocumentList",value:function(e,t,n,r,i){var s=this;s.nextId++;var o=s.nextId;return s.__execute_stream({id:o,responder:i,request:{method:"document/list",id:o,identity:e,space:t,marker:n,limit:r}})}},{key:"ConnectionCreate",value:function(e,t,n,r,i){var s=this;s.nextId++;var o=s.nextId;return s.__execute_stream({id:o,responder:i,request:{method:"connection/create",id:o,identity:e,space:t,key:n,"viewer-state":r},send:function(e,t,n){s.nextId++;var r=s.nextId,i=o;s.__execute_rr({id:r,responder:n,request:{method:"connection/send",id:r,connection:i,channel:e,message:t}})},update:function(e,t){s.nextId++;var n=s.nextId,r=o;s.__execute_rr({id:n,responder:t,request:{method:"connection/update",id:n,connection:r,"viewer-state":e}})},end:function(e){s.nextId++;var t=s.nextId,n=o;s.__execute_rr({id:t,responder:e,request:{method:"connection/end",id:t,connection:n}})}})}},{key:"AttachmentStart",value:function(e,t,n,r,i,s){var o=this;o.nextId++;var a=o.nextId;return o.__execute_stream({id:a,responder:s,request:{method:"attachment/start",id:a,identity:e,space:t,key:n,filename:r,"content-type":i},append:function(e,t,n){o.nextId++;var r=o.nextId,i=a;o.__execute_rr({id:r,responder:n,request:{method:"attachment/append",id:r,upload:i,"chunk-md5":e,"base64-bytes":t}})},finish:function(e){o.nextId++;var t=o.nextId,n=a;o.__execute_rr({id:t,responder:e,request:{method:"attachment/finish",id:t,upload:n}})}})}}],o&&t(s.prototype,o),a&&t(s,a),Object.defineProperty(s,"prototype",{writable:!1}),r}();exports.AdamaConnection=s;
